<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gestione Materiali - CRI</title>
<style>
  :root {
    --rosso-cri: #b71c1c;
    --bianco: #ffffff;
    --grigio: #f5f5f5;
    --blu-info: #007bff;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    margin: 0;
    font-family: Arial, sans-serif;
    display: flex;
    min-height: 100vh;
    background: var(--grigio);
  }

  /* ===== SIDEBAR + MENU (come index) ===== */
  .sidebar {
    width: 260px;
    flex-shrink: 0;
    background: var(--rosso-cri);
    color: var(--bianco);
    display: flex;
    flex-direction: column;
    padding-top: 20px;
    height: 100vh;
    overflow: hidden;          /* come index */
    align-items: center;
  }
  .sidebar img {
    width: 220px;
    margin-bottom: 20px;
    border-radius: 8px;
  }
  .menu {
    list-style: none;
    padding: 0;
    width: 100%;
    flex-grow: 1;
    overflow-y: auto;          /* come index */
    overscroll-behavior: contain;
  }
  .menu li { width: 100%; }
  .menu a {
    display: block;
    padding: 15px 20px;
    color: var(--bianco);
    font-weight: bold;
    text-decoration: none;
  }
  .menu a:hover,
  .menu a.active { background: #9f1b1b; }

  #logout {
    flex-shrink: 0;
    margin: 12px auto 20px auto;  /* come index */
    padding: 10px 20px;
    width: 80%;
    background: var(--bianco);
    color: var(--rosso-cri);
    border: 2px solid var(--rosso-cri);
    border-radius: 6px;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.3s, color 0.3s;
  }
  #logout:hover { background-color: var(--rosso-cri); color: var(--bianco); }

  .main {
    flex-grow: 1;
    background: var(--bianco);
    padding: 30px;
    overflow-y: auto;
    position: relative;
  }
  .main h1 { color: var(--rosso-cri); margin-top: 0; }

  #search {
    width: 100%;
    padding: 10px;
    margin-bottom: 20px;
    font-size: 1rem;
    border-radius: 5px;
    border: 1px solid #ccc;
  }
  #btn-apri-form {
    background: var(--rosso-cri);
    color: var(--bianco);
    border: none;
    padding: 12px 20px;
    border-radius: 5px;
    font-weight: bold;
    font-size: 1rem;
    cursor: pointer;
    margin-bottom: 20px;
    transition: background 0.3s;
  }
  #btn-apri-form:hover { background: #9f1b1b; }

  table {
    width: 100%;
    border-collapse: collapse;
    max-width: 1200px;
  }
  table th, table td {
    border: 1px solid #ccc;
    padding: 10px;
    text-align: left;
    vertical-align: middle;
  }
  table th { background: var(--rosso-cri); color: var(--bianco); }

  .badge {
    display: inline-block;
    padding: 4px 10px;
    border-radius: 999px;
    font-size: 0.85rem;
    font-weight: bold;
    border: 1px solid #ddd;
    background: #fafafa;
  }
  .badge.ok { border-color: #28a74533; }
  .badge.warn { border-color: #ffc10755; }
  .badge.bad { border-color: #dc354555; }

  .action-btn {
    cursor: pointer;
    padding: 6px 10px;
    margin: 0 2px;
    border: none;
    border-radius: 4px;
    font-weight: bold;
    font-size: 0.9rem;
  }
  .edit-btn { background-color: #ffc107; color: #000; }
  .delete-btn { background-color: #dc3545; color: #fff; }
  .info-btn { background-color: var(--blu-info); color: #fff; }

  /* Modale form */
  #form-container {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  #form-container.active { display: flex; }

  #form-box {
    background: var(--grigio);
    max-width: 760px;
    width: 95%;
    border-radius: 8px;
    padding: 25px 30px;
    box-shadow: 0 0 10px rgba(0,0,0,0.25);
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
  }
  #btn-chiudi-form {
    position: absolute;
    top: 12px;
    right: 15px;
    font-size: 2rem;
    background: none;
    border: none;
    color: var(--rosso-cri);
    cursor: pointer;
  }
  form .row {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 10px;
  }
  form input, form select, form textarea {
    flex: 1 1 48%;
    padding: 8px;
    border-radius: 4px;
    border: 1px solid #ccc;
    font-size: 1rem;
  }
  form textarea { flex: 1 1 100%; min-height: 60px; }
  form input[readonly] {
    background-color: #e9ecef;
    color: #6c757d;
    cursor: not-allowed;
  }
  form button[type="submit"] {
    background: var(--rosso-cri);
    color: var(--bianco);
    border: none;
    padding: 12px 20px;
    border-radius: 5px;
    font-weight: bold;
    font-size: 1rem;
    cursor: pointer;
    transition: background 0.3s;
    margin-top: 10px;
  }
  form button[type="submit"]:hover { background: #9f1b1b; }

  /* Popup info materiale */
  #info-popup {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 780px;
    max-width: 95%;
    max-height: 90vh;
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 50px rgba(0,0,0,0.4);
    display: none;
    z-index: 1100;
    overflow: hidden;
  }
  #info-popup.active { display: block; }

  #info-popup h3 {
    margin: 0;
    padding: 25px 30px;
    background: var(--rosso-cri);
    color: white;
    font-size: 1.4rem;
    border-radius: 12px 12px 0 0;
  }
  #info-content {
    padding: 25px 30px;
    font-size: 1rem;
    line-height: 2;
    color: #333;
    max-height: calc(90vh - 100px);
    overflow-y: auto;
  }
  #info-content > div {
    display: flex;
    padding: 12px 15px;
    border-radius: 6px;
    margin-bottom: 5px;
  }
  #info-content > div:nth-child(even) { background: #f8f9fa; }
  .info-label {
    color: var(--rosso-cri);
    font-weight: bold;
    min-width: 240px;
    flex-shrink: 0;
  }
  .info-value { color: #333; flex: 1; }

  #info-close {
    position: absolute;
    top: 20px;
    right: 25px;
    background: rgba(255,255,255,0.2);
    border: none;
    font-size: 1.8rem;
    color: white;
    cursor: pointer;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
  }
  #info-close:hover {
    background: rgba(255,255,255,0.3);
    transform: rotate(90deg);
  }

  /* ===== MOBILE (come index) ===== */
  @media (max-width: 768px) {
    body { flex-direction: column; }
    .sidebar { width: 100%; height: auto; padding: 15px; overflow: visible; }
    .menu { overflow: visible; }
    table { font-size: 0.95rem; }
  }


  /* ============================
     ‚úÖ FIX: scroll SOLO nel main
     Sidebar ferma + menu scrollabile
  ============================ */
  html, body{ height:100%; }
  body{ overflow:hidden; }

  .sidebar{
    height:100vh;
    position:sticky !important;
    top:0;
    overflow:hidden;
  }
  .menu{
    flex:1 1 auto;
    overflow-y:auto;
    overscroll-behavior: contain;
  }
  .main{
    flex:1 1 auto;
    height:100vh;
    overflow-y:auto;
    margin-left:0 !important;
    min-height:0;
    width:auto;
  }

  @media (max-width:768px){
    body{ overflow:auto; }
    .sidebar{
      height:auto;
      position:relative !important;
      overflow:visible;
    }
    .menu{ overflow:visible; }
    .main{
      height:auto;
      overflow:visible;
      min-height:auto;
    }
  }

</style>
</head>

<body>
<aside class="sidebar" aria-label="Navigazione principale">
  <img id="logo-cri" src="logo.svg" alt="Logo Croce Rossa Italiana" />
  <ul class="menu" id="menu-sidebar" role="navigation" aria-label="Menu principale"></ul>
  <button id="logout" type="button">Logout</button>
</aside>

<main class="main">
  <h1 id="pageTitle">üì¶ Gestione Materiali</h1>

  <input
    type="search"
    id="search"
    placeholder="üîç Cerca per codice, nome, categoria, comitato, ubicazione o stato"
    aria-label="Cerca materiale"
  />
  <button id="btn-apri-form">‚ûï Aggiungi Materiale</button>

  <table aria-label="Elenco materiali">
    <thead>
      <tr>
        <th scope="col">Codice</th>
        <th scope="col">Materiale</th>
        <th scope="col">Categoria</th>
        <th scope="col">Comitato</th>
        <th scope="col">Q.t√†</th>
        <th scope="col">Stato</th>
        <th scope="col">Azioni</th>
      </tr>
    </thead>
    <tbody id="materiali-list"></tbody>
  </table>
</main>

<!-- Form modale Materiali -->
<div id="form-container" aria-hidden="true">
  <div id="form-box" role="dialog" aria-modal="true" aria-labelledby="form-title">
    <button id="btn-chiudi-form" aria-label="Chiudi Modulo">&times;</button>
    <h2 id="form-title" style="color: var(--rosso-cri); margin-top:0;">Aggiungi Materiale</h2>

    <form id="materiali-form" autocomplete="off" novalidate>
      <div class="row">
        <input type="text" id="codice" name="codice" placeholder="Codice / ID materiale *" required />
        <input type="text" id="nome" name="nome" placeholder="Nome materiale *" required />
      </div>

      <div class="row">
        <input type="text" id="categoria" name="categoria" placeholder="Categoria (es. DPI, Farmaci, Presidi, Radio) *" required />
        <select id="stato" name="stato" required aria-label="Stato materiale">
          <option value="" selected>Stato materiale *</option>
          <option value="Disponibile">Disponibile</option>
          <option value="In uso">In uso</option>
          <option value="Da reintegrare">Da reintegrare</option>
          <option value="Scaduto">Scaduto</option>
          <option value="Fuori servizio">Fuori servizio</option>
        </select>
      </div>

      <div class="row">
        <input type="number" id="quantita" name="quantita" placeholder="Quantit√† *" min="0" step="1" required />
        <input type="text" id="unita" name="unita" placeholder="Unit√† di misura (pz, scatole, litri, ecc.)" />
      </div>

      <div class="row">
        <input type="text" id="comitato" name="comitato" placeholder="Comitato assegnatario *" required />
        <input type="text" id="ubicazione" name="ubicazione" placeholder="Ubicazione (magazzino, armadio, sede, ecc.)" />
      </div>

      <div class="row">
        <input type="date" id="dataCarico" name="dataCarico" placeholder="Data carico" />
        <input type="date" id="dataScadenza" name="dataScadenza" placeholder="Data scadenza" />
      </div>

      <div class="row">
        <input type="text" id="lotto" name="lotto" placeholder="Lotto / seriale (se presente)" />
        <input type="text" id="fornitore" name="fornitore" placeholder="Fornitore / provenienza" />
      </div>

      <div class="row">
        <textarea id="note" name="note" placeholder="Note / annotazioni (es. condizioni, posizione precisa, uso dedicato)"></textarea>
      </div>

      <button type="submit" id="submit-btn">Aggiungi Materiale</button>
    </form>
  </div>
</div>

<!-- Popup info materiale -->
<div
  id="info-popup"
  role="dialog"
  aria-modal="true"
  aria-labelledby="info-title"
  aria-describedby="info-desc"
  tabindex="-1"
>
  <button id="info-close" aria-label="Chiudi dettagli materiale">&times;</button>
  <h3 id="info-title">üì¶ Dettagli Materiale</h3>
  <div id="info-content"></div>
</div>

<script>
const userId = localStorage.getItem("userId");
const role = (localStorage.getItem("role") || "").toLowerCase().trim();
const comitato = localStorage.getItem("comitato");

if (!userId) {
  alert("Devi effettuare il login");
  window.location.href = "login.html";
}

// LOGOUT
function logout() {
  localStorage.clear();
  window.location.href = "login.html";
}
document.getElementById("logout").onclick = logout;

// helper come index
const normalize = (s) => (s || "").toString().toLowerCase().trim();

// LOGO dinamico (come index)
const logoImg = document.getElementById("logo-cri");
let logoSrc = "logo.svg";

if (role === "sol") {
  const c = normalize(comitato);
  const map = {
    "pesaro": "logo-pesaro.svg",
    "urbino": "logo-urbino.svg",
    "fano": "logo-fano.svg",
    "pergola": "logo-pergola.svg",
    "marotta-mondolfo": "logo-marotta-mondolfo.svg",
    "fossombrone": "logo-fossombrone.svg",
    "cagli": "logo-cagli.svg",
    "montelabbate": "logo-montelabbate.svg",
    "fermignano": "logo-fermignano.svg",
    "sant'angelo in vado": "logo-santangeloinvado.svg",
    "santangelo in vado": "logo-santangeloinvado.svg",
    "sant-angelo-in-vado": "logo-santangeloinvado.svg"
  };
  logoSrc = map[c] || "logo-sop.svg";
} else if (role === "sop" || role === "amministratore" || role === "tlc_provinciale") {
  logoSrc = "logo-sop.svg";
}
logoImg.src = logoSrc;
logoImg.onerror = () => { logoImg.src = "logo-sop.svg"; };

// MENU laterale (come index, con TLC + Admin se previsti)
const menu = document.getElementById("menu-sidebar");
menu.innerHTML = "";

const items = [
  { text: "üè† Home", href: "index.html" },
  { text: "‚úÖ Approvazioni", href: "iscrizioni-in-attesa.html" },
  { text: "üë• Volontari", href: "volontari.html" },
  { text: "üöó Mezzi", href: "mezzi.html" },
  { text: "üì¶ Materiali", href: "materiali.html" },
  { text: "üö® Emergenze", href: "emergenze.html" },
  { text: "üìÖ Eventi", href: "eventi.html" },
  { text: "üìÑ Documenti", href: "documenti.html" }
];

if (["sop", "sol", "amministratore", "tlc_provinciale"].includes(role)) {
  items.push({ text: "üì° TLC", href: "tlc.html" });
}
if (["sop", "sol", "amministratore"].includes(role)) {
  items.push({ text: "‚öôÔ∏è Admin", href: "admin.html" });
}

items.forEach(({ text, href }) => {
  const li = document.createElement("li");
  const a = document.createElement("a");
  a.href = href;
  a.textContent = text;
  if (href === "materiali.html") a.classList.add("active");
  li.appendChild(a);
  menu.appendChild(li);
});

// Riferimenti DOM
const formContainer = document.getElementById("form-container");
const form = document.getElementById("materiali-form");
const list = document.getElementById("materiali-list");
const searchInput = document.getElementById("search");
const btnApriForm = document.getElementById("btn-apri-form");
const btnChiudiForm = document.getElementById("btn-chiudi-form");
const submitBtn = document.getElementById("submit-btn");
const infoPopup = document.getElementById("info-popup");
const infoContent = document.getElementById("info-content");
const infoClose = document.getElementById("info-close");

let editIndex = null;
let lastFocusedElement = null;

function getFocusableElements(container) {
  return container.querySelectorAll(
    'a[href], button:not([disabled]), textarea, input:not([disabled]), select, [tabindex]:not([tabindex="-1"])'
  );
}

function trapFocus(container, event) {
  const focusable = getFocusableElements(container);
  if (!focusable.length) return;
  const first = focusable[0];
  const last = focusable[focusable.length - 1];

  if (event.key === "Tab") {
    if (event.shiftKey) {
      if (document.activeElement === first) {
        last.focus();
        event.preventDefault();
      }
    } else {
      if (document.activeElement === last) {
        first.focus();
        event.preventDefault();
      }
    }
  }
}

function openDialog(container, firstFocusElement) {
  lastFocusedElement = document.activeElement;
  container.classList.add("active");
  container.setAttribute("aria-hidden", "false");

  if (firstFocusElement) {
    firstFocusElement.focus();
  } else {
    const focusable = getFocusableElements(container);
    if (focusable.length) focusable[0].focus();
  }

  document.addEventListener("keydown", dialogKeydownHandler);
}

function closeDialog(container) {
  container.classList.remove("active");
  container.setAttribute("aria-hidden", "true");
  document.removeEventListener("keydown", dialogKeydownHandler);

  if (lastFocusedElement && typeof lastFocusedElement.focus === "function") {
    lastFocusedElement.focus();
  }
}

function dialogKeydownHandler(e) {
  if (formContainer.classList.contains("active")) {
    trapFocus(formContainer, e);
    if (e.key === "Escape") toggleForm(false);
  }
  if (infoPopup.classList.contains("active")) {
    trapFocus(infoPopup, e);
    if (e.key === "Escape") hideInfoPopup();
  }
}

function toggleForm(show) {
  if (show) {
    hideInfoPopup();
    openDialog(formContainer, form.codice);
    submitBtn.textContent = editIndex === null ? "Aggiungi Materiale" : "Salva Modifiche";
  } else {
    closeDialog(formContainer);
    form.reset();
    form.comitato.removeAttribute("readonly");
    editIndex = null;
    submitBtn.textContent = "Aggiungi Materiale";
  }
}

btnApriForm.addEventListener("click", () => {
  if (role === "sol") {
    form.comitato.value = comitato || "";
    form.comitato.setAttribute("readonly", true);
  }
  toggleForm(true);
});

btnChiudiForm.addEventListener("click", () => toggleForm(false));

// Materiali visibili: SOP/amministratore tutti, SOL solo proprio comitato
function getVisibleMateriali() {
  const locali = JSON.parse(localStorage.getItem("materiali") || "[]");
  if (role === "sop" || role === "amministratore") return locali;

  if (role === "sol") {
    const c = (comitato || "").toLowerCase();
    if (!c) return locali;
    return locali.filter(m => (m.comitato || "").toLowerCase() === c);
  }
  return locali;
}

function formatDate(itDate) {
  if (!itDate) return "";
  const parts = itDate.split("-");
  if (parts.length === 3) return parts[2] + "/" + parts[1] + "/" + parts[0];
  return itDate;
}

function getStatoBadgeClass(stato) {
  const s = (stato || "").toLowerCase();
  if (s.includes("disponibile") || s.includes("in uso")) return "ok";
  if (s.includes("da reintegrare")) return "warn";
  if (s.includes("scaduto") || s.includes("fuori")) return "bad";
  return "";
}

function showInfoPopup(materiale) {
  const dettagli = `
<div><span class="info-label">Codice / ID:</span><span class="info-value">${escapeHtml(materiale.codice || "")}</span></div>
<div><span class="info-label">Nome materiale:</span><span class="info-value">${escapeHtml(materiale.nome || "")}</span></div>
<div><span class="info-label">Categoria:</span><span class="info-value">${escapeHtml(materiale.categoria || "")}</span></div>
<div><span class="info-label">Stato:</span><span class="info-value">${escapeHtml(materiale.stato || "")}</span></div>
<div><span class="info-label">Quantit√†:</span><span class="info-value">${escapeHtml(String(materiale.quantita ?? ""))}${materiale.unita ? " " + escapeHtml(materiale.unita) : ""}</span></div>
<div><span class="info-label">Comitato assegnatario:</span><span class="info-value">${escapeHtml(materiale.comitato || "")}</span></div>
<div><span class="info-label">Ubicazione:</span><span class="info-value">${escapeHtml(materiale.ubicazione || "")}</span></div>
<div><span class="info-label">Data carico:</span><span class="info-value">${escapeHtml(formatDate(materiale.dataCarico) || "")}</span></div>
<div><span class="info-label">Data scadenza:</span><span class="info-value">${escapeHtml(formatDate(materiale.dataScadenza) || "")}</span></div>
<div><span class="info-label">Lotto / seriale:</span><span class="info-value">${escapeHtml(materiale.lotto || "")}</span></div>
<div><span class="info-label">Fornitore / provenienza:</span><span class="info-value">${escapeHtml(materiale.fornitore || "")}</span></div>
<div><span class="info-label">Note / annotazioni:</span><span class="info-value">${escapeHtml(materiale.note || "Nessuna")}</span></div>
  `;
  infoContent.innerHTML = dettagli;
  openDialog(infoPopup);
}

function hideInfoPopup() {
  closeDialog(infoPopup);
}
infoClose.addEventListener("click", hideInfoPopup);

function escapeHtml(text) {
  if (text === null || text === undefined) return "";
  const str = String(text);
  return str.replace(/[&<>"']/g, match => {
    const escapeMap = {
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      '"': "&quot;",
      "'": "&#39;"
    };
    return escapeMap[match];
  });
}

function renderMateriali() {
  const filter = searchInput.value.trim().toLowerCase();
  list.innerHTML = "";

  const visibili = getVisibleMateriali();
  const tutti = JSON.parse(localStorage.getItem("materiali") || "[]");

  visibili
    .filter(m =>
      (m.codice || "").toLowerCase().includes(filter) ||
      (m.nome || "").toLowerCase().includes(filter) ||
      (m.categoria || "").toLowerCase().includes(filter) ||
      (m.comitato || "").toLowerCase().includes(filter) ||
      (m.ubicazione || "").toLowerCase().includes(filter) ||
      (m.stato || "").toLowerCase().includes(filter) ||
      (m.lotto || "").toLowerCase().includes(filter)
    )
    .forEach(m => {
      const globalIndex = tutti.findIndex(mm =>
        (mm.codice === m.codice) &&
        (mm.comitato === m.comitato) &&
        (mm.lotto || "") === (m.lotto || "")
      );

      const badgeClass = getStatoBadgeClass(m.stato);
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${escapeHtml(m.codice)}</td>
        <td>${escapeHtml(m.nome)}</td>
        <td>${escapeHtml(m.categoria)}</td>
        <td>${escapeHtml(m.comitato)}</td>
        <td>${escapeHtml(String(m.quantita ?? ""))}${m.unita ? " " + escapeHtml(m.unita) : ""}</td>
        <td><span class="badge ${badgeClass}">${escapeHtml(m.stato || "")}</span></td>
        <td>
          <button type="button" class="action-btn edit-btn" aria-label="Modifica materiale ${escapeHtml(m.codice)}" onclick="editMateriale(${globalIndex})">‚úèÔ∏è Modifica</button>
          <button type="button" class="action-btn delete-btn" aria-label="Elimina materiale ${escapeHtml(m.codice)}" onclick="deleteMateriale(${globalIndex})">üóëÔ∏è Elimina</button>
          <button type="button" class="action-btn info-btn" aria-label="Info materiale ${escapeHtml(m.codice)}" onclick="showInfoPopupByIndex(${globalIndex})">‚ÑπÔ∏è Info</button>
        </td>
      `;
      list.appendChild(row);
    });
}

form.addEventListener("submit", e => {
  e.preventDefault();

  if (!form.checkValidity()) {
    form.reportValidity();
    return;
  }

  const nuovoMateriale = {
    codice: form.codice.value.trim().toUpperCase(),
    nome: form.nome.value.trim(),
    categoria: form.categoria.value.trim(),
    stato: form.stato.value.trim(),
    quantita: form.quantita.value !== "" ? parseInt(form.quantita.value, 10) : 0,
    unita: form.unita.value.trim(),
    comitato: form.comitato.value.trim(),
    ubicazione: form.ubicazione.value.trim(),
    dataCarico: form.dataCarico.value,
    dataScadenza: form.dataScadenza.value,
    lotto: form.lotto.value.trim(),
    fornitore: form.fornitore.value.trim(),
    note: form.note.value.trim()
  };

  const locali = JSON.parse(localStorage.getItem("materiali") || "[]");

  const duplicateIndex = locali.findIndex((m, idx) =>
    (m.codice || "").toUpperCase() === nuovoMateriale.codice &&
    (m.comitato || "").toLowerCase() === (nuovoMateriale.comitato || "").toLowerCase() &&
    (m.lotto || "") === (nuovoMateriale.lotto || "") &&
    idx !== editIndex
  );

  if (duplicateIndex !== -1) {
    alert("‚ùå Errore: questo materiale (codice + comitato + lotto) √® gi√† presente!");
    return;
  }

  if (editIndex === null) {
    locali.push(nuovoMateriale);
  } else {
    locali[editIndex] = nuovoMateriale;
    editIndex = null;
    submitBtn.textContent = "Aggiungi Materiale";
  }

  localStorage.setItem("materiali", JSON.stringify(locali));
  toggleForm(false);
  renderMateriali();
});

window.editMateriale = function(index) {
  const locali = JSON.parse(localStorage.getItem("materiali") || "[]");
  const m = locali[index];
  if (!m) return;

  editIndex = index;
  submitBtn.textContent = "Salva Modifiche";

  form.codice.value = m.codice || "";
  form.nome.value = m.nome || "";
  form.categoria.value = m.categoria || "";
  form.stato.value = m.stato || "";
  form.quantita.value = (m.quantita ?? "");
  form.unita.value = m.unita || "";
  form.comitato.value = m.comitato || "";
  form.ubicazione.value = m.ubicazione || "";
  form.dataCarico.value = m.dataCarico || "";
  form.dataScadenza.value = m.dataScadenza || "";
  form.lotto.value = m.lotto || "";
  form.fornitore.value = m.fornitore || "";
  form.note.value = m.note || "";

  if (role === "sol") {
    form.comitato.setAttribute("readonly", true);
  } else {
    form.comitato.removeAttribute("readonly");
  }

  toggleForm(true);
};

window.deleteMateriale = function(index) {
  const locali = JSON.parse(localStorage.getItem("materiali") || "[]");
  const m = locali[index];
  if (!m) return;

  if (confirm(`üóëÔ∏è Sei sicuro di voler eliminare il materiale:\n\nCodice: ${m.codice}\nNome: ${m.nome}\nComitato: ${m.comitato}\n\n‚ö†Ô∏è Questa azione √® irreversibile!`)) {
    locali.splice(index, 1);
    localStorage.setItem("materiali", JSON.stringify(locali));
    renderMateriali();

    if (editIndex === index) {
      toggleForm(false);
      editIndex = null;
      submitBtn.textContent = "Aggiungi Materiale";
    }
  }
};

window.showInfoPopupByIndex = function(index) {
  const locali = JSON.parse(localStorage.getItem("materiali") || "[]");
  const m = locali[index];
  if (!m) return;
  showInfoPopup(m);
};

searchInput.addEventListener("input", renderMateriali);
renderMateriali();
</script>
</body>
</html>
