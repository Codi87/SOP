<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gestione Emergenze - CRI</title>
<style>
  :root{
    --rosso-cri:#b71c1c;
    --bianco:#fff;
    --grigio:#f5f5f5;
    --blu-info:#007bff;
    --verde:#28a745;
    --giallo:#ffc107;
    --grigio2:#6c757d;
  }
  *{box-sizing:border-box}
  body{
    margin:0;
    font-family:Arial,sans-serif;
    display:flex;
    min-height:100vh;
    background:var(--grigio);
  }

  /* Sidebar */
  .sidebar{
    position:fixed;
    left:0; top:0;
    width:260px;
    height:100vh;
    background:var(--rosso-cri);
    color:var(--bianco);
    display:flex;
    flex-direction:column;
    padding-top:20px;
    z-index:1000;
    align-items:center;
    overflow-y:auto;
    overflow-x:hidden;
  }
  .sidebar img{
    width:220px;
    margin-bottom:20px;
    border-radius:8px;
    flex-shrink:0;
  }
  .menu{list-style:none; padding:0; width:100%; flex:1 1 auto;}
  .menu li{width:100%}
  .menu a{
    display:block;
    padding:15px 20px;
    color:var(--bianco);
    font-weight:bold;
    text-decoration:none;
  }
  .menu a:hover,.menu a.active{background:#9f1b1b}

  .sidebar-footer{
    margin-top:auto;
    width:100%;
    position:sticky;
    bottom:0;
    padding:14px 0 18px;
    display:flex;
    justify-content:center;
    background:linear-gradient(
      to top,
      rgba(183,28,28,1) 0%,
      rgba(183,28,28,0.95) 70%,
      rgba(183,28,28,0) 100%
    );
  }
  #logout{
    padding:12px 20px;
    width:80%;
    background:var(--bianco);
    color:var(--rosso-cri);
    border:2px solid var(--rosso-cri);
    border-radius:6px;
    font-weight:bold;
    cursor:pointer;
    transition:background .3s,color .3s;
  }
  #logout:hover{background:var(--rosso-cri); color:var(--bianco)}

  .main{
    margin-left:260px;
    flex-grow:1;
    background:var(--bianco);
    padding:30px;
    overflow-y:auto;
    min-height:100vh;
    width:100%;
  }
  .main h1{color:var(--rosso-cri); margin-top:0}

  .toolbar{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
    margin-bottom:14px;
  }
  #search{
    flex:1 1 380px;
    padding:10px;
    font-size:1rem;
    border-radius:5px;
    border:1px solid #ccc;
  }
  #btn-apri-form{
    background:var(--rosso-cri);
    color:var(--bianco);
    border:none;
    padding:12px 20px;
    border-radius:5px;
    font-weight:bold;
    font-size:1rem;
    cursor:pointer;
    transition:background .3s;
  }
  #btn-apri-form:hover{background:#9f1b1b}

  table{width:100%; border-collapse:collapse; max-width:1300px}
  th,td{
    border:1px solid #ccc;
    padding:10px;
    text-align:left;
    vertical-align:middle;
  }
  th{background:var(--rosso-cri); color:var(--bianco)}

  .badge{
    display:inline-block;
    padding:2px 10px;
    border-radius:999px;
    font-size:.85rem;
    font-weight:bold;
    margin-right:6px;
    vertical-align:middle;
    white-space:nowrap;
  }
  .badge-attiva{background:var(--verde); color:#fff}
  .badge-chiusa{background:var(--grigio2); color:#fff}

  /* S1/S2/S3 */
  .badge-s1{background:#04C52E; color:#000000; border:1px solid #04C52E}
  .badge-s2{background:#FFFF00; color:#000000; border:1px solid #FFFF00}
  .badge-s3{background:#FF0000; color:#000000; border:1px solid #FF0000}

  /* approvazioni */
  .badge-pending{background:#ffc107; color:#000}
  .badge-approved{background:#28a745; color:#fff}
  .badge-rejected{background:#6c757d; color:#fff}
  .badge-global{background:#111; color:#fff}

  .action-btn{
    cursor:pointer;
    padding:6px 10px;
    margin:0 2px;
    border:none;
    border-radius:4px;
    font-weight:bold;
    font-size:.9rem;
    white-space:nowrap;
  }
  .info-btn{background:var(--blu-info); color:#fff}
  .edit-btn{background:#ffc107; color:#000}
  .delete-btn{background:#dc3545; color:#fff}
  .close-btn{background:#343a40; color:#fff}
  .reopen-btn{background:var(--verde); color:#fff}
  .pdf-btn{background:#111; color:#fff}
  .xls-btn{background:#1d6f42; color:#fff}
  .add-btn{background:var(--rosso-cri); color:#fff}
  .ok-btn{background:#28a745; color:#fff}
  .no-btn{background:#6c757d; color:#fff}

  /* Modali */
  .modal-overlay{
    position:fixed; inset:0;
    background:rgba(0,0,0,.5);
    display:none;
    justify-content:center;
    align-items:center;
    z-index:0;
  }
  .modal-overlay.active{display:flex}

  .modal-box{
    background:var(--grigio);
    max-width:980px;
    width:95%;
    border-radius:10px;
    padding:25px 30px;
    box-shadow:0 0 10px rgba(0,0,0,.25);
    max-height:90vh;
    overflow-y:auto;
    position:relative;
  }
  .modal-close{
    position:absolute;
    top:12px; right:15px;
    font-size:2rem;
    background:none;
    border:none;
    color:var(--rosso-cri);
    cursor:pointer;
  }

  form .row{
    display:flex;
    flex-wrap:wrap;
    gap:15px;
    margin-bottom:10px;
  }
  form input, form select, form textarea{
    flex:1 1 48%;
    padding:8px;
    border-radius:4px;
    border:1px solid #ccc;
    font-size:1rem;
  }
  form textarea{flex:1 1 100%; min-height:90px}
  form input[readonly]{
    background:#e9ecef;
    color:#6c757d;
    cursor:not-allowed;
  }
  form button[type="submit"]{
    background:var(--rosso-cri);
    color:var(--bianco);
    border:none;
    padding:12px 20px;
    border-radius:5px;
    font-weight:bold;
    font-size:1rem;
    cursor:pointer;
    transition:background .3s;
    margin-top:10px;
  }
  form button[type="submit"]:hover{background:#9f1b1b}

  /* Popup info */
  #info-popup{
    position:fixed;
    top:50%; left:50%;
    transform:translate(-50%, -50%);
    width:1060px;
    max-width:95%;
    max-height:90vh;
    background:#fff;
    border-radius:12px;
    box-shadow:0 10px 50px rgba(0,0,0,.4);
    display:none;
    z-index:0;
    overflow:hidden;
  }
  #info-popup.active{display:block}
  #info-popup h3{
    margin:0;
    padding:25px 30px;
    background:var(--rosso-cri);
    color:#fff;
    font-size:1.4rem;
    border-radius:12px 12px 0 0;
  }
  #info-content{
    padding:25px 30px;
    font-size:1rem;
    line-height:2;
    color:#333;
    max-height:calc(90vh - 100px);
    overflow-y:auto;
  }
  #info-content > div.kv{
    display:flex;
    padding:12px 15px;
    border-radius:6px;
    margin-bottom:5px;
  }
  #info-content > div.kv:nth-child(even){background:#f8f9fa}
  .info-label{
    color:var(--rosso-cri);
    font-weight:bold;
    min-width:260px;
    flex-shrink:0;
  }
  .info-value{color:#333; flex:1}
  #info-close{
    position:absolute;
    top:20px; right:25px;
    background:rgba(255,255,255,.2);
    border:none;
    font-size:1.8rem;
    color:#fff;
    cursor:pointer;
    width:40px;
    height:40px;
    border-radius:50%;
    display:flex;
    align-items:center;
    justify-content:center;
    transition:all .3s;
  }
  #info-close:hover{background:rgba(255,255,255,.3); transform:rotate(90deg)}

  .section-title{
    margin:16px 0 8px;
    padding-top:10px;
    border-top:1px solid #eee;
    font-weight:bold;
    color:var(--rosso-cri);
    display:flex;
    align-items:center;
    justify-content:space-between;
    gap:10px;
    flex-wrap:wrap;
  }
  .mini-table{
    width:100%;
    border-collapse:collapse;
    margin-top:8px;
  }
  .mini-table th,.mini-table td{
    border:1px solid #ddd;
    padding:8px;
    font-size:.95rem;
    vertical-align:top;
  }
  .mini-table th{background:#f3f3f3; color:#333}

  .muted{color:#666}
  .nowrap{white-space:nowrap}

  /* RISORSE MODAL */
  .resources{
    margin-top:10px;
    border:1px solid #ddd;
    border-radius:10px;
    background:#fff;
    overflow:hidden;
  }
  .resources-header{
    display:flex;
    gap:10px;
    align-items:center;
    justify-content:space-between;
    padding:12px 14px;
    background:#fafafa;
    border-bottom:1px solid #eee;
    flex-wrap:wrap;
  }
  .segmented{
    display:flex;
    border:1px solid #ddd;
    border-radius:999px;
    overflow:hidden;
  }
  .segmented button{
    border:none;
    padding:8px 12px;
    cursor:pointer;
    background:#fff;
    font-weight:bold;
  }
  .segmented button.active{
    background:var(--rosso-cri);
    color:#fff;
  }
  .resources-body{padding:14px}
  .resources-tools{
    display:flex;
    gap:10px;
    flex-wrap:wrap;
    align-items:center;
    margin-bottom:12px;
  }
  .resources-tools input[type="search"]{
    flex:1 1 320px;
    padding:10px;
    border-radius:6px;
    border:1px solid #ccc;
  }
  .mini-btn{
    border:1px solid #ddd;
    background:#fff;
    padding:8px 10px;
    border-radius:8px;
    cursor:pointer;
    font-weight:bold;
  }
  .mini-btn:hover{background:#f6f6f6}

  .chips{
    display:flex;
    gap:8px;
    flex-wrap:wrap;
    margin-bottom:10px;
  }
  .chip{
    display:inline-flex;
    align-items:center;
    gap:8px;
    padding:6px 10px;
    border-radius:999px;
    border:1px solid #ddd;
    background:#fff;
    font-size:.9rem;
  }
  .chip b{color:var(--rosso-cri)}
  .chip button{
    border:none;
    background:#eee;
    border-radius:999px;
    width:22px;
    height:22px;
    cursor:pointer;
    font-weight:bold;
  }
  .chip button:hover{background:#e0e0e0}

  .cards{
    display:grid;
    grid-template-columns:repeat(auto-fit, minmax(280px, 1fr));
    gap:10px;
  }
  .card{
    border:1px solid #e6e6e6;
    border-radius:10px;
    padding:12px 12px;
    background:#fff;
  }
  .card-top{
    display:flex;
    justify-content:space-between;
    gap:10px;
    align-items:flex-start;
  }
  .card h4{
    margin:0;
    color:#222;
    font-size:1.02rem;
  }
  .meta{
    color:#666;
    font-size:.9rem;
    line-height:1.35;
    margin-top:6px;
  }
  .right{
    display:flex;
    gap:8px;
    align-items:center;
  }

  .qty-wrap{display:flex; align-items:center; gap:6px;}
  .qty-btn{
    width:30px; height:30px;
    border:none;
    border-radius:8px;
    cursor:pointer;
    background:#f0f0f0;
    font-weight:bold;
  }
  .qty-btn:hover{background:#e7e7e7}
  .qty-input{
    width:74px;
    padding:8px;
    border:1px solid #ccc;
    border-radius:8px;
    text-align:center;
    font-weight:bold;
  }

  @media (max-width:768px){
    body{flex-direction:column}
    .sidebar{position:relative; width:100%; height:auto; overflow:visible}
    .sidebar-footer{position:relative; background:transparent}
    .main{margin-left:0; padding:20px}
    .info-label{min-width:150px}
  }
</style>
</head>

<body>
<aside class="sidebar" aria-label="Navigazione principale">
  <img id="logo-cri" src="logo.svg" alt="Logo Croce Rossa Italiana" />
  <ul class="menu" id="menu-sidebar" role="navigation" aria-label="Menu principale"></ul>
  <div class="sidebar-footer">
    <button id="logout" type="button">üö™ Logout</button>
  </div>
</aside>

<main class="main">
  <h1 id="pageTitle">üö® Gestione Emergenze</h1>

  <div class="toolbar">
    <input type="search" id="search" placeholder="üîç Cerca per titolo, comitato, luogo o stato" aria-label="Cerca emergenza" />
    <button id="btn-apri-form">‚ûï Nuova Emergenza</button>
  </div>

  <table aria-label="Elenco emergenze">
    <thead>
      <tr>
        <th scope="col">Titolo</th>
        <th scope="col">Inizio</th>
        <th scope="col">Comitato Creatore</th>
        <th scope="col">Destinatari</th>
        <th scope="col">Severit√†</th>
        <th scope="col">Stato</th>
        <th scope="col">Contributi</th>
        <th scope="col">Azioni</th>
      </tr>
    </thead>
    <tbody id="emergenze-list"></tbody>
  </table>
</main>

<!-- MODALE CREA/MODIFICA EMERGENZA -->
<div id="form-container" class="modal-overlay" aria-hidden="true">
  <div id="form-box" class="modal-box" role="dialog" aria-modal="true" aria-labelledby="form-title">
    <button id="btn-chiudi-form" class="modal-close" aria-label="Chiudi Modulo">&times;</button>
    <h2 id="form-title" style="color: var(--rosso-cri); margin-top:0;">Crea/Modifica Emergenza</h2>

    <form id="emergenze-form" autocomplete="off" novalidate>
      <div class="row">
        <input type="text" id="titolo" name="titolo" placeholder="Titolo emergenza *" required />
        <input type="text" id="tipo" name="tipo" placeholder="Tipo (es. incendio, alluvione, incidente...) *" required />
      </div>

      <div class="row">
        <input type="text" id="luogo" name="luogo" placeholder="Luogo (indirizzo o area) *" required />
        <select id="livello" name="livello" required aria-label="Severit√† emergenza">
          <option value="" selected>Severit√† (S1/S2/S3) *</option>
          <option value="S1">S1 - bassa</option>
          <option value="S2">S2 - media</option>
          <option value="S3">S3 - alta</option>
        </select>
      </div>

      <div class="row">
        <input type="date" id="dataInizio" name="dataInizio" required />
        <input type="time" id="oraInizio" name="oraInizio" required />
      </div>

      <div class="row">
        <input type="text" id="referente" name="referente" placeholder="Referente / Caposquadra (opzionale)" />
        <input type="text" id="comitatoCreatore" name="comitatoCreatore" placeholder="Comitato creatore *" required readonly />
      </div>

      <div class="row">
        <textarea id="descrizione" name="descrizione" placeholder="Descrizione emergenza, attivit√†, note operative *" required></textarea>
      </div>

      <fieldset style="margin: 10px 0; border: 1px solid #ccc; padding: 10px; background:#fff; border-radius:10px;">
        <legend><b>Estensione emergenza</b></legend>
        <p style="font-size:0.9rem; margin-top:0; color:#444;">
          Puoi inviare l'emergenza ad altre SOL o alla SOP. Ogni destinatario dovr√† <b>approvare</b> prima di poter aggiungere i propri mezzi/materiali/log.
          Se la <b>SOP approva</b>, l'emergenza diventa visibile a tutte le SOL (sempre e solo a ruoli abilitati).
        </p>
        <div class="row">
          <input type="text" id="destSol" name="destSol" placeholder="Altre SOL destinatarie (separate da virgola)" />
          <input type="checkbox" id="destSop" name="destSop" />
          <label for="destSop" style="flex:1 1 48%; display:flex; align-items:center;">&nbsp; Invia emergenza alla SOP</label>
        </div>
      </fieldset>

      <div class="row">
        <select id="stato" name="stato" aria-label="Stato emergenza">
          <option value="attiva">Attiva</option>
          <option value="chiusa">Chiusa</option>
        </select>
        <div class="muted" style="flex:1 1 48%; display:flex; align-items:center;">
          Nota: qui definisci i dati dell‚Äôemergenza. I contributi (mezzi/materiali/volontari/log) sono <b>per comitato</b>.
        </div>
      </div>

      <button type="submit" id="submit-btn">Salva Emergenza</button>
    </form>
  </div>
</div>

<!-- POPUP INFO -->
<div id="info-popup" role="dialog" aria-modal="true" aria-labelledby="info-title" tabindex="-1" aria-hidden="true">
  <button id="info-close" aria-label="Chiudi dettagli emergenza">&times;</button>
  <h3 id="info-title">üö® Dettagli Emergenza</h3>
  <div id="info-content"></div>
</div>

<!-- MODALE GESTIONE RISORSE DEL COMITATO -->
<div id="res-container" class="modal-overlay" aria-hidden="true">
  <div id="res-box" class="modal-box" role="dialog" aria-modal="true" aria-labelledby="res-title">
    <button id="res-close" class="modal-close" aria-label="Chiudi Risorse">&times;</button>
    <h2 id="res-title" style="color: var(--rosso-cri); margin-top:0;">üß∞ Risorse del comitato</h2>

    <div class="row" id="res-committee-row" style="margin-bottom:10px; display:none;">
      <select id="resCommitteeSelect" aria-label="Seleziona comitato (solo SOP/Admin/TLC)"></select>
      <div class="muted" style="flex:1 1 48%; display:flex; align-items:center;">
        Seleziona il comitato per cui stai inserendo il contributo.
      </div>
    </div>

    <div class="resources">
      <div class="resources-header">
        <div><b style="color:var(--rosso-cri)">Seleziona risorse</b></div>
        <div class="segmented" role="tablist">
          <button type="button" id="tab-mezzi" class="active" role="tab" aria-selected="true">üöó Mezzi</button>
          <button type="button" id="tab-materiali" role="tab" aria-selected="false">üì¶ Materiali</button>
          <button type="button" id="tab-volontari" role="tab" aria-selected="false">üë• Volontari</button>
        </div>
      </div>

      <div class="resources-body">
        <div class="resources-tools">
          <input type="search" id="res-search" placeholder="üîç Filtra risorse..." aria-label="Cerca risorse" />
          <button type="button" class="mini-btn" id="btn-clear-res">üßπ Pulisci</button>
          <button type="button" class="mini-btn" id="btn-select-all-mezzi">‚úÖ Tutti i mezzi</button>
          <button type="button" class="mini-btn" id="btn-select-all-vol">‚úÖ Tutti i volontari</button>
        </div>

        <div class="chips" id="selected-chips"></div>

        <div id="panel-mezzi" role="tabpanel">
          <div class="cards" id="mezzi-cards"></div>
        </div>

        <div id="panel-materiali" role="tabpanel" style="display:none;">
          <div class="cards" id="materiali-cards"></div>
        </div>

        <div id="panel-volontari" role="tabpanel" style="display:none;">
          <div class="cards" id="volontari-cards"></div>
        </div>
      </div>
    </div>

    <div style="margin-top:14px; display:flex; gap:10px; flex-wrap:wrap;">
      <button type="button" class="action-btn ok-btn" id="btn-save-res">üíæ Salva contributo</button>
      <button type="button" class="action-btn no-btn" id="btn-cancel-res">Annulla</button>
    </div>
  </div>
</div>

<!-- MODALE LOG INTERVENTI DEL COMITATO -->
<div id="log-container" class="modal-overlay" aria-hidden="true">
  <div id="log-box" class="modal-box" role="dialog" aria-modal="true" aria-labelledby="log-title">
    <button id="log-close" class="modal-close" aria-label="Chiudi Log">&times;</button>
    <h2 id="log-title" style="color: var(--rosso-cri); margin-top:0;">üìù Intervento / Turno (per comitato)</h2>

    <form id="log-form" autocomplete="off" novalidate>
      <div class="row">
        <input type="datetime-local" id="logStart" name="logStart" required />
        <input type="datetime-local" id="logEnd" name="logEnd" required />
      </div>

      <div class="row">
        <input type="text" id="logAttivita" name="logAttivita" placeholder="Attivit√† (es. trasporto, supporto...) *" required />
        <input type="text" id="logResponsabile" name="logResponsabile" placeholder="Responsabile turno (opzionale)" />
      </div>

      <div class="row">
        <textarea id="logNote" name="logNote" placeholder="Note / dettagli operativi (opzionale)"></textarea>
      </div>

      <div class="section-title">üë• Volontari del tuo comitato</div>
      <div class="row">
        <select id="logVolontari" multiple style="flex:1 1 100%; min-height:150px;"></select>
      </div>

      <div class="section-title">üöó Mezzi del tuo contributo</div>
      <div class="row">
        <select id="logMezzi" multiple style="flex:1 1 100%; min-height:120px;"></select>
      </div>

      <div class="section-title">üì¶ Materiali (quantit√† usata nel turno)</div>
      <div class="row">
        <div id="logMaterialiWrap" style="flex:1 1 100%; background:#fff; border:1px solid #ddd; border-radius:10px; padding:12px;"></div>
      </div>

      <button type="submit" id="log-submit" style="margin-top:12px;">Salva Intervento</button>
    </form>
  </div>
</div>

<script>
/* ===========================
   SESSIONE / PERMESSI
=========================== */
const userId = localStorage.getItem("userId") || "";
const role = (localStorage.getItem("role") || "").toLowerCase();
const comitato = localStorage.getItem("comitato") || "";

if (!userId) {
  alert("Devi effettuare il login");
  window.location.href = "login.html";
}
if (role === "volontario") {
  alert("Accesso non consentito: la sezione Emergenze √® riservata a SOL/SOP/Amministratore/TLC Provinciale.");
  window.location.href = "index.html";
}

function normalize(s){ return (s || "").toLowerCase().trim(); }
function escapeHtml(text) {
  if (text === null || text === undefined) return "";
  return String(text).replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));
}
function formatDate(dateStr){
  if (!dateStr) return "";
  const p = dateStr.split("-");
  if (p.length === 3) return `${p[2]}/${p[1]}/${p[0]}`;
  return dateStr;
}
function toLocaleDT(iso){
  if (!iso) return "";
  try{ return new Date(iso).toLocaleString(); }catch{ return iso; }
}

/* ‚úÖ helper per PDF/Excel: comitati da approvazioni */
function titleCaseComitato(name){
  const s = (name || "").toString().trim();
  if (!s) return "";
  if (s.toUpperCase() === "SOP") return "SOP";
  if (s.toUpperCase() === "ALL") return "ALL";
  return s
    .split(/[\s-]+/g)
    .filter(Boolean)
    .map(w => w.charAt(0).toUpperCase() + w.slice(1).toLowerCase())
    .join(" ");
}
function approvalsToCommitteeList(approvazioni){
  const a = approvazioni && typeof approvazioni === "object" ? approvazioni : {};
  const keys = Object.keys(a).filter(k => k !== "ALL"); // ALL √® flag interno
  const normalized = keys.map(k => (k === "SOP" ? "SOP" : normalize(k)));
  const unique = Array.from(new Set(normalized)).filter(Boolean);
  unique.sort((x,y) => x.localeCompare(y, "it"));
  return unique.length ? unique.map(titleCaseComitato).join(", ") : "‚Äî";
}

/* LOGOUT */
function logout() {
  localStorage.clear();
  window.location.href = "login.html";
}
document.getElementById("logout").addEventListener("click", logout);

/* ===========================
   LOGO + MENU
=========================== */
const logoImg = document.getElementById("logo-cri");
let logoSrc = "logo.svg";

if (role === "sol") {
  const c = normalize(comitato);
  const map = {
    "pesaro": "logo-pesaro.svg",
    "urbino": "logo-urbino.svg",
    "fano": "logo-fano.svg",
    "pergola": "logo-pergola.svg",
    "marotta-mondolfo": "logo-marotta-mondolfo.svg",
    "fossombrone": "logo-fossombrone.svg",
    "cagli": "logo-cagli.svg",
    "montelabbate": "logo-montelabbate.svg",
    "fermignano": "logo-fermignano.svg",
    "sant'angelo in vado": "logo-santangeloinvado.svg",
    "santangelo in vado": "logo-santangeloinvado.svg",
    "sant-angelo-in-vado": "logo-santangeloinvado.svg"
  };
  logoSrc = map[c] || "logo-sop.svg";
} else if (["sop","amministratore","tlc_provinciale"].includes(role)) {
  logoSrc = "logo-sop.svg";
}
logoImg.src = logoSrc;
logoImg.onerror = () => { logoImg.src = "logo-sop.svg"; };

const menu = document.getElementById("menu-sidebar");
menu.innerHTML = "";
const items = [
  { text: "üè† Home", href: "index.html" },
  { text: "‚úÖ Approvazioni", href: "iscrizioni-in-attesa.html" },
  { text: "üë• Volontari", href: "volontari.html" },
  { text: "üöó Mezzi", href: "mezzi.html" },
  { text: "üì¶ Materiali", href: "materiali.html" },
  { text: "üö® Emergenze", href: "emergenze.html" },
  { text: "üìÖ Eventi", href: "eventi.html" },
  { text: "üìÑ Documenti", href: "documenti.html" }
];
if (["sop","sol","amministratore","tlc_provinciale"].includes(role)) items.push({ text: "üì° TLC", href: "tlc.html" });
if (["sop","sol","amministratore"].includes(role)) items.push({ text: "‚öôÔ∏è Admin", href: "admin.html" });

items.forEach(({ text, href }) => {
  const li = document.createElement("li");
  const a = document.createElement("a");
  a.href = href;
  a.textContent = text;
  if (href === "emergenze.html") a.classList.add("active");
  li.appendChild(a);
  menu.appendChild(li);
});

/* ===========================
   DOM
=========================== */
const formContainer = document.getElementById("form-container");
const form = document.getElementById("emergenze-form");
const list = document.getElementById("emergenze-list");
const searchInput = document.getElementById("search");
const btnApriForm = document.getElementById("btn-apri-form");
const btnChiudiForm = document.getElementById("btn-chiudi-form");
const submitBtn = document.getElementById("submit-btn");

const infoPopup = document.getElementById("info-popup");
const infoContent = document.getElementById("info-content");
const infoClose = document.getElementById("info-close");

/* Risorse modal */
const resContainer = document.getElementById("res-container");
const resClose = document.getElementById("res-close");
const resSearch = document.getElementById("res-search");
const btnClearRes = document.getElementById("btn-clear-res");
const btnSelectAllMezzi = document.getElementById("btn-select-all-mezzi");
const btnSelectAllVol = document.getElementById("btn-select-all-vol");
const chips = document.getElementById("selected-chips");
const mezziCards = document.getElementById("mezzi-cards");
const materialiCards = document.getElementById("materiali-cards");
const volontariCards = document.getElementById("volontari-cards");
const tabMezzi = document.getElementById("tab-mezzi");
const tabMateriali = document.getElementById("tab-materiali");
const tabVolontari = document.getElementById("tab-volontari");
const panelMezzi = document.getElementById("panel-mezzi");
const panelMateriali = document.getElementById("panel-materiali");
const panelVolontari = document.getElementById("panel-volontari");
const btnSaveRes = document.getElementById("btn-save-res");
const btnCancelRes = document.getElementById("btn-cancel-res");
const resCommitteeRow = document.getElementById("res-committee-row");
const resCommitteeSelect = document.getElementById("resCommitteeSelect");

/* Log modal */
const logContainer = document.getElementById("log-container");
const logForm = document.getElementById("log-form");
const logClose = document.getElementById("log-close");
const logStart = document.getElementById("logStart");
const logEnd = document.getElementById("logEnd");
const logAttivita = document.getElementById("logAttivita");
const logResponsabile = document.getElementById("logResponsabile");
const logNote = document.getElementById("logNote");
const logVolontari = document.getElementById("logVolontari");
const logMezzi = document.getElementById("logMezzi");
const logMaterialiWrap = document.getElementById("logMaterialiWrap");
const logSubmit = document.getElementById("log-submit");

let editIndex = null;

let currentInfoId = null;
let currentContribCom = null;
let currentLogEditId = null;
let resTargetComitatoLower = null;

/* ===========================
   ACCESSIBILIT√Ä MODALI + STACK
=========================== */
const dialogStack = [];

function getFocusableElements(container) {
  return container.querySelectorAll(
    'a[href], button:not([disabled]), textarea, input:not([disabled]), select, [tabindex]:not([tabindex="-1"])'
  );
}
function trapFocus(container, event) {
  const focusable = getFocusableElements(container);
  if (!focusable.length) return;
  const first = focusable[0];
  const last = focusable[focusable.length - 1];
  if (event.key === "Tab") {
    if (event.shiftKey) {
      if (document.activeElement === first) { last.focus(); event.preventDefault(); }
    } else {
      if (document.activeElement === last) { first.focus(); event.preventDefault(); }
    }
  }
}
function topDialog(){
  return dialogStack.length ? dialogStack[dialogStack.length - 1].container : null;
}
function openDialog(container, firstFocusElement) {
  const existingIdx = dialogStack.findIndex(x => x.container === container);
  const lastFocused = document.activeElement;

  if (existingIdx !== -1) {
    const entry = dialogStack.splice(existingIdx, 1)[0];
    entry.lastFocused = lastFocused;
    dialogStack.push(entry);
  } else {
    dialogStack.push({ container, lastFocused });
  }

  container.classList.add("active");
  container.setAttribute("aria-hidden", "false");

  const base = 2000;
  container.style.zIndex = String(base + dialogStack.length * 10);

  if (firstFocusElement) firstFocusElement.focus();
  else {
    const focusable = getFocusableElements(container);
    if (focusable.length) focusable[0].focus();
  }

  if (dialogStack.length === 1) {
    document.addEventListener("keydown", dialogKeydownHandler);
  }
}
function closeDialog(container) {
  const idx = dialogStack.findIndex(x => x.container === container);
  let lastFocused = null;

  if (idx !== -1) {
    lastFocused = dialogStack[idx].lastFocused || null;
    dialogStack.splice(idx, 1);
  }

  container.classList.remove("active");
  container.setAttribute("aria-hidden", "true");
  container.style.zIndex = "";

  if (dialogStack.length === 0) {
    document.removeEventListener("keydown", dialogKeydownHandler);
    if (lastFocused && typeof lastFocused.focus === "function") lastFocused.focus();
    return;
  }

  const t = topDialog();
  if (t) {
    const focusable = getFocusableElements(t);
    if (focusable.length) focusable[0].focus();
  } else if (lastFocused && typeof lastFocused.focus === "function") {
    lastFocused.focus();
  }
}
function dialogKeydownHandler(e) {
  const t = topDialog();
  if (!t) return;

  trapFocus(t, e);

  if (e.key === "Escape") {
    if (t === formContainer) toggleForm(false);
    else if (t === infoPopup) hideInfoPopup();
    else if (t === resContainer) closeResModal();
    else if (t === logContainer) closeLogModal();
  }
}

[formContainer, resContainer, logContainer].forEach(overlay => {
  overlay.addEventListener("click", (e) => {
    if (e.target === overlay) {
      if (overlay === formContainer) toggleForm(false);
      if (overlay === resContainer) closeResModal();
      if (overlay === logContainer) closeLogModal();
    }
  });
});

/* ===========================
   STORAGE
=========================== */
function getEmergenze(){ return JSON.parse(localStorage.getItem("emergenze") || "[]"); }
function setEmergenze(arr){ localStorage.setItem("emergenze", JSON.stringify(arr)); }
function getMezzi(){ return JSON.parse(localStorage.getItem("mezzi") || "[]"); }
function getMateriali(){ return JSON.parse(localStorage.getItem("materiali") || "[]"); }
function getVolontari(){ return JSON.parse(localStorage.getItem("volontari") || "[]"); }

function ensureEmergenzaShape(em){
  if (!em || typeof em !== "object") return;
  if (!Array.isArray(em.destSol)) em.destSol = [];
  if (typeof em.destSop !== "boolean") em.destSop = !!em.destSop;

  if (!em.approvazioni || typeof em.approvazioni !== "object") em.approvazioni = {};
  if (!em.contributi || typeof em.contributi !== "object") em.contributi = {};

  Object.keys(em.contributi).forEach(k => {
    const c = em.contributi[k] || {};
    if (!Array.isArray(c.mezziUsati)) c.mezziUsati = [];
    if (!Array.isArray(c.materialiUsati)) c.materialiUsati = [];
    if (!Array.isArray(c.volontariUsati)) c.volontariUsati = [];   // ‚úÖ aggiunto
    if (!Array.isArray(c.logInterventi)) c.logInterventi = [];

    c.volontariUsati = c.volontariUsati
      .filter(v => v && typeof v === "object")
      .map(v => ({
        cf: (v.cf || "").toUpperCase(),
        nome: v.nome || "",
        cognome: v.cognome || "",
        comitato: v.comitato || ""
      }))
      .filter(v => v.cf);

    c.logInterventi = c.logInterventi
      .filter(x => x && typeof x === "object")
      .map(x => ({
        id: x.id ?? Date.now(),
        startISO: x.startISO || "",
        endISO: x.endISO || "",
        attivita: x.attivita || "",
        responsabile: x.responsabile || "",
        note: x.note || "",
        volontari: Array.isArray(x.volontari) ? x.volontari.map(v => (v||"").toUpperCase()).filter(Boolean) : [],
        mezzi: Array.isArray(x.mezzi) ? x.mezzi : [],
        materiali: Array.isArray(x.materiali) ? x.materiali : []
      }));
    em.contributi[k] = c;
  });
}

function normalizeAllEmergenze(){
  const arr = getEmergenze();
  let changed = false;
  arr.forEach(em => {
    const before = JSON.stringify(em);
    ensureEmergenzaShape(em);
    if (JSON.stringify(em) !== before) changed = true;
  });
  if (changed) setEmergenze(arr);
}

/* ===========================
   BADGE / STATUS
=========================== */
function severitaBadge(s){
  if (s === "S1") return '<span class="badge badge-s1">S1</span>';
  if (s === "S2") return '<span class="badge badge-s2">S2</span>';
  if (s === "S3") return '<span class="badge badge-s3">S3</span>';
  return '<span class="badge badge-s1">‚Äî</span>';
}
function statoBadge(s){
  if (s === "chiusa") return '<span class="badge badge-chiusa">Chiusa</span>';
  return '<span class="badge badge-attiva">Attiva</span>';
}
function approvalBadge(st){
  if (st === "approved") return '<span class="badge badge-approved">Approvato</span>';
  if (st === "rejected") return '<span class="badge badge-rejected">Rifiutato</span>';
  return '<span class="badge badge-pending">In attesa</span>';
}

/* ===========================
   VISIBILIT√Ä / PERMESSI
=========================== */
function getVisibleEmergenze(){
  const all = getEmergenze();
  const c = normalize(comitato);

  if (["sop","amministratore","tlc_provinciale"].includes(role)) return all;

  if (role === "sol") {
    return all.filter(em => {
      ensureEmergenzaShape(em);
      const creator = normalize(em.comitatoCreatore);
      const dest = (em.destSol || []).map(x => normalize(x));
      const globalApproved = em.approvazioni?.ALL === "approved";
      return creator === c || dest.includes(c) || globalApproved;
    });
  }
  return [];
}

function canManageEmergenzaMetadata(em){
  const c = normalize(comitato);
  const creator = normalize(em.comitatoCreatore);
  return (["sop","amministratore"].includes(role) || (role === "sol" && c && c === creator));
}

function canSeeEmergenza(em){
  if (["sop","amministratore","tlc_provinciale"].includes(role)) return true;
  if (role === "sol") {
    const c = normalize(comitato);
    const creator = normalize(em.comitatoCreatore);
    const dest = (em.destSol || []).map(x => normalize(x));
    const globalApproved = em.approvazioni?.ALL === "approved";
    return creator === c || dest.includes(c) || globalApproved;
  }
  return false;
}

function canApproveForCurrentRole(em){
  const c = normalize(comitato);
  const creator = normalize(em.comitatoCreatore);
  const dest = (em.destSol || []).map(x => normalize(x));

  if (role === "sol") {
    if (!c) return false;
    if (c === creator) return false;
    return dest.includes(c) || em.approvazioni?.ALL === "approved";
  }
  if (["sop","amministratore"].includes(role)) return !!em.destSop;
  return false;
}

function approvalKeyForRole(){
  if (role === "sol") return normalize(comitato);
  if (["sop","amministratore"].includes(role)) return "SOP";
  return null;
}

function isApprovedForCurrentCommittee(em){
  if (em.approvazioni?.ALL === "approved") return true;

  if (role === "sol") {
    const k = normalize(comitato);
    if (!k) return false;
    return em.approvazioni?.[k] === "approved";
  }
  if (["sop","amministratore","tlc_provinciale"].includes(role)) return true;
  return false;
}

function canContribute(em){
  if (!canSeeEmergenza(em)) return false;
  if (["sop","amministratore","tlc_provinciale"].includes(role)) return true;
  if (role === "sol") {
    if (normalize(em.comitatoCreatore) === normalize(comitato)) return true;
    return isApprovedForCurrentCommittee(em);
  }
  return false;
}

/* ===========================
   APPROVAZIONI
=========================== */
function setApproval(emId, key, decision){
  const emergenze = getEmergenze();
  const idx = emergenze.findIndex(e => e.id === emId);
  if (idx === -1) return;

  const em = emergenze[idx];
  ensureEmergenzaShape(em);

  if (!em.approvazioni) em.approvazioni = {};
  em.approvazioni[key] = decision;

  if (key === "SOP" && decision === "approved") {
    em.approvazioni.ALL = "approved";
  }
  if (key === "SOP" && decision !== "approved") {
    if (em.approvazioni.ALL) delete em.approvazioni.ALL;
  }

  em.updatedAt = new Date().toISOString();
  emergenze[idx] = em;
  setEmergenze(emergenze);

  showInfoPopup(em);
  renderEmergenze();
}

/* ===========================
   CHIAVI RISORSE
=========================== */
function mezzoKey(m){ return `${(m.targa||"").toUpperCase()}|${(m.selettivaRadio||"").toUpperCase()}`; }
function materialeKey(m){ return `${(m.codice||"").toUpperCase()}|${normalize(m.comitato||"")}|${(m.lotto||"")}`; }
function volontarioKey(v){ return ((v.cf || "").toUpperCase()).trim(); }

/* ===========================
   RISORSE MODAL STATE
=========================== */
let selectedMezzi = new Set();
let selectedMateriali = new Map();
let selectedVolontari = new Set(); // ‚úÖ aggiunto

function getAllCommittees(){
  const set = new Set();
  getMezzi().forEach(m => { const c = normalize(m.comitato); if (c) set.add(c); });
  getMateriali().forEach(m => { const c = normalize(m.comitato); if (c) set.add(c); });
  getVolontari().forEach(v => { const c = normalize(v.comitato); if (c) set.add(c); });
  const em = getEmergenze().find(e => e.id === currentInfoId);
  if (em) { const c = normalize(em.comitatoCreatore); if (c) set.add(c); }
  return Array.from(set).sort((a,b) => a.localeCompare(b));
}

function getMezziDisponibiliPerComitato(cLower){
  const all = getMezzi();
  if (["sop","amministratore","tlc_provinciale"].includes(role)) {
    return cLower ? all.filter(m => normalize(m.comitato) === cLower) : all;
  }
  const me = normalize(comitato);
  return all.filter(m => normalize(m.comitato) === me);
}

function getMaterialiDisponibiliPerComitato(cLower){
  const all = getMateriali();
  if (["sop","amministratore","tlc_provinciale"].includes(role)) {
    return cLower ? all.filter(m => normalize(m.comitato) === cLower) : all;
  }
  const me = normalize(comitato);
  return all.filter(m => normalize(m.comitato) === me);
}

function getVolontariDisponibiliPerComitato(cLower){
  const all = getVolontari();
  if (["sop","amministratore","tlc_provinciale"].includes(role)) {
    return cLower ? all.filter(v => normalize(v.comitato) === cLower) : all;
  }
  const me = normalize(comitato);
  return all.filter(v => normalize(v.comitato) === me);
}

let resTab = "mezzi";

function switchResTab(which){
  resTab = which;

  const isMezzi = which === "mezzi";
  const isMateriali = which === "materiali";
  const isVolontari = which === "volontari";

  tabMezzi.classList.toggle("active", isMezzi);
  tabMateriali.classList.toggle("active", isMateriali);
  tabVolontari.classList.toggle("active", isVolontari);

  tabMezzi.setAttribute("aria-selected", isMezzi ? "true" : "false");
  tabMateriali.setAttribute("aria-selected", isMateriali ? "true" : "false");
  tabVolontari.setAttribute("aria-selected", isVolontari ? "true" : "false");

  panelMezzi.style.display = isMezzi ? "block" : "none";
  panelMateriali.style.display = isMateriali ? "block" : "none";
  panelVolontari.style.display = isVolontari ? "block" : "none";

  btnSelectAllMezzi.style.display = isMezzi ? "inline-block" : "none";
  btnSelectAllVol.style.display = isVolontari ? "inline-block" : "none";

  renderResources();
}
tabMezzi.addEventListener("click", () => switchResTab("mezzi"));
tabMateriali.addEventListener("click", () => switchResTab("materiali"));
tabVolontari.addEventListener("click", () => switchResTab("volontari"));

btnClearRes.addEventListener("click", () => {
  selectedMezzi.clear();
  selectedMateriali.clear();
  selectedVolontari.clear();
  renderResources();
});

btnSelectAllMezzi.addEventListener("click", () => {
  const list = getMezziDisponibiliPerComitato(resTargetComitatoLower);
  list.forEach(m => selectedMezzi.add(mezzoKey(m)));
  renderResources();
});
btnSelectAllVol.addEventListener("click", () => {
  const list = getVolontariDisponibiliPerComitato(resTargetComitatoLower);
  list.forEach(v => { const cf = volontarioKey(v); if (cf) selectedVolontari.add(cf); });
  renderResources();
});

resSearch.addEventListener("input", renderResources);

function volunteerLabelByCf(cf){
  const cfu = (cf||"").toUpperCase();
  const v = getVolontari().find(x => ((x.cf||"").toUpperCase()) === cfu);
  if (!v) return cfu;
  const name = `${v.nome||""} ${v.cognome||""}`.trim();
  return name ? `${name} (${cfu})` : cfu;
}

function renderChips(){
  const mezzi = getMezziDisponibiliPerComitato(resTargetComitatoLower);
  const materiali = getMaterialiDisponibiliPerComitato(resTargetComitatoLower);
  const volontari = getVolontariDisponibiliPerComitato(resTargetComitatoLower);

  const chipList = [];

  selectedMezzi.forEach(key => {
    const found = mezzi.find(m => mezzoKey(m) === key) || null;
    const label = found ? `üöó ${(found.targa||"").toUpperCase()} ¬∑ ${found.tipoMezzo||""}` : `üöó ${key.split("|")[0]}`;
    chipList.push({ type:"mezzo", key, label });
  });

  selectedMateriali.forEach((qty, key) => {
    if (!qty || qty <= 0) return;
    const found = materiali.find(m => materialeKey(m) === key) || null;
    const label = found
      ? `üì¶ ${(found.nome||found.codice||"Materiale")} ¬∑ ${qty}${found.unita ? " " + found.unita : ""}`
      : `üì¶ ${key.split("|")[0]} ¬∑ ${qty}`;
    chipList.push({ type:"materiale", key, label });
  });

  selectedVolontari.forEach(cf => {
    const found = volontari.find(v => volontarioKey(v) === cf) || null;
    const name = found ? `${found.nome||""} ${found.cognome||""}`.trim() : "";
    const label = name ? `üë• ${name} (${cf})` : `üë• ${cf}`;
    chipList.push({ type:"volontario", key:cf, label });
  });

  chips.innerHTML = chipList.length
    ? chipList.map(c => `
        <span class="chip">
          <b>${escapeHtml(c.label)}</b>
          <button type="button" aria-label="Rimuovi" data-type="${c.type}" data-key="${escapeHtml(c.key)}">√ó</button>
        </span>
      `).join("")
    : `<span class="muted">Nessuna risorsa selezionata.</span>`;

  chips.querySelectorAll("button[data-key]").forEach(btn => {
    btn.addEventListener("click", () => {
      const type = btn.getAttribute("data-type");
      const key = btn.getAttribute("data-key");
      if (type === "mezzo") selectedMezzi.delete(key);
      else if (type === "materiale") selectedMateriali.delete(key);
      else selectedVolontari.delete(key);
      renderResources();
    });
  });
}

function renderResources(){
  const q = normalize(resSearch.value);
  renderChips();

  // MEZZI
  const mezzi = getMezziDisponibiliPerComitato(resTargetComitatoLower).filter(m => {
    if (!q) return true;
    return normalize(m.targa).includes(q) ||
           normalize(m.tipoMezzo).includes(q) ||
           normalize(m.selettivaRadio).includes(q) ||
           normalize(m.comitato).includes(q);
  });

  mezziCards.innerHTML = mezzi.length ? "" : `<div class="muted">Nessun mezzo disponibile.</div>`;
  mezzi.forEach(m => {
    const key = mezzoKey(m);
    const checked = selectedMezzi.has(key);

    const el = document.createElement("div");
    el.className = "card";
    el.innerHTML = `
      <div class="card-top">
        <div>
          <h4>${escapeHtml((m.targa || "").toUpperCase())} ¬∑ ${escapeHtml(m.tipoMezzo || "Mezzo")}</h4>
          <div class="meta">
            Selettiva: <b>${escapeHtml((m.selettivaRadio || "").toUpperCase())}</b><br/>
            Comitato: ${escapeHtml(m.comitato || "")}<br/>
            Posti: ${escapeHtml(String(m.posti ?? ""))}
          </div>
        </div>
        <div class="right">
          <input type="checkbox" aria-label="Seleziona mezzo ${escapeHtml(m.targa || "")}" ${checked ? "checked" : ""} />
        </div>
      </div>
    `;
    const checkbox = el.querySelector('input[type="checkbox"]');
    checkbox.addEventListener("change", () => {
      if (checkbox.checked) selectedMezzi.add(key);
      else selectedMezzi.delete(key);
      renderChips();
    });
    mezziCards.appendChild(el);
  });

  // MATERIALI
  const mats = getMaterialiDisponibiliPerComitato(resTargetComitatoLower).filter(m => {
    if (!q) return true;
    return normalize(m.codice).includes(q) ||
           normalize(m.nome).includes(q) ||
           normalize(m.categoria).includes(q) ||
           normalize(m.comitato).includes(q) ||
           normalize(m.ubicazione).includes(q) ||
           normalize(m.stato).includes(q);
  });

  materialiCards.innerHTML = mats.length ? "" : `<div class="muted">Nessun materiale disponibile.</div>`;
  mats.forEach(m => {
    const key = materialeKey(m);
    const available = Number.isFinite(Number(m.quantita)) ? Number(m.quantita) : 0;
    const current = selectedMateriali.has(key) ? Number(selectedMateriali.get(key) || 0) : 0;

    const el = document.createElement("div");
    el.className = "card";
    el.innerHTML = `
      <div class="card-top">
        <div>
          <h4>${escapeHtml(m.nome || "Materiale")} ¬∑ ${escapeHtml((m.codice || "").toUpperCase())}</h4>
          <div class="meta">
            Categoria: ${escapeHtml(m.categoria || "")}<br/>
            Comitato: ${escapeHtml(m.comitato || "")}<br/>
            Disponibili: <b>${escapeHtml(String(available))}${m.unita ? " " + escapeHtml(m.unita) : ""}</b>
            ${m.ubicazione ? `<br/>Ubicazione: ${escapeHtml(m.ubicazione)}` : ""}
          </div>
        </div>
        <div class="right">
          <div class="qty-wrap">
            <button type="button" class="qty-btn" aria-label="Diminuisci">‚àí</button>
            <input class="qty-input" type="number" min="0" max="${escapeHtml(String(available))}" step="1" value="${escapeHtml(String(current))}" />
            <button type="button" class="qty-btn" aria-label="Aumenta">+</button>
          </div>
        </div>
      </div>
    `;
    const minus = el.querySelectorAll(".qty-btn")[0];
    const plus  = el.querySelectorAll(".qty-btn")[1];
    const input = el.querySelector(".qty-input");

    function clampAndStore(v){
      let n = parseInt(v, 10);
      if (Number.isNaN(n)) n = 0;
      n = Math.max(0, Math.min(available, n));
      input.value = String(n);
      if (n > 0) selectedMateriali.set(key, n);
      else selectedMateriali.delete(key);
      renderChips();
    }

    minus.addEventListener("click", () => clampAndStore((parseInt(input.value || "0", 10) || 0) - 1));
    plus.addEventListener("click", () => clampAndStore((parseInt(input.value || "0", 10) || 0) + 1));
    input.addEventListener("input", () => clampAndStore(input.value));

    materialiCards.appendChild(el);
  });

  // VOLONTARI ‚úÖ
  const vols = getVolontariDisponibiliPerComitato(resTargetComitatoLower).filter(v => {
    if (!q) return true;
    const name = `${v.nome||""} ${v.cognome||""}`.trim();
    return normalize(name).includes(q) ||
           normalize(v.cf).includes(q) ||
           normalize(v.qualifica).includes(q) ||
           normalize(v.comitato).includes(q);
  });

  volontariCards.innerHTML = vols.length ? "" : `<div class="muted">Nessun volontario disponibile.</div>`;
  vols.forEach(v => {
    const cf = volontarioKey(v);
    if (!cf) return;
    const checked = selectedVolontari.has(cf);
    const name = `${v.nome||""} ${v.cognome||""}`.trim() || cf;

    const el = document.createElement("div");
    el.className = "card";
    el.innerHTML = `
      <div class="card-top">
        <div>
          <h4>${escapeHtml(name)}</h4>
          <div class="meta">
            CF: <b>${escapeHtml(cf)}</b><br/>
            Comitato: ${escapeHtml(v.comitato || "")}
            ${v.qualifica ? `<br/>Qualifica: ${escapeHtml(v.qualifica)}` : ""}
          </div>
        </div>
        <div class="right">
          <input type="checkbox" aria-label="Seleziona volontario ${escapeHtml(cf)}" ${checked ? "checked" : ""} />
        </div>
      </div>
    `;
    const checkbox = el.querySelector('input[type="checkbox"]');
    checkbox.addEventListener("change", () => {
      if (checkbox.checked) selectedVolontari.add(cf);
      else selectedVolontari.delete(cf);
      renderChips();
    });
    volontariCards.appendChild(el);
  });
}

/* ===========================
   APRI/CHIUDI MODALE RISORSE
=========================== */
function openResModal(em, targetComLower){
  if (!canContribute(em)) {
    alert("Non puoi aggiungere risorse: l'emergenza non √® approvata per il tuo comitato (o non hai permessi).");
    return;
  }

  resTargetComitatoLower = targetComLower || normalize(comitato) || normalize(em.comitatoCreatore);

  const canPickCommittee = ["sop","amministratore","tlc_provinciale"].includes(role);
  resCommitteeRow.style.display = canPickCommittee ? "flex" : "none";

  if (canPickCommittee) {
    const allC = getAllCommittees();
    resCommitteeSelect.innerHTML = allC.map(c => {
      const sel = c === resTargetComitatoLower ? "selected" : "";
      return `<option value="${escapeHtml(c)}" ${sel}>${escapeHtml(c)}</option>`;
    }).join("");
    resCommitteeSelect.onchange = () => {
      resTargetComitatoLower = resCommitteeSelect.value;
      selectedMezzi.clear();
      selectedMateriali.clear();
      selectedVolontari.clear();
      preloadResSelectionFromContribution(em, resTargetComitatoLower);
      resSearch.value = "";
      renderResources();
    };
  }

  selectedMezzi.clear();
  selectedMateriali.clear();
  selectedVolontari.clear();
  preloadResSelectionFromContribution(em, resTargetComitatoLower);

  resSearch.value = "";
  switchResTab("mezzi");
  renderResources();

  openDialog(resContainer, resSearch);
}

function preloadResSelectionFromContribution(em, comLower){
  ensureEmergenzaShape(em);
  const contrib = em.contributi?.[comLower];
  if (!contrib) return;

  (contrib.mezziUsati || []).forEach(m => selectedMezzi.add(m.key || mezzoKey(m)));
  (contrib.materialiUsati || []).forEach(m => {
    const q = parseInt(m.quantita, 10);
    if (!Number.isNaN(q) && q > 0) selectedMateriali.set(m.key || materialeKey(m), q);
  });
  (contrib.volontariUsati || []).forEach(v => {
    const cf = (v.cf || "").toUpperCase();
    if (cf) selectedVolontari.add(cf);
  });
}

function closeResModal(){
  resTargetComitatoLower = null;
  selectedMezzi.clear();
  selectedMateriali.clear();
  selectedVolontari.clear();
  closeDialog(resContainer);
}
resClose.addEventListener("click", closeResModal);
btnCancelRes.addEventListener("click", closeResModal);

btnSaveRes.addEventListener("click", () => {
  const emergenze = getEmergenze();
  const idx = emergenze.findIndex(e => e.id === currentInfoId);
  if (idx === -1) { alert("Emergenza non trovata."); return; }

  const em = emergenze[idx];
  ensureEmergenzaShape(em);

  const comLower = resTargetComitatoLower || normalize(comitato);
  if (!comLower) { alert("Comitato non valido."); return; }

  if (!em.contributi[comLower]) {
    em.contributi[comLower] = { comitatoLabel: comLower, mezziUsati: [], materialiUsati: [], volontariUsati: [], logInterventi: [] };
  }

  const mezziAll = getMezzi();
  const materialiAll = getMateriali();
  const volontariAll = getVolontari();

  const mezziUsati = Array.from(selectedMezzi).map(key => {
    const found = mezziAll.find(m => mezzoKey(m) === key) || null;
    const [targa, selettivaRadio] = key.split("|");
    return {
      key,
      targa: (found?.targa || targa || "").toUpperCase(),
      selettivaRadio: (found?.selettivaRadio || selettivaRadio || "").toUpperCase(),
      tipoMezzo: found?.tipoMezzo || "",
      comitato: found?.comitato || comLower
    };
  });

  const materialiUsati = Array.from(selectedMateriali.entries()).map(([key, qty]) => {
    const found = materialiAll.find(m => materialeKey(m) === key) || null;
    const codice = (found?.codice || key.split("|")[0] || "").toUpperCase();
    return {
      key,
      codice,
      nome: found?.nome || "",
      categoria: found?.categoria || "",
      comitato: found?.comitato || comLower,
      lotto: found?.lotto || "",
      quantita: qty,
      unita: found?.unita || ""
    };
  }).filter(x => x.quantita > 0);

  const volontariUsati = Array.from(selectedVolontari).map(cf => {
    const found = volontariAll.find(v => (v.cf||"").toUpperCase() === cf) || null;
    return {
      cf,
      nome: found?.nome || "",
      cognome: found?.cognome || "",
      comitato: found?.comitato || comLower
    };
  }).filter(v => v.cf);

  em.contributi[comLower].mezziUsati = mezziUsati;
  em.contributi[comLower].materialiUsati = materialiUsati;
  em.contributi[comLower].volontariUsati = volontariUsati;
  if (!Array.isArray(em.contributi[comLower].logInterventi)) em.contributi[comLower].logInterventi = [];

  em.updatedAt = new Date().toISOString();
  emergenze[idx] = em;
  setEmergenze(emergenze);

  closeResModal();

  const fresh = getEmergenze().find(x => x.id === em.id);
  if (fresh) showInfoPopup(fresh);
  renderEmergenze();
});

/* ===========================
   LOG MODAL
=========================== */
function openLogModal(em, comLower, logEntry){
  if (!canContribute(em)) {
    alert("Non puoi inserire log: emergenza non approvata per il tuo comitato (o non hai permessi).");
    return;
  }

  currentContribCom = comLower;
  currentLogEditId = logEntry?.id ?? null;

  ensureEmergenzaShape(em);
  if (!em.contributi[comLower]) {
    em.contributi[comLower] = { comitatoLabel: comLower, mezziUsati: [], materialiUsati: [], volontariUsati: [], logInterventi: [] };
  }

  if (!logEntry) {
    const now = new Date();
    const start = new Date(now.getTime());
    const end = new Date(now.getTime() + 60*60*1000);
    logStart.value = start.toISOString().slice(0,16);
    logEnd.value = end.toISOString().slice(0,16);
    logAttivita.value = "";
    logResponsabile.value = "";
    logNote.value = "";
  } else {
    logStart.value = (logEntry.startISO || "").slice(0,16);
    logEnd.value = (logEntry.endISO || "").slice(0,16);
    logAttivita.value = logEntry.attivita || "";
    logResponsabile.value = logEntry.responsabile || "";
    logNote.value = logEntry.note || "";
  }

  const volontari = getVolontariDisponibiliPerComitato(comLower);

  const defaultVols = (!logEntry)
    ? new Set((em.contributi[comLower].volontariUsati || []).map(v => (v.cf||"").toUpperCase()).filter(Boolean))
    : new Set((logEntry.volontari || []).map(x => (x||"").toUpperCase()));

  logVolontari.innerHTML = volontari.map(v => {
    const cf = (v.cf || "").toUpperCase();
    const name = `${v.nome || ""} ${v.cognome || ""}`.trim();
    const label = name ? `${name} (${cf})` : cf;
    const sel = defaultVols.has(cf) ? "selected" : "";
    return `<option value="${escapeHtml(cf)}" ${sel}>${escapeHtml(label)}</option>`;
  }).join("");

  const mezzi = em.contributi[comLower].mezziUsati || [];
  const selectedM = new Set(logEntry?.mezzi || []);
  logMezzi.innerHTML = mezzi.length
    ? mezzi.map(m => {
        const key = m.key || `${(m.targa||"").toUpperCase()}|${(m.selettivaRadio||"").toUpperCase()}`;
        const label = `${(m.targa||"").toUpperCase()} ¬∑ ${m.tipoMezzo || ""} ¬∑ ${((m.selettivaRadio||"").toUpperCase())}`;
        const sel = selectedM.has(key) ? "selected" : "";
        return `<option value="${escapeHtml(key)}" ${sel}>${escapeHtml(label)}</option>`;
      }).join("")
    : `<option value="" disabled>Nessun mezzo nel contributo</option>`;

  const mats = em.contributi[comLower].materialiUsati || [];
  const currentMap = new Map((logEntry?.materiali || []).map(x => [x.key, Number(x.qty)||0]));

  if (!mats.length) {
    logMaterialiWrap.innerHTML = `<div class="muted">Nessun materiale nel contributo.</div>`;
  } else {
    logMaterialiWrap.innerHTML = mats.map(m => {
      const max = Number(m.quantita) || 0;
      const cur = Math.max(0, Math.min(max, currentMap.get(m.key) ?? 0));
      const label = `${m.nome || m.codice || ""} (${m.codice || ""})`;
      return `
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:center; padding:8px 6px; border-bottom:1px solid #eee;">
          <div style="min-width:240px;">
            <b>${escapeHtml(label)}</b>
            <div class="muted">Disponibili nel contributo: ${escapeHtml(String(max))}${m.unita ? " " + escapeHtml(m.unita) : ""}</div>
          </div>
          <div class="qty-wrap">
            <button type="button" class="qty-btn" data-mk="${escapeHtml(m.key)}" data-d="-1">‚àí</button>
            <input class="qty-input" data-mk="${escapeHtml(m.key)}" type="number" min="0" max="${escapeHtml(String(max))}" step="1" value="${escapeHtml(String(cur))}">
            <button type="button" class="qty-btn" data-mk="${escapeHtml(m.key)}" data-d="1">+</button>
          </div>
        </div>
      `;
    }).join("");

    logMaterialiWrap.querySelectorAll(".qty-btn").forEach(btn => {
      btn.addEventListener("click", () => {
        const mk = btn.getAttribute("data-mk");
        const d = parseInt(btn.getAttribute("data-d"), 10) || 0;
        const input = logMaterialiWrap.querySelector(`input.qty-input[data-mk="${CSS.escape(mk)}"]`);
        if (!input) return;
        const max = parseInt(input.getAttribute("max") || "0", 10) || 0;
        const cur = parseInt(input.value || "0", 10) || 0;
        const next = Math.max(0, Math.min(max, cur + d));
        input.value = String(next);
      });
    });
  }

  logSubmit.textContent = currentLogEditId ? "Salva Modifiche" : "Salva Intervento";
  openDialog(logContainer, logStart);
}

function closeLogModal(){
  currentLogEditId = null;
  currentContribCom = null;
  closeDialog(logContainer);
  logForm.reset();
}
logClose.addEventListener("click", closeLogModal);

logForm.addEventListener("submit", (e) => {
  e.preventDefault();

  const emergenze = getEmergenze();
  const idx = emergenze.findIndex(x => x.id === currentInfoId);
  if (idx === -1) { alert("Emergenza non trovata."); return; }

  const em = emergenze[idx];
  ensureEmergenzaShape(em);

  const comLower = currentContribCom;
  if (!comLower) { alert("Comitato contributo non valido."); return; }

  if (!em.contributi[comLower]) {
    em.contributi[comLower] = { comitatoLabel: comLower, mezziUsati: [], materialiUsati: [], volontariUsati: [], logInterventi: [] };
  }

  if (!logForm.checkValidity()) { logForm.reportValidity(); return; }

  const startISO = logStart.value ? new Date(logStart.value).toISOString() : "";
  const endISO = logEnd.value ? new Date(logEnd.value).toISOString() : "";
  if (startISO && endISO && new Date(endISO) < new Date(startISO)) {
    alert("L'orario di fine non pu√≤ essere prima dell'inizio.");
    return;
  }

  const volontariSel = Array.from(logVolontari.selectedOptions).map(o => (o.value||"").toUpperCase()).filter(Boolean);
  const mezziSel = Array.from(logMezzi.selectedOptions).map(o => o.value).filter(Boolean);

  const mats = [];
  logMaterialiWrap.querySelectorAll("input.qty-input").forEach(inp => {
    const mk = inp.getAttribute("data-mk");
    const max = parseInt(inp.getAttribute("max") || "0", 10) || 0;
    const v = Math.max(0, Math.min(max, parseInt(inp.value || "0", 10) || 0));
    if (v > 0) mats.push({ key: mk, qty: v });
  });

  const entry = {
    id: currentLogEditId ?? Date.now(),
    startISO,
    endISO,
    attivita: logAttivita.value.trim(),
    responsabile: logResponsabile.value.trim(),
    note: logNote.value.trim(),
    volontari: volontariSel,
    mezzi: mezziSel,
    materiali: mats
  };

  const logArr = em.contributi[comLower].logInterventi || [];
  const eidx = logArr.findIndex(x => x.id === entry.id);
  if (eidx === -1) logArr.push(entry);
  else logArr[eidx] = entry;

  logArr.sort((a,b) => (a.startISO || "").localeCompare(b.startISO || ""));
  em.contributi[comLower].logInterventi = logArr;

  em.updatedAt = new Date().toISOString();
  emergenze[idx] = em;
  setEmergenze(emergenze);

  closeLogModal();

  const fresh = getEmergenze().find(x => x.id === em.id);
  if (fresh) showInfoPopup(fresh);
  renderEmergenze();
});

function deleteLogEntry(emId, comLower, logId){
  const emergenze = getEmergenze();
  const idx = emergenze.findIndex(x => x.id === emId);
  if (idx === -1) return;

  const em = emergenze[idx];
  ensureEmergenzaShape(em);

  if (!em.contributi?.[comLower]) return;

  if (!confirm("Vuoi eliminare questo intervento dal log?")) return;

  em.contributi[comLower].logInterventi = (em.contributi[comLower].logInterventi || []).filter(x => x.id !== logId);
  em.updatedAt = new Date().toISOString();
  emergenze[idx] = em;
  setEmergenze(emergenze);

  showInfoPopup(em);
  renderEmergenze();
}

/* ===========================
   PDF/EXCEL (tutti i contributi) + VOLONTARI INCLUSI
=========================== */
function buildReportHtml(em){
  ensureEmergenzaShape(em);
  const css = `
    <style>
      body{font-family:Arial,sans-serif;margin:24px;color:#222}
      h1{color:#b71c1c;margin:0 0 8px}
      .sub{color:#666;margin:0 0 16px}
      .grid{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin:12px 0 18px}
      .box{border:1px solid #ddd;border-radius:10px;padding:12px}
      .box h3{margin:0 0 8px;color:#b71c1c}
      table{width:100%;border-collapse:collapse}
      th,td{border:1px solid #ddd;padding:8px;font-size:13px;vertical-align:top}
      th{background:#f3f3f3;text-align:left}
      .pill{display:inline-block;padding:2px 8px;border-radius:999px;border:1px solid #ddd;background:#fafafa;font-size:12px;margin:2px 4px 0 0}
      @media print{ .no-print{display:none} }
    </style>
  `;

  const destinatari = [];
  if ((em.destSol || []).length) destinatari.push("SOL: " + em.destSol.join(", "));
  if (em.destSop) destinatari.push("SOP");
  const destStr = destinatari.length ? destinatari.join(" | ") : "Solo creatore";

  const header = `
    <h1>üö® Scheda Emergenza</h1>
    <p class="sub"><b>${escapeHtml(em.titolo||"")}</b> ‚Äî ${escapeHtml(em.tipo||"")} ‚Ä¢ ${escapeHtml(em.luogo||"")} ‚Ä¢ Inizio: ${escapeHtml(formatDate(em.dataInizio))} ${escapeHtml(em.oraInizio||"")}</p>
    <div class="grid">
      <div class="box">
        <h3>Dati</h3>
        <div><b>Comitato creatore:</b> ${escapeHtml(em.comitatoCreatore||"")}</div>
        <div><b>Destinatari:</b> ${escapeHtml(destStr)}</div>
        <div><b>Severit√†:</b> ${escapeHtml(em.livello||"")}</div>
        <div><b>Stato:</b> ${escapeHtml(em.stato||"")}</div>
        <div><b>Referente:</b> ${escapeHtml(em.referente||"‚Äî")}</div>
        <div style="margin-top:8px"><b>Descrizione:</b><br/>${escapeHtml(em.descrizione||"")}</div>
      </div>
      <div class="box">
        <h3>Riepilogo</h3>
        <div><b>Approvazioni:</b> ${escapeHtml(approvalsToCommitteeList(em.approvazioni))}</div>
        <div><b>Contributi comitati:</b> ${Object.keys(em.contributi||{}).length}</div>
        <div><b>Aggiornata:</b> ${escapeHtml(toLocaleDT(em.updatedAt||""))}</div>
      </div>
    </div>
  `;

  const volontariAll = getVolontari();
  const cfToName = (cf) => {
    const cfu = (cf||"").toUpperCase();
    const v = volontariAll.find(x => (x.cf||"").toUpperCase() === cfu);
    const name = v ? `${v.nome||""} ${v.cognome||""}`.trim() : "";
    return name ? `${name} (${cfu})` : cfu;
  };

  const contribBlocks = Object.keys(em.contributi||{}).sort().map(k => {
    const c = em.contributi[k];
    const mezzi = c.mezziUsati || [];
    const mats = c.materialiUsati || [];
    const vols = c.volontariUsati || [];
    const logs = c.logInterventi || [];

    const volsTable = `
      <h4 style="margin:10px 0 6px;color:#b71c1c">üë• Volontari (${vols.length})</h4>
      <table>
        <thead><tr><th>Nome</th><th>Cognome</th><th>CF</th></tr></thead>
        <tbody>
          ${vols.length ? vols.map(v => `
            <tr><td>${escapeHtml(v.nome||"")}</td><td>${escapeHtml(v.cognome||"")}</td><td>${escapeHtml((v.cf||"").toUpperCase())}</td></tr>
          `).join("") : `<tr><td colspan="3" style="color:#666">Nessun volontario</td></tr>`}
        </tbody>
      </table>
    `;

    const mezziTable = `
      <h4 style="margin:10px 0 6px;color:#b71c1c">üöó Mezzi (${mezzi.length})</h4>
      <table>
        <thead><tr><th>Targa</th><th>Tipo</th><th>Selettiva</th></tr></thead>
        <tbody>
          ${mezzi.length ? mezzi.map(m => `
            <tr><td>${escapeHtml(m.targa||"")}</td><td>${escapeHtml(m.tipoMezzo||"")}</td><td>${escapeHtml(m.selettivaRadio||"")}</td></tr>
          `).join("") : `<tr><td colspan="3" style="color:#666">Nessun mezzo</td></tr>`}
        </tbody>
      </table>
    `;

    const matsTable = `
      <h4 style="margin:10px 0 6px;color:#b71c1c">üì¶ Materiali (${mats.length})</h4>
      <table>
        <thead><tr><th>Codice</th><th>Materiale</th><th>Categoria</th><th>Q.t√†</th></tr></thead>
        <tbody>
          ${mats.length ? mats.map(m => `
            <tr>
              <td>${escapeHtml(m.codice||"")}</td>
              <td>${escapeHtml(m.nome||"")}</td>
              <td>${escapeHtml(m.categoria||"")}</td>
              <td>${escapeHtml(String(m.quantita??""))}${m.unita ? " " + escapeHtml(m.unita) : ""}</td>
            </tr>
          `).join("") : `<tr><td colspan="4" style="color:#666">Nessun materiale</td></tr>`}
        </tbody>
      </table>
    `;

    const logTable = `
      <h4 style="margin:10px 0 6px;color:#b71c1c">üìù Log interventi (${logs.length})</h4>
      <table>
        <thead><tr><th>Inizio</th><th>Fine</th><th>Attivit√†</th><th>Volontari</th><th>Mezzi</th><th>Materiali</th></tr></thead>
        <tbody>
          ${logs.length ? logs.map(x => {
            const volsP = (x.volontari||[]).map(v => `<span class="pill">${escapeHtml(cfToName(v))}</span>`).join("");
            const mz = (x.mezzi||[]).map(v => `<span class="pill">${escapeHtml(v)}</span>`).join("");
            const mt = (x.materiali||[]).map(v => `<span class="pill">${escapeHtml(v.key)}:${escapeHtml(String(v.qty))}</span>`).join("");
            const extra = `${x.responsabile ? `<div style="color:#666"><b>Resp:</b> ${escapeHtml(x.responsabile)}</div>` : ""}${x.note ? `<div style="color:#666"><b>Note:</b> ${escapeHtml(x.note)}</div>` : ""}`;
            return `
              <tr>
                <td>${escapeHtml(toLocaleDT(x.startISO||""))}</td>
                <td>${escapeHtml(toLocaleDT(x.endISO||""))}</td>
                <td><b>${escapeHtml(x.attivita||"")}</b>${extra}</td>
                <td>${volsP || '<span style="color:#666">‚Äî</span>'}</td>
                <td>${mz || '<span style="color:#666">‚Äî</span>'}</td>
                <td>${mt || '<span style="color:#666">‚Äî</span>'}</td>
              </tr>
            `;
          }).join("") : `<tr><td colspan="6" style="color:#666">Nessun intervento</td></tr>`}
        </tbody>
      </table>
    `;

    return `
      <div class="box" style="margin-bottom:12px">
        <h3>Comitato: ${escapeHtml(titleCaseComitato(c.comitatoLabel || k))}</h3>
        ${volsTable}
        ${mezziTable}
        ${matsTable}
        ${logTable}
      </div>
    `;
  }).join("");

  const footer = `<p class="sub no-print" style="margin-top:14px;">Suggerimento: usa ‚ÄúStampa‚Äù e scegli ‚ÄúSalva come PDF‚Äù.</p>`;

  return `<!doctype html><html><head><meta charset="utf-8">${css}</head><body>${header}${contribBlocks || "<div class='box'><h3>Nessun contributo</h3></div>"}${footer}</body></html>`;
}

function exportPDF(em){
  const w = window.open("", "_blank");
  if (!w) { alert("Popup bloccato: abilita i popup per esportare la scheda."); return; }
  w.document.open();
  w.document.write(buildReportHtml(em));
  w.document.close();
  w.focus();
  setTimeout(() => w.print(), 300);
}

function exportExcel(em){
  ensureEmergenzaShape(em);
  const contribKeys = Object.keys(em.contributi || {}).sort();

  const base = `
  <table border="1">
    <tr><th>Titolo</th><td>${escapeHtml(em.titolo||"")}</td></tr>
    <tr><th>Tipo</th><td>${escapeHtml(em.tipo||"")}</td></tr>
    <tr><th>Luogo</th><td>${escapeHtml(em.luogo||"")}</td></tr>
    <tr><th>Inizio</th><td>${escapeHtml(formatDate(em.dataInizio))} ${escapeHtml(em.oraInizio||"")}</td></tr>
    <tr><th>Comitato creatore</th><td>${escapeHtml(em.comitatoCreatore||"")}</td></tr>
    <tr><th>Severit√†</th><td>${escapeHtml(em.livello||"")}</td></tr>
    <tr><th>Stato</th><td>${escapeHtml(em.stato||"")}</td></tr>
    <tr><th>Referente</th><td>${escapeHtml(em.referente||"")}</td></tr>
    <tr><th>Destinatari</th><td>${escapeHtml(((em.destSol||[]).length ? "SOL: " + em.destSol.join(", ") : "Solo creatore") + (em.destSop ? " | SOP" : ""))}</td></tr>
    <tr><th>Approvazioni</th><td>${escapeHtml(approvalsToCommitteeList(em.approvazioni))}</td></tr>
    <tr><th>Descrizione</th><td>${escapeHtml(em.descrizione||"")}</td></tr>
  </table>
  `;

  const blocks = contribKeys.map(k => {
    const c = em.contributi[k];
    const mezzi = c.mezziUsati || [];
    const mats = c.materialiUsati || [];
    const vols = c.volontariUsati || [];
    const logs = c.logInterventi || [];

    return `
      <h3>Contributo comitato: ${escapeHtml(titleCaseComitato(c.comitatoLabel || k))}</h3>

      <table border="1">
        <tr><th colspan="3">Volontari</th></tr>
        <tr><th>Nome</th><th>Cognome</th><th>CF</th></tr>
        ${vols.length ? vols.map(v => `
          <tr><td>${escapeHtml(v.nome||"")}</td><td>${escapeHtml(v.cognome||"")}</td><td>${escapeHtml((v.cf||"").toUpperCase())}</td></tr>
        `).join("") : `<tr><td colspan="3">Nessun volontario</td></tr>`}
      </table>

      <br/>

      <table border="1">
        <tr><th colspan="3">Mezzi</th></tr>
        <tr><th>Targa</th><th>Tipo</th><th>Selettiva</th></tr>
        ${mezzi.length ? mezzi.map(m => `
          <tr><td>${escapeHtml(m.targa||"")}</td><td>${escapeHtml(m.tipoMezzo||"")}</td><td>${escapeHtml(m.selettivaRadio||"")}</td></tr>
        `).join("") : `<tr><td colspan="3">Nessun mezzo</td></tr>`}
      </table>

      <br/>

      <table border="1">
        <tr><th colspan="4">Materiali</th></tr>
        <tr><th>Codice</th><th>Materiale</th><th>Categoria</th><th>Q.t√†</th></tr>
        ${mats.length ? mats.map(m => `
          <tr><td>${escapeHtml(m.codice||"")}</td><td>${escapeHtml(m.nome||"")}</td><td>${escapeHtml(m.categoria||"")}</td><td>${escapeHtml(String(m.quantita??""))}${m.unita ? " " + escapeHtml(m.unita) : ""}</td></tr>
        `).join("") : `<tr><td colspan="4">Nessun materiale</td></tr>`}
      </table>

      <br/>

      <table border="1">
        <tr><th colspan="8">Log interventi</th></tr>
        <tr>
          <th>Inizio</th><th>Fine</th><th>Attivit√†</th><th>Responsabile</th><th>Volontari (CF)</th><th>Mezzi (key)</th><th>Materiali (key:qty)</th><th>Note</th>
        </tr>
        ${logs.length ? logs.map(x => `
          <tr>
            <td>${escapeHtml(toLocaleDT(x.startISO||""))}</td>
            <td>${escapeHtml(toLocaleDT(x.endISO||""))}</td>
            <td>${escapeHtml(x.attivita||"")}</td>
            <td>${escapeHtml(x.responsabile||"")}</td>
            <td>${escapeHtml((x.volontari||[]).join(" | "))}</td>
            <td>${escapeHtml((x.mezzi||[]).join(" | "))}</td>
            <td>${escapeHtml((x.materiali||[]).map(m => `${m.key}:${m.qty}`).join(" | "))}</td>
            <td>${escapeHtml(x.note||"")}</td>
          </tr>
        `).join("") : `<tr><td colspan="8">Nessun intervento</td></tr>`}
      </table>

      <br/><br/>
    `;
  }).join("");

  const html = `<html><head><meta charset="utf-8"></head><body>
    <h2>Scheda Emergenza (Tutti i contributi)</h2>
    ${base}
    <br/>
    ${blocks || "<p>Nessun contributo.</p>"}
  </body></html>`;

  const blob = new Blob([html], { type: "application/vnd.ms-excel;charset=utf-8" });
  const url = URL.createObjectURL(blob);
  const a = document.createElement("a");
  const safeTitle = (em.titolo || "Emergenza").replace(/[\\/:*?"<>|]+/g, "-");
  a.href = url;
  a.download = `Emergenza_${safeTitle}_${em.id}.xls`;
  document.body.appendChild(a);
  a.click();
  a.remove();
  URL.revokeObjectURL(url);
}

/* ===========================
   CREA/MODIFICA EMERGENZA
=========================== */
function toggleForm(show){
  if (show){
    form.comitatoCreatore.value = comitato || "";
    submitBtn.textContent = editIndex === null ? "Crea Emergenza" : "Salva Modifiche";
    openDialog(formContainer, form.titolo);
  } else {
    closeDialog(formContainer);
    form.reset();
    form.comitatoCreatore.value = comitato || "";
    editIndex = null;
    submitBtn.textContent = "Crea Emergenza";
  }
}

btnApriForm.addEventListener("click", () => {
  if (!(role === "sol" || role === "sop" || role === "amministratore")) {
    alert("Solo SOL/SOP/Amministratore possono creare o modificare emergenze.");
    return;
  }

  editIndex = null;
  const now = new Date();
  form.dataInizio.value = now.toISOString().slice(0,10);
  form.oraInizio.value = now.toTimeString().slice(0,5);

  toggleForm(true);
});
btnChiudiForm.addEventListener("click", () => toggleForm(false));

form.addEventListener("submit", (e) => {
  e.preventDefault();

  if (!(role === "sol" || role === "sop" || role === "amministratore")) {
    alert("Solo SOL/SOP/Amministratore possono creare o modificare emergenze.");
    return;
  }
  if (!form.checkValidity()) { form.reportValidity(); return; }

  const emergenze = getEmergenze();

  const destSolRaw = (form.destSol.value || "")
    .split(",").map(s => s.trim()).filter(Boolean);

  const creatorLower = normalize(form.comitatoCreatore.value);

  const prev = (editIndex === null) ? null : emergenze[editIndex];

  const approvazioniBase = (editIndex === null ? {} : (prev?.approvazioni || {}));
  approvazioniBase[creatorLower] = "approved";

  destSolRaw.map(x => normalize(x)).filter(Boolean).forEach(k => {
    if (!approvazioniBase[k]) approvazioniBase[k] = "pending";
  });

  const toSop = !!form.destSop.checked;
  if (toSop && !approvazioniBase.SOP) approvazioniBase.SOP = "pending";
  if (!toSop && approvazioniBase.SOP && approvazioniBase.SOP === "pending") delete approvazioniBase.SOP;
  if (!toSop && approvazioniBase.ALL) delete approvazioniBase.ALL;

  const nuovo = {
    id: editIndex === null ? Date.now() : (prev?.id ?? Date.now()),
    titolo: form.titolo.value.trim(),
    tipo: form.tipo.value.trim(),
    luogo: form.luogo.value.trim(),
    livello: form.livello.value,
    dataInizio: form.dataInizio.value,
    oraInizio: form.oraInizio.value,
    referente: form.referente.value.trim(),
    comitatoCreatore: form.comitatoCreatore.value.trim(),
    descrizione: form.descrizione.value.trim(),
    stato: form.stato.value || "attiva",
    destSol: destSolRaw,
    destSop: toSop,
    approvazioni: approvazioniBase,
    contributi: (prev?.contributi && typeof prev.contributi === "object") ? prev.contributi : {},
    updatedAt: new Date().toISOString()
  };

  ensureEmergenzaShape(nuovo);

  if (!nuovo.contributi[creatorLower]) {
    nuovo.contributi[creatorLower] = { comitatoLabel: creatorLower, mezziUsati: [], materialiUsati: [], volontariUsati: [], logInterventi: [] };
  }

  if (editIndex === null) emergenze.push(nuovo);
  else emergenze[editIndex] = nuovo;

  setEmergenze(emergenze);
  toggleForm(false);
  renderEmergenze();
});

/* ===========================
   INFO POPUP + AZIONI
=========================== */
function destinatariStr(em){
  const destinatari = [];
  if ((em.destSol || []).length) destinatari.push("SOL: " + em.destSol.join(", "));
  if (em.destSop) destinatari.push("SOP");
  return destinatari.length ? destinatari.join(" | ") : "Solo creatore";
}

/* ‚úÖ nuovo riepilogo contributi: uno sotto l‚Äôaltro */
function contribSummaryHtml(em){
  ensureEmergenzaShape(em);
  const keys = Object.keys(em.contributi || {}).sort();
  if (!keys.length) return `<span class="muted">Nessun contributo</span>`;

  return keys.map(k => {
    const c = em.contributi[k] || {};
    const mez = (c.mezziUsati || []).length;
    const mat = (c.materialiUsati || []).length;
    const vol = (c.volontariUsati || []).length;
    const log = (c.logInterventi || []).length;
    return `<div>${escapeHtml(k)}: üöó${mez} üì¶${mat} üë•${vol} üìù${log}</div>`;
  }).join("");
}

function showInfoPopup(em){
  ensureEmergenzaShape(em);

  if (!canSeeEmergenza(em)) {
    alert("Non hai i permessi per visualizzare questa emergenza.");
    return;
  }

  currentInfoId = em.id;

  const creatorLower = normalize(em.comitatoCreatore);
  const myLower = normalize(comitato);

  const globalApproved = em.approvazioni?.ALL === "approved";

  const approvazioniRows = [];
  if (creatorLower) approvazioniRows.push(`<tr><td>${escapeHtml(creatorLower)}</td><td>${approvalBadge(em.approvazioni?.[creatorLower] || "approved")}</td></tr>`);
  (em.destSol || []).map(x => normalize(x)).filter(Boolean).forEach(k => {
    approvazioniRows.push(`<tr><td>${escapeHtml(k)}</td><td>${approvalBadge(em.approvazioni?.[k] || "pending")}</td></tr>`);
  });
  if (em.destSop) {
    approvazioniRows.push(`<tr><td><b>SOP</b></td><td>${approvalBadge(em.approvazioni?.SOP || "pending")}${globalApproved ? ' <span class="badge badge-global">ALL</span>' : ""}</td></tr>`);
  }

  const actionsApprove = (() => {
    if (!canApproveForCurrentRole(em)) return "";
    const key = approvalKeyForRole();
    if (!key) return "";

    const st = em.approvazioni?.[key];
    if (st === "approved") return "";

    if (role === "sol") {
      const dest = (em.destSol || []).map(x => normalize(x));
      if (!(dest.includes(myLower))) return "";
    }

    return `
      <div class="section-title">‚úÖ Approvazione (per ${escapeHtml(key)})</div>
      <div class="muted">Conferma se la tua struttura prende in carico l‚Äôemergenza.</div>
      <div style="margin-top:10px;">
        <button type="button" class="action-btn ok-btn" id="btn-approve">Approva</button>
        <button type="button" class="action-btn no-btn" id="btn-reject">Rifiuta</button>
      </div>
    `;
  })();

  const canMeta = canManageEmergenzaMetadata(em);

  const metaActions = canMeta ? `
    <div class="section-title">‚öôÔ∏è Gestione emergenza</div>
    ${em.stato === "attiva"
      ? `<button type="button" class="action-btn close-btn" id="btn-close-em">üîí Chiudi emergenza</button>`
      : `<button type="button" class="action-btn reopen-btn" id="btn-reopen-em">üîì Riapri emergenza</button>`
    }
  ` : "";

  const exportActions = `
    <div class="section-title">
      üìÑ Esportazioni
      <div>
        <button type="button" class="action-btn pdf-btn" id="btn-pdf">üñ®Ô∏è Scheda PDF</button>
        <button type="button" class="action-btn xls-btn" id="btn-xls">üìä Excel</button>
      </div>
    </div>
    <div class="muted">La ‚ÄúScheda PDF‚Äù usa la stampa del browser (poi scegli ‚ÄúSalva come PDF‚Äù).</div>
  `;

  const contribBtn = canContribute(em) ? `
    <div class="section-title">
      üß∞ Contributo del tuo comitato
      <div>
        <button type="button" class="action-btn add-btn" id="btn-manage-res">üöóüì¶üë• Gestisci risorse</button>
        <button type="button" class="action-btn add-btn" id="btn-add-log">üìù Aggiungi log</button>
      </div>
    </div>
    <div class="muted">Qui inserisci mezzi/materiali/volontari e registri turni per <b>${escapeHtml(myLower || "il tuo comitato")}</b>.</div>
  ` : `
    <div class="section-title">üß∞ Contributo del tuo comitato</div>
    <div class="muted">Per contribuire devi prima avere l‚Äôemergenza approvata per il tuo comitato (o approvazione SOP globale).</div>
  `;

  const contribKeys = Object.keys(em.contributi || {}).sort();
  const contribTable = `
    <div class="section-title">üìå Contributi inseriti (${contribKeys.length})</div>
    <table class="mini-table" aria-label="Contributi">
      <thead><tr><th>Comitato</th><th>Mezzi</th><th>Materiali</th><th>Volontari</th><th>Log</th></tr></thead>
      <tbody>
        ${contribKeys.length ? contribKeys.map(k => {
          const c = em.contributi[k];
          const mez = (c.mezziUsati || []).length;
          const mat = (c.materialiUsati || []).length;
          const vol = (c.volontariUsati || []).length;
          const log = (c.logInterventi || []).length;
          return `<tr><td>${escapeHtml(k)}</td><td>üöó ${mez}</td><td>üì¶ ${mat}</td><td>üë• ${vol}</td><td>üìù ${log}</td></tr>`;
        }).join("") : `<tr><td colspan="5" class="muted">Nessun contributo.</td></tr>`}
      </tbody>
    </table>
  `;

  let myLogHtml = "";
  if (canContribute(em) && myLower) {
    const myContrib = em.contributi?.[myLower] || { mezziUsati:[], materialiUsati:[], volontariUsati:[], logInterventi:[] };
    const logs = myContrib.logInterventi || [];

    const rows = logs.length ? logs.map(x => `
      <tr>
        <td class="nowrap">${escapeHtml(toLocaleDT(x.startISO))}</td>
        <td class="nowrap">${escapeHtml(toLocaleDT(x.endISO))}</td>
        <td><b>${escapeHtml(x.attivita||"")}</b>${x.responsabile ? `<div class="muted"><b>Resp:</b> ${escapeHtml(x.responsabile)}</div>`:""}${x.note ? `<div class="muted"><b>Note:</b> ${escapeHtml(x.note)}</div>`:""}</td>
        <td>${escapeHtml((x.volontari||[]).join(" | ")) || '<span class="muted">‚Äî</span>'}</td>
        <td>${escapeHtml((x.mezzi||[]).join(" | ")) || '<span class="muted">‚Äî</span>'}</td>
        <td>${escapeHtml((x.materiali||[]).map(m => `${m.key}:${m.qty}`).join(" | ")) || '<span class="muted">‚Äî</span>'}</td>
        <td class="nowrap">
          <button type="button" class="action-btn edit-btn" data-logedit="${escapeHtml(String(x.id))}">‚úèÔ∏è</button>
          <button type="button" class="action-btn delete-btn" data-logdel="${escapeHtml(String(x.id))}">üóëÔ∏è</button>
        </td>
      </tr>
    `).join("") : `<tr><td colspan="7" class="muted">Nessun log registrato.</td></tr>`;

    myLogHtml = `
      <div class="section-title">üìù Log del tuo comitato (${escapeHtml(myLower)})</div>
      <table class="mini-table" aria-label="Log comitato">
        <thead><tr><th>Inizio</th><th>Fine</th><th>Attivit√†</th><th>Volontari</th><th>Mezzi</th><th>Materiali</th><th>Azioni</th></tr></thead>
        <tbody>${rows}</tbody>
      </table>
      <div class="muted" style="margin-top:8px;">
        Nota: i valori mezzi/materiali nel log sono ‚Äúkey‚Äù interne; PDF/Excel includono anche i volontari.
      </div>
    `;
  }

  const dettagli = `
    <div class="kv"><span class="info-label">Titolo:</span><span class="info-value">${escapeHtml(em.titolo)}</span></div>
    <div class="kv"><span class="info-label">Tipo:</span><span class="info-value">${escapeHtml(em.tipo)}</span></div>
    <div class="kv"><span class="info-label">Luogo:</span><span class="info-value">${escapeHtml(em.luogo)}</span></div>
    <div class="kv"><span class="info-label">Inizio:</span><span class="info-value">${escapeHtml(formatDate(em.dataInizio))} ${escapeHtml(em.oraInizio||"")}</span></div>
    <div class="kv"><span class="info-label">Comitato creatore:</span><span class="info-value">${escapeHtml(em.comitatoCreatore)}</span></div>
    <div class="kv"><span class="info-label">Destinatari:</span><span class="info-value">${escapeHtml(destinatariStr(em))}</span></div>
    <div class="kv"><span class="info-label">Severit√†:</span><span class="info-value">${severitaBadge(em.livello)}</span></div>
    <div class="kv"><span class="info-label">Stato:</span><span class="info-value">${statoBadge(em.stato)}</span></div>
    <div class="kv"><span class="info-label">Referente:</span><span class="info-value">${escapeHtml(em.referente || "‚Äî")}</span></div>
    <div class="kv"><span class="info-label">Descrizione:</span><span class="info-value">${escapeHtml(em.descrizione || "")}</span></div>
  `;

  const approvazioniHtml = `
    <div class="section-title">üì® Approvazioni</div>
    <table class="mini-table" aria-label="Approvazioni">
      <thead><tr><th>Destinatario</th><th>Stato</th></tr></thead>
      <tbody>${approvazioniRows.join("") || `<tr><td colspan="2" class="muted">Nessuna approvazione richiesta.</td></tr>`}</tbody>
    </table>
    ${globalApproved ? `<div class="muted" style="margin-top:8px;"><span class="badge badge-global">ALL</span> SOP approvato: visibile a tutte le SOL abilitate.</div>` : ""}
  `;

  infoContent.innerHTML =
    dettagli +
    exportActions +
    approvazioniHtml +
    actionsApprove +
    contribBtn +
    contribTable +
    myLogHtml +
    metaActions;

  openDialog(infoPopup, infoClose);

  document.getElementById("btn-pdf")?.addEventListener("click", () => exportPDF(em));
  document.getElementById("btn-xls")?.addEventListener("click", () => exportExcel(em));

  const key = approvalKeyForRole();
  document.getElementById("btn-approve")?.addEventListener("click", () => setApproval(em.id, key, "approved"));
  document.getElementById("btn-reject")?.addEventListener("click", () => setApproval(em.id, key, "rejected"));

  document.getElementById("btn-manage-res")?.addEventListener("click", () => {
    const t = (["sop","amministratore","tlc_provinciale"].includes(role))
      ? (normalize(em.comitatoCreatore) || normalize(comitato))
      : normalize(comitato);
    openResModal(em, t);
  });

  document.getElementById("btn-add-log")?.addEventListener("click", () => {
    const cLower = normalize(comitato);
    if (!cLower) { alert("Comitato non valido."); return; }
    openLogModal(em, cLower, null);
  });

  infoContent.querySelectorAll("button[data-logedit]").forEach(btn => {
    btn.addEventListener("click", () => {
      const id = parseInt(btn.getAttribute("data-logedit") || "0", 10);
      const cLower = normalize(comitato);
      const eFresh = getEmergenze().find(x => x.id === em.id);
      if (!eFresh) return;
      ensureEmergenzaShape(eFresh);
      const entry = (eFresh.contributi?.[cLower]?.logInterventi || []).find(x => x.id === id);
      if (!entry) return;
      openLogModal(eFresh, cLower, entry);
    });
  });
  infoContent.querySelectorAll("button[data-logdel]").forEach(btn => {
    btn.addEventListener("click", () => {
      const id = parseInt(btn.getAttribute("data-logdel") || "0", 10);
      const cLower = normalize(comitato);
      deleteLogEntry(em.id, cLower, id);
    });
  });

  document.getElementById("btn-close-em")?.addEventListener("click", () => changeStatoEmergenza(em.id, "chiusa"));
  document.getElementById("btn-reopen-em")?.addEventListener("click", () => changeStatoEmergenza(em.id, "attiva"));
}

function hideInfoPopup(){
  currentInfoId = null;
  closeDialog(infoPopup);
}
infoClose.addEventListener("click", hideInfoPopup);

function changeStatoEmergenza(id, stato){
  const emergenze = getEmergenze();
  const idx = emergenze.findIndex(e => e.id === id);
  if (idx === -1) return;

  const em = emergenze[idx];
  ensureEmergenzaShape(em);

  if (!canManageEmergenzaMetadata(em)) {
    alert("Non hai i permessi per modificare lo stato dell'emergenza.");
    return;
  }

  emergenze[idx].stato = stato;
  emergenze[idx].updatedAt = new Date().toISOString();
  setEmergenze(emergenze);

  renderEmergenze();
  showInfoPopup(emergenze[idx]);
}

/* ===========================
   EDIT/DELETE/INFO
=========================== */
window.showInfoPopupByIndex = function(index){
  const all = getEmergenze();
  const em = all[index];
  if (!em) return;
  showInfoPopup(em);
};

window.editEmergenza = function(index){
  const emergenze = getEmergenze();
  const em = emergenze[index];
  if (!em) return;

  ensureEmergenzaShape(em);

  if (!canManageEmergenzaMetadata(em)) {
    alert("Puoi modificare solo le emergenze create dal tuo comitato (o sei SOP/Admin).");
    return;
  }

  editIndex = index;

  form.titolo.value = em.titolo || "";
  form.tipo.value = em.tipo || "";
  form.luogo.value = em.luogo || "";
  form.livello.value = em.livello || "";
  form.dataInizio.value = em.dataInizio || "";
  form.oraInizio.value = em.oraInizio || "";
  form.referente.value = em.referente || "";
  form.comitatoCreatore.value = em.comitatoCreatore || (comitato || "");
  form.descrizione.value = em.descrizione || "";
  form.stato.value = em.stato || "attiva";
  form.destSol.value = (em.destSol || []).join(", ");
  form.destSop.checked = !!em.destSop;

  toggleForm(true);
};

window.deleteEmergenza = function(index){
  const emergenze = getEmergenze();
  const em = emergenze[index];
  if (!em) return;

  ensureEmergenzaShape(em);

  if (!canManageEmergenzaMetadata(em)) {
    alert("Non hai i permessi per eliminare questa emergenza.");
    return;
  }

  if (confirm(`üóëÔ∏è Sei sicuro di voler eliminare l'emergenza:\n\n${em.titolo}\n${em.luogo}\n\n‚ö†Ô∏è Questa azione √® irreversibile!`)) {
    emergenze.splice(index, 1);
    setEmergenze(emergenze);
    if (currentInfoId === em.id) hideInfoPopup();
    renderEmergenze();
  }
};

/* ===========================
   RENDER LISTA
=========================== */
function renderEmergenze(){
  const filter = normalize(searchInput.value);
  list.innerHTML = "";

  const all = getEmergenze();
  const visibili = getVisibleEmergenze();

  visibili
    .filter(em => {
      if (!filter) return true;
      return normalize(em.titolo).includes(filter) ||
             normalize(em.comitatoCreatore).includes(filter) ||
             normalize(em.luogo).includes(filter) ||
             normalize(em.stato).includes(filter) ||
             normalize(em.tipo).includes(filter);
    })
    .sort((a,b) => {
      const da = `${a.dataInizio || ""}T${a.oraInizio || "00:00"}`;
      const db = `${b.dataInizio || ""}T${b.oraInizio || "00:00"}`;
      return db.localeCompare(da);
    })
    .forEach(em => {
      ensureEmergenzaShape(em);

      const globalIndex = all.findIndex(x => x.id === em.id);
      const dest = destinatariStr(em);

      const canEdit = canManageEmergenzaMetadata(em);

      const actions = `
        <button type="button" class="action-btn info-btn" onclick="showInfoPopupByIndex(${globalIndex})">‚ÑπÔ∏è Info</button>
        ${canEdit ? `<button type="button" class="action-btn edit-btn" onclick="editEmergenza(${globalIndex})">‚úèÔ∏è Modifica</button>` : ""}
        ${canEdit ? `<button type="button" class="action-btn delete-btn" onclick="deleteEmergenza(${globalIndex})">üóëÔ∏è Elimina</button>` : ""}
      `;

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${escapeHtml(em.titolo || "")}</td>
        <td>${escapeHtml(formatDate(em.dataInizio))} ${escapeHtml(em.oraInizio || "")}</td>
        <td>${escapeHtml(em.comitatoCreatore || "")}</td>
        <td>${escapeHtml(dest)}</td>
        <td>${severitaBadge(em.livello)}</td>
        <td>${statoBadge(em.stato)}</td>
        <td>${contribSummaryHtml(em)}</td>
        <td>${actions}</td>
      `;
      list.appendChild(row);
    });
}
searchInput.addEventListener("input", renderEmergenze);

/* ===========================
   INIT
=========================== */
normalizeAllEmergenze();
renderEmergenze();
</script>
</body>
</html>
