<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gestione Volontari - CRI</title>
<style>
  :root {
    --rosso-cri: #b71c1c;
    --bianco: #ffffff;
    --grigio: #f5f5f5;
    --blu-info: #007bff;
  }

  body {
    margin: 0;
    font-family: Arial, sans-serif;
    display: flex;
    min-height: 100vh;
    background: var(--grigio);
  }

  .sidebar {
    width: 260px;
    background: var(--rosso-cri);
    color: var(--bianco);
    display: flex;
    flex-direction: column;
    padding: 20px 0;
    height: 100vh;
    overflow-y: auto;
    align-items: center;
  }

  .sidebar img {
    width: 220px;
    margin-bottom: 20px;
    border-radius: 8px;
  }

  .menu {
    list-style: none;
    padding: 0;
    width: 100%;
    flex-grow: 1;
  }

  .menu li {
    width: 100%;
  }

  .menu a {
    display: block;
    padding: 15px 20px;
    color: var(--bianco);
    font-weight: bold;
    text-decoration: none;
  }

  .menu a:hover,
  .menu a.active {
    background: #9f1b1b;
  }

  #logout {
    margin: 20px auto 0 auto;
    padding: 10px 20px;
    width: 80%;
    background: var(--bianco);
    color: var(--rosso-cri);
    border: 2px solid var(--rosso-cri);
    border-radius: 6px;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.3s, color 0.3s;
  }

  #logout:hover {
    background-color: var(--rosso-cri);
    color: var(--bianco);
  }

  .main {
    flex-grow: 1;
    background: var(--bianco);
    padding: 30px;
    overflow-y: auto;
    position: relative;
  }

  .main h1 {
    color: var(--rosso-cri);
    margin-top: 0;
  }

  #search {
    width: 100%;
    padding: 10px;
    margin-bottom: 20px;
    font-size: 1rem;
    border-radius: 5px;
    border: 1px solid #ccc;
  }

  #btn-apri-form {
    background: var(--rosso-cri);
    color: var(--bianco);
    border: none;
    padding: 12px 20px;
    border-radius: 5px;
    font-weight: bold;
    font-size: 1rem;
    cursor: pointer;
    margin-bottom: 20px;
    transition: background 0.3s;
  }

  #btn-apri-form:hover {
    background: #9f1b1b;
  }

  /* Contenitore form a modale */
  #form-container {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }

  #form-container.active {
    display: flex;
  }

  #form-box {
    background: var(--grigio);
    max-width: 720px;
    width: 95%;
    border-radius: 8px;
    padding: 25px 30px;
    box-shadow: 0 0 10px rgba(0,0,0,0.25);
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
  }

  #btn-chiudi-form {
    position: absolute;
    top: 12px;
    right: 15px;
    font-size: 2rem;
    background: none;
    border: none;
    color: var(--rosso-cri);
    cursor: pointer;
  }

  form .row {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 10px;
  }

  form input,
  form select {
    flex: 1 1 48%;
    padding: 8px;
    border-radius: 4px;
    border: 1px solid #ccc;
    font-size: 1rem;
  }

  form input[type="date"] {
    padding: 6px 8px;
  }

  /* Stile per campi readonly */
  form input[readonly] {
    background-color: #e9ecef;
    color: #6c757d;
    cursor: not-allowed;
  }

  /* Qualifiche a due colonne */
  .qualifiche-container {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px 20px;
    margin-bottom: 15px;
  }

  /* Patenti a due colonne */
  .patenti-container {
    display: grid;
    grid-template-columns: repeat(2, 1fr);
    gap: 10px 20px;
    margin-bottom: 15px;
  }

  /* Consenso a una colonna (testo) + checkbox separata */
  .consenso-container {
    margin-bottom: 15px;
  }

  .consenso-checkbox-wrapper {
    margin-top: 10px;
  }

  form button[type="submit"] {
    background: var(--rosso-cri);
    color: var(--bianco);
    border: none;
    padding: 12px 20px;
    border-radius: 5px;
    font-weight: bold;
    font-size: 1rem;
    cursor: pointer;
    transition: background 0.3s;
    margin-top: 10px;
  }

  form button[type="submit"]:hover {
    background: #9f1b1b;
  }

  table {
    width: 100%;
    border-collapse: collapse;
    max-width: 1200px;
  }

  table th,
  table td {
    border: 1px solid #ccc;
    padding: 10px;
    text-align: left;
    vertical-align: middle;
  }

  table th {
    background: var(--rosso-cri);
    color: var(--bianco);
  }

  .action-btn {
    cursor: pointer;
    padding: 6px 10px;
    margin: 0 2px;
    border: none;
    border-radius: 4px;
    font-weight: bold;
    font-size: 0.9rem;
  }

  .edit-btn {
    background-color: #ffc107;
    color: #000;
  }

  .delete-btn {
    background-color: #dc3545;
    color: #fff;
  }

  .info-btn {
    background-color: var(--blu-info);
    color: #fff;
  }

  /* ‚úÖ POPUP INFO MIGLIORATO */
  #info-popup {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 750px;
    max-width: 95%;
    max-height: 90vh;
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 50px rgba(0,0,0,0.4);
    display: none;
    z-index: 1100;
    overflow: hidden;
  }

  #info-popup.active {
    display: block;
  }

  #info-popup h3 {
    margin: 0;
    padding: 25px 30px;
    background: var(--rosso-cri);
    color: white;
    font-size: 1.4rem;
    border-radius: 12px 12px 0 0;
  }

  #info-content {
    padding: 25px 30px;
    font-size: 1rem;
    line-height: 2;
    color: #333;
    max-height: calc(90vh - 100px);
    overflow-y: auto;
  }

  /* ‚úÖ Righe info con sfondo alternato */
  #info-content > div {
    display: flex;
    padding: 12px 15px;
    border-radius: 6px;
    margin-bottom: 5px;
  }

  #info-content > div:nth-child(even) {
    background: #f8f9fa;
  }

  .info-label {
    color: var(--rosso-cri);
    font-weight: bold;
    min-width: 200px;
    flex-shrink: 0;
  }

  .info-value {
    color: #333;
    flex: 1;
  }

  #info-close {
    position: absolute;
    top: 20px;
    right: 25px;
    background: rgba(255,255,255,0.2);
    border: none;
    font-size: 1.8rem;
    color: white;
    cursor: pointer;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
  }

  #info-close:hover {
    background: rgba(255,255,255,0.3);
    transform: rotate(90deg);
  }
</style>
</head>
<body>
<aside class="sidebar" aria-label="Navigazione principale">
  <img id="logo-cri" src="logo.svg" alt="Logo Croce Rossa Italiana" />
  <ul class="menu" id="menu-sidebar" role="navigation" aria-label="Menu principale"></ul>
  <button id="logout" type="button">üö™ Logout</button>
</aside>

<main class="main">
  <h1 id="pageTitle">üë• Gestione Volontari</h1>
  <input
    type="search"
    id="search"
    placeholder="üîç Cerca per nome, cognome, CF o email"
    aria-label="Cerca volontario"
  />
  <button id="btn-apri-form">‚ûï Aggiungi Volontario</button>

  <table aria-label="Elenco volontari">
    <thead>
      <tr>
        <th scope="col">Nome</th>
        <th scope="col">Cognome</th>
        <th scope="col">Codice Fiscale</th>
        <th scope="col">Telefono</th>
        <th scope="col">Azioni</th>
      </tr>
    </thead>
    <tbody id="volontari-list"></tbody>
  </table>
</main>

<!-- Form modale -->
<div id="form-container" aria-hidden="true">
  <div id="form-box" role="dialog" aria-modal="true" aria-labelledby="form-title">
    <button id="btn-chiudi-form" aria-label="Chiudi Modulo">&times;</button>
    <h2 id="form-title" style="color: var(--rosso-cri); margin-top:0;">Aggiungi Volontario</h2>
    <form id="volontari-form" autocomplete="off" novalidate>
      <div class="row">
        <input type="text" id="nome" name="nome" placeholder="Nome *" required />
        <input type="text" id="cognome" name="cognome" placeholder="Cognome *" required />
      </div>

      <div class="row">
        <input type="text" id="cf" name="cf" placeholder="Codice Fiscale *" maxlength="16" required />
        <input type="email" id="email" name="email" placeholder="üìß Email *" required />
      </div>

      <div class="row">
        <input type="tel" id="telefono" name="telefono" placeholder="üì± Telefono *" required />
        <input type="text" id="contattoEmergenza" name="contattoEmergenza" placeholder="üö® Contatto emergenza *" required />
      </div>

      <div class="row">
        <input type="text" id="luogoNascita" name="luogoNascita" placeholder="Luogo di nascita *" required />
        <input type="date" id="dataNascita" name="dataNascita" placeholder="Data di nascita *" required />
      </div>

      <div class="row">
        <input type="text" id="stato" name="stato" placeholder="Stato (es. Italia) *" required />
        <input type="text" id="indirizzo" name="indirizzo" placeholder="üè† Indirizzo *" required />
      </div>

      <div class="row">
        <input type="text" id="comune" name="comune" placeholder="Comune *" required />
        <input type="text" id="provincia" name="provincia" placeholder="Provincia *" required />
      </div>

      <div class="row">
        <input type="text" id="cap" name="cap" placeholder="CAP *" maxlength="5" required />
        <input type="text" id="comitato" name="comitato" placeholder="Comitato *" required />
      </div>

      <div class="row">
        <input type="text" id="intolleranze" name="intolleranze" placeholder="Intolleranze" />
        <input type="text" id="allergie" name="allergie" placeholder="Allergie" />
      </div>

      <div class="row">
        <input type="text" id="codiceMGO" name="codiceMGO" placeholder="Codice MGO" />
      </div>

      <fieldset class="qualifiche-container">
        <legend>üìã Qualifiche</legend>
        <label><input type="checkbox" class="qualifica-checkbox" value="AUTISTA SOCCORRITORE TSSA" /> AUTISTA SOCCORRITORE TSSA</label>
        <label><input type="checkbox" class="qualifica-checkbox" value="SOCCORRITORE TSSA" /> SOCCORRITORE TSSA</label>
        <label><input type="checkbox" class="qualifica-checkbox" value="TS" /> TS</label>
        <label><input type="checkbox" class="qualifica-checkbox" value="OPEM GENERICO" /> OPEM GENERICO</label>
        <label><input type="checkbox" class="qualifica-checkbox" value="OPEM LOGISTA" /> OPEM LOGISTA</label>
        <label><input type="checkbox" class="qualifica-checkbox" value="HACCP" /> HACCP</label>
        <label><input type="checkbox" class="qualifica-checkbox" value="OPERATORE TLC" /> OPERATORE TLC</label>
        <label><input type="checkbox" class="qualifica-checkbox" value="OPSA" /> OPSA</label>
        <label><input type="checkbox" class="qualifica-checkbox" value="SMTS" /> SMTS</label>
        <label><input type="checkbox" class="qualifica-checkbox" value="MEDICO" /> MEDICO</label>
        <label><input type="checkbox" class="qualifica-checkbox" value="INFERMIERE" /> INFERMIERE</label>
        <label><input type="checkbox" class="qualifica-checkbox" value="OPERATORE UAS (A1/A3-A2-STS)" /> OPERATORE UAS (A1/A3-A2-STS)</label>
        <label><input type="checkbox" class="qualifica-checkbox" value="OPERATORE SOCIALE GENERICO" /> OPERATORE SOCIALE GENERICO</label>
        <label><input type="checkbox" class="qualifica-checkbox" value="MEDIATORE LINGUISTICO" /> MEDIATORE LINGUISTICO</label>
        <label><input type="checkbox" class="qualifica-checkbox" value="CAE COORDINATORE ATTIVITA IN EMERGENZA" /> CAE COORDINATORE ATTIVITA IN EMERGENZA</label>
        <label><input type="checkbox" class="qualifica-checkbox" value="OPERATORE SOCIALE IN EMERGENZA" /> OPERATORE SOCIALE IN EMERGENZA</label>
      </fieldset>

      <fieldset class="patenti-container">
        <legend>üöó Patenti CRI</legend>
        <label><input type="checkbox" class="patenti-checkbox" value="PATENTE 1" /> PATENTE 1</label>
        <label><input type="checkbox" class="patenti-checkbox" value="PATENTE 2" /> PATENTE 2</label>
        <label><input type="checkbox" class="patenti-checkbox" value="PATENTE 2B" /> PATENTE 2B</label>
        <label><input type="checkbox" class="patenti-checkbox" value="PATENTE 3" /> PATENTE 3</label>
        <label><input type="checkbox" class="patenti-checkbox" value="PATENTE 4" /> PATENTE 4</label>
        <label><input type="checkbox" class="patenti-checkbox" value="PATENTE 5" /> PATENTE 5</label>
        <label><input type="checkbox" class="patenti-checkbox" value="PATENTE 5B" /> PATENTE 5B</label>
        <label><input type="checkbox" class="patenti-checkbox" value="PATENTE 6" /> PATENTE 6</label>
        <label><input type="checkbox" class="patenti-checkbox" value="PATENTE 7" /> PATENTE 7</label>
        <label><input type="checkbox" class="patenti-checkbox" value="PATENTE 7B" /> PATENTE 7B</label>
        <label><input type="checkbox" class="patenti-checkbox" value="PATENTE 8" /> PATENTE 8</label>
        <label><input type="checkbox" class="patenti-checkbox" value="PATENTE 9" /> PATENTE 9</label>
        <label><input type="checkbox" class="patenti-checkbox" value="NESSUNA" /> NESSUNA</label>
      </fieldset>

      <fieldset class="consenso-container">
        <legend>
          Autorizzo il trattamento dei miei dati personali ai sensi del regolamento (UE) 2016/679 (GDPR) e del D.196/2003 e s.m.i. Acconsento alla loro comunicazione alla Sala Operativa Provinciale di Pesaro e Urbino della Croce Rossa Italiana per le finalit√† indicate nei relativi moduli.
        </legend>
        <div class="consenso-checkbox-wrapper">
          <label>
            <input
              type="checkbox"
              id="consensoGdpr"
              name="consensoGdpr"
              required
            />
            Ho letto l'informativa privacy e acconsento al trattamento dei dati personali.
          </label>
        </div>
      </fieldset>

      <button type="submit" id="submit-btn">Aggiungi Volontario</button>
    </form>
  </div>
</div>

<!-- Popup info volontario -->
<div
  id="info-popup"
  role="dialog"
  aria-modal="true"
  aria-labelledby="info-title"
  aria-describedby="info-desc"
  tabindex="-1"
>
  <button id="info-close" aria-label="Chiudi dettagli volontario">&times;</button>
  <h3 id="info-title">üìã Dettagli Volontario</h3>
  <div id="info-content"></div>
</div>

<script>
const userId = localStorage.getItem("userId");
const role = localStorage.getItem("role");
const comitato = localStorage.getItem("comitato");

if (!userId) {
  alert("Devi effettuare il login");
  window.location.href = "login.html";
}

// LOGOUT
function logout() {
  localStorage.clear();
  window.location.href = "login.html";
}
document.getElementById("logout").onclick = logout;

// LOGO dinamico
const logoImg = document.getElementById("logo-cri");
let logoSrc = "logo.svg";

if (role === "sop" || role === "amministratore") {
  logoSrc = "logo-sop.svg";
} else if (role === "sol") {
  const c = (comitato || "").toLowerCase();
  if (c === "pesaro") logoSrc = "logo-pesaro.svg";
  else if (c === "urbino") logoSrc = "logo-urbino.svg";
  else if (c === "fano") logoSrc = "logo-fano.svg";
  else if (c === "pergola") logoSrc = "logo-pergola.svg";
  else if (c === "marotta-mondolfo") logoSrc = "logo-marotta-mondolfo.svg";
  else if (c === "fossombrone") logoSrc = "logo-fossombrone.svg";
  else if (c === "cagli") logoSrc = "logo-cagli.svg";
  else if (c === "montelabbate") logoSrc = "logo-montelabbate.svg";
  else if (c === "fermignano") logoSrc = "logo-fermignano.svg";
  else if (c === "sant'angelo in vado" || c === "santangelo in vado" || c === "sant-angelo-in-vado") {
    logoSrc = "logo-santangeloinvado.svg";
  } else {
    logoSrc = "logo-sop.svg";
  }
}
logoImg.src = logoSrc;

// MENU laterale CON ICONE
const menu = document.getElementById("menu-sidebar");
const menuItems = [
  { text: "üè† Home", href: "index.html" },
  { text: "‚úÖ Approvazioni", href: "iscrizioni-in-attesa.html" },
  { text: "üë• Volontari", href: "volontari.html" },
  { text: "üöó Mezzi", href: "mezzi.html" },
  { text: "üì¶ Materiali", href: "materiali.html" },
  { text: "üö® Emergenze", href: "emergenze.html" },
  { text: "üìÖ Eventi", href: "eventi.html" },
  { text: "üìÑ Documenti", href: "documenti.html" }
];

// SOP, Amministratore e SOL vedono Admin
if (role === "sop" || role === "amministratore" || role === "sol") {
  menuItems.push({ text: "‚öôÔ∏è Admin", href: "admin.html" });
}

menuItems.forEach(({ text, href }) => {
  const li = document.createElement("li");
  const a = document.createElement("a");
  a.href = href;
  a.textContent = text;
  if (text.includes("Volontari")) a.classList.add("active");
  li.appendChild(a);
  menu.appendChild(li);
});

const formContainer = document.getElementById("form-container");
const form = document.getElementById("volontari-form");
const list = document.getElementById("volontari-list");
const searchInput = document.getElementById("search");
const btnApriForm = document.getElementById("btn-apri-form");
const btnChiudiForm = document.getElementById("btn-chiudi-form");
const submitBtn = document.getElementById("submit-btn");
const infoPopup = document.getElementById("info-popup");
const infoContent = document.getElementById("info-content");
const infoClose = document.getElementById("info-close");

let editIndex = null;
let lastFocusedElement = null;

function getFocusableElements(container) {
  return container.querySelectorAll(
    'a[href], button:not([disabled]), textarea, input:not([disabled]), select, [tabindex]:not([tabindex="-1"])'
  );
}

function trapFocus(container, event) {
  const focusable = getFocusableElements(container);
  if (!focusable.length) return;
  const first = focusable[0];
  const last = focusable[focusable.length - 1];

  if (event.key === "Tab") {
    if (event.shiftKey) {
      if (document.activeElement === first) {
        last.focus();
        event.preventDefault();
      }
    } else {
      if (document.activeElement === last) {
        first.focus();
        event.preventDefault();
      }
    }
  }
}

function openDialog(container, firstFocusElement) {
  lastFocusedElement = document.activeElement;
  container.classList.add("active");
  container.setAttribute("aria-hidden", "false");

  if (firstFocusElement) {
    firstFocusElement.focus();
  } else {
    const focusable = getFocusableElements(container);
    if (focusable.length) focusable[0].focus();
  }

  document.addEventListener("keydown", dialogKeydownHandler);
}

function closeDialog(container) {
  container.classList.remove("active");
  container.setAttribute("aria-hidden", "true");
  document.removeEventListener("keydown", dialogKeydownHandler);

  if (lastFocusedElement && typeof lastFocusedElement.focus === "function") {
    lastFocusedElement.focus();
  }
}

function dialogKeydownHandler(e) {
  if (formContainer.classList.contains("active")) {
    trapFocus(formContainer, e);
    if (e.key === "Escape") {
      toggleForm(false);
    }
  }
  if (infoPopup.classList.contains("active")) {
    trapFocus(infoPopup, e);
    if (e.key === "Escape") {
      hideInfoPopup();
    }
  }
}

function toggleForm(show) {
  if (show) {
    hideInfoPopup();
    openDialog(formContainer, form.nome);
    submitBtn.textContent = editIndex === null ? "Aggiungi Volontario" : "Salva Modifiche";
  } else {
    closeDialog(formContainer);
    form.reset();
    form.comitato.removeAttribute('readonly');
    editIndex = null;
    submitBtn.textContent = "Aggiungi Volontario";
  }
}

btnApriForm.addEventListener("click", () => {
  if (role === "sol") {
    form.comitato.value = comitato || "";
    form.comitato.setAttribute('readonly', true);
  }
  toggleForm(true);
});

btnChiudiForm.addEventListener("click", () => toggleForm(false));

// volontari visibili: SOP/amministratore tutti, SOL solo proprio comitato
function getVisibleVolontari() {
  const locali = JSON.parse(localStorage.getItem("volontari") || "[]");
  if (role === "sop" || role === "amministratore") return locali;

  if (role === "sol") {
    const c = (comitato || "").toLowerCase();
    if (!c) return locali;
    return locali.filter(v => (v.comitato || "").toLowerCase() === c);
  }
  return locali;
}

function showInfoPopup(volontario) {
  const dataRaw = volontario.dataNascita;
  let dataFormatted = dataRaw;
  if (dataRaw) {
    const parts = dataRaw.split("-");
    if (parts.length === 3) {
      dataFormatted = parts[2] + "/" + parts[1] + "/" + parts[0];
    }
  }
  
  // ‚úÖ Layout migliorato con div strutturate
  const dettagli = `
<div><span class="info-label">Nome:</span><span class="info-value">${volontario.nome || ''}</span></div>
<div><span class="info-label">Cognome:</span><span class="info-value">${volontario.cognome || ''}</span></div>
<div><span class="info-label">Codice Fiscale:</span><span class="info-value">${volontario.cf || ''}</span></div>
<div><span class="info-label">üìß Email:</span><span class="info-value">${volontario.email || 'Non inserita'}</span></div>
<div><span class="info-label">üì± Telefono:</span><span class="info-value">${volontario.telefono || ''}</span></div>
<div><span class="info-label">üö® Contatto Emergenza:</span><span class="info-value">${volontario.contattoEmergenza || ''}</span></div>
<div><span class="info-label">Luogo di nascita:</span><span class="info-value">${volontario.luogoNascita || ''}</span></div>
<div><span class="info-label">Data di nascita:</span><span class="info-value">${dataFormatted || ''}</span></div>
<div><span class="info-label">Stato:</span><span class="info-value">${volontario.stato || 'Italia'}</span></div>
<div><span class="info-label">üè† Indirizzo:</span><span class="info-value">${volontario.indirizzo || ''}</span></div>
<div><span class="info-label">Comune:</span><span class="info-value">${volontario.comune || ''}</span></div>
<div><span class="info-label">Provincia:</span><span class="info-value">${volontario.provincia || ''}</span></div>
<div><span class="info-label">CAP:</span><span class="info-value">${volontario.cap || ''}</span></div>
<div><span class="info-label">Comitato:</span><span class="info-value">${volontario.comitato || ''}</span></div>
<div><span class="info-label">Intolleranze:</span><span class="info-value">${volontario.intolleranze || "Nessuna"}</span></div>
<div><span class="info-label">Allergie:</span><span class="info-value">${volontario.allergie || "Nessuna"}</span></div>
<div><span class="info-label">Codice MGO:</span><span class="info-value">${volontario.codiceMGO || "Non inserito"}</span></div>
<div><span class="info-label">üìã Qualifiche:</span><span class="info-value">${volontario.qualifiche ? volontario.qualifiche.join(", ") : "Nessuna"}</span></div>
<div><span class="info-label">üöó Patenti:</span><span class="info-value">${(volontario.patenti || []).join(", ") || "Nessuna"}</span></div>
<div><span class="info-label">Consenso GDPR:</span><span class="info-value">${volontario.consensoGdpr ? "‚úÖ SI" : "‚ùå NO"}</span></div>
  `;
  infoContent.innerHTML = dettagli;
  openDialog(infoPopup);
}

function hideInfoPopup() {
  closeDialog(infoPopup);
}

infoClose.addEventListener("click", hideInfoPopup);

function escapeHtml(text) {
  if (!text) return "";
  return text.replace(/[&<>"']/g, match => {
    const escapeMap = {
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      '"': "&quot;",
      "'": "&#39;",
    };
    return escapeMap[match];
  });
}

function renderVolontari() {
  const filter = searchInput.value.trim().toLowerCase();
  list.innerHTML = "";
  
  const visibili = getVisibleVolontari();
  const tutti = JSON.parse(localStorage.getItem("volontari") || "[]");
  
  visibili
    .filter(v =>
      (v.nome || '').toLowerCase().includes(filter) ||
      (v.cognome || '').toLowerCase().includes(filter) ||
      (v.cf || '').toLowerCase().includes(filter) ||
      (v.email || '').toLowerCase().includes(filter)
    )
    .forEach(v => {
      // ‚úÖ Trova l'indice globale
      const globalIndex = tutti.findIndex(vol => vol.cf === v.cf);
      
      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${escapeHtml(v.nome)}</td>
        <td>${escapeHtml(v.cognome)}</td>
        <td>${escapeHtml(v.cf)}</td>
        <td>${escapeHtml(v.telefono)}</td>
        <td>
          <button type="button" class="action-btn edit-btn" aria-label="Modifica ${escapeHtml(v.nome)} ${escapeHtml(v.cognome)}" onclick="editVolontario(${globalIndex})">‚úèÔ∏è Modifica</button>
          <button type="button" class="action-btn delete-btn" aria-label="Elimina ${escapeHtml(v.nome)} ${escapeHtml(v.cognome)}" onclick="deleteVolontario(${globalIndex})">üóëÔ∏è Elimina</button>
          <button type="button" class="action-btn info-btn" aria-label="Info ${escapeHtml(v.nome)} ${escapeHtml(v.cognome)}" onclick="showInfoPopupByIndex(${globalIndex})">‚ÑπÔ∏è Info</button>
        </td>
      `;
      list.appendChild(row);
    });
}

form.addEventListener("submit", e => {
  e.preventDefault();

  if (!form.checkValidity()) {
    form.reportValidity();
    return;
  }

  const telefono = form.telefono.value.trim();
  const contattoEmergenza = form.contattoEmergenza.value.trim();
  if (telefono && contattoEmergenza && telefono === contattoEmergenza) {
    alert("‚ùå Il numero di telefono e il contatto di emergenza devono essere DIVERSI!");
    form.telefono.focus();
    return;
  }

  const nuovoVolontario = {
    nome: form.nome.value.trim(),
    cognome: form.cognome.value.trim(),
    cf: form.cf.value.trim().toUpperCase(),
    email: form.email.value.trim().toLowerCase(),
    telefono,
    contattoEmergenza,
    luogoNascita: form.luogoNascita.value.trim(),
    dataNascita: form.dataNascita.value,
    stato: form.stato.value.trim(),
    indirizzo: form.indirizzo.value.trim(),
    comune: form.comune.value.trim(),
    provincia: form.provincia.value.trim(),
    cap: form.cap.value.trim(),
    comitato: form.comitato.value.trim(),
    intolleranze: form.intolleranze.value.trim(),
    allergie: form.allergie.value.trim(),
    codiceMGO: form.codiceMGO.value.trim(),
    qualifiche: Array.from(form.querySelectorAll(".qualifica-checkbox:checked")).map(cb => cb.value),
    patenti: Array.from(form.querySelectorAll(".patenti-checkbox:checked")).map(cb => cb.value),
    consensoGdpr: form.consensoGdpr.checked
  };

  const locali = JSON.parse(localStorage.getItem("volontari") || "[]");
  const duplicateIndex = locali.findIndex((v, idx) => v.cf === nuovoVolontario.cf && idx !== editIndex);

  if (duplicateIndex !== -1) {
    alert("‚ùå Errore: codice fiscale gi√† presente per un altro volontario!");
    return;
  }

  if (editIndex === null) {
    locali.push(nuovoVolontario);
  } else {
    locali[editIndex] = nuovoVolontario;
    editIndex = null;
    submitBtn.textContent = "Aggiungi Volontario";
  }

  localStorage.setItem("volontari", JSON.stringify(locali));
  toggleForm(false);
  renderVolontari();
});

window.editVolontario = function(index){
  const locali = JSON.parse(localStorage.getItem("volontari") || "[]");
  const v = locali[index];
  editIndex = index;
  submitBtn.textContent = "Salva Modifiche";

  form.nome.value = v.nome || "";
  form.cognome.value = v.cognome || "";
  form.cf.value = v.cf || "";
  form.email.value = v.email || "";
  form.telefono.value = v.telefono || "";
  form.contattoEmergenza.value = v.contattoEmergenza || "";
  form.luogoNascita.value = v.luogoNascita || "";
  form.dataNascita.value = v.dataNascita || "";
  form.stato.value = v.stato || "";
  form.indirizzo.value = v.indirizzo || "";
  form.comune.value = v.comune || "";
  form.provincia.value = v.provincia || "";
  form.cap.value = v.cap || "";
  form.comitato.value = v.comitato || "";
  form.intolleranze.value = v.intolleranze || "";
  form.allergie.value = v.allergie || "";
  form.codiceMGO.value = v.codiceMGO || "";
  form.consensoGdpr.checked = !!v.consensoGdpr;

  if (role === "sol") {
    form.comitato.setAttribute('readonly', true);
  } else {
    form.comitato.removeAttribute('readonly');
  }

  form.querySelectorAll(".qualifica-checkbox").forEach(cb => {
    cb.checked = v.qualifiche?.includes(cb.value) || false;
  });

  form.querySelectorAll(".patenti-checkbox").forEach(cb => {
    cb.checked = v.patenti?.includes(cb.value) || false;
  });

  toggleForm(true);
};

window.deleteVolontario = function(index){
  const locali = JSON.parse(localStorage.getItem("volontari") || "[]");
  const v = locali[index];
  if(confirm(`üóëÔ∏è Sei sicuro di voler eliminare:\n\n${v.nome} ${v.cognome}\nCF: ${v.cf}\n\n‚ö†Ô∏è Questa azione √® irreversibile!`)){
    locali.splice(index,1);
    localStorage.setItem("volontari", JSON.stringify(locali));
    renderVolontari();
    if(editIndex === index){
      toggleForm(false);
      editIndex = null;
      submitBtn.textContent = "Aggiungi Volontario";
    }
  }
};

window.showInfoPopupByIndex = function(index){
  const locali = JSON.parse(localStorage.getItem("volontari") || "[]");
  const v = locali[index];
  if(!v) return;
  showInfoPopup(v);
};

searchInput.addEventListener("input", renderVolontari);
renderVolontari();
</script>
</body>
</html>
