<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<title>Area Admin - CRI</title>

<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#b71c1c">

<style>
  :root {
    --rosso-cri: #b71c1c;
    --bianco: #ffffff;
    --grigio: #f5f5f5;

    /* solo per grafica contenuti (non sidebar) */
    --blu: #2196f3;
    --verde: #4caf50;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  /* ‚úÖ layout: scroll SOLO nel main (sidebar ferma) */
  html, body { height: 100%; }
  body {
    font-family: Arial, sans-serif;
    display: flex;
    background: var(--grigio);
    overflow: hidden; /* ‚úÖ evita lo scroll della pagina: scrolla solo il main */
  }

  /* ‚úÖ SIDEBAR IDENTICA A index.html, ma FISSA */
  .sidebar {
    position: fixed;
    left: 0; top: 0;
    width: 260px;
    height: 100vh;
    background: var(--rosso-cri);
    color: var(--bianco);
    display: flex;
    flex-direction: column;
    padding-top: 20px;
    overflow: hidden;     /* ‚úÖ niente scroll sulla sidebar intera */
    align-items: center;
    z-index: 1000;
  }
  .sidebar img {
    width: 220px;
    margin-bottom: 20px;
    border-radius: 8px;
    flex-shrink: 0;
  }

  /* ‚úÖ scroll SOLO nel menu (quando ci passi sopra col mouse) */
  .menu {
    list-style: none;
    padding: 0;
    width: 100%;
    flex-grow: 1;
    overflow-y: auto;
    overscroll-behavior: contain;
    overflow-x: hidden;
  }
  .menu li { width: 100%; }
  .menu a {
    display: block;
    padding: 15px 20px;
    color: var(--bianco);
    text-decoration: none;
    font-weight: bold;
  }
  .menu a:hover, .menu a.active { background: #9f1b1b; }

  #logout {
    flex-shrink: 0;
    margin: 12px auto 20px auto;
    padding: 10px 20px;
    width: 80%;
    background-color: #fff;
    color: var(--rosso-cri);
    border: 2px solid var(--rosso-cri);
    border-radius: 6px;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.3s, color 0.3s;
  }
  #logout:hover { background-color: var(--rosso-cri); color: #fff; }

  /* ‚úÖ MAIN: scroll interno */
  .main {
    margin-left: 260px;      /* spazio sidebar fissa */
    width: calc(100% - 260px);
    height: 100vh;
    padding: 30px;
    background: var(--bianco);
    overflow-y: auto;        /* ‚úÖ scroll qui */
    position: relative;
  }

  .main h1 {
    color: var(--rosso-cri);
    margin: 0 0 20px 0;
    font-size: 2rem;
  }

  /* ====== GRAFICA CONTENUTO ====== */
  .cards {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(340px, 1fr));
    gap: 25px;
    margin-top: 10px;
  }

  .card {
    background: rgba(255,255,255,0.95);
    border-radius: 20px;
    padding: 30px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.10);
    border: 1px solid rgba(0,0,0,0.05);
    transition: all 0.25s ease;
    position: relative;
    overflow: hidden;
  }
  .card::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0;
    height: 5px;
    background: linear-gradient(90deg, var(--rosso-cri), var(--blu));
  }
  .card:hover {
    transform: translateY(-6px);
    box-shadow: 0 20px 60px rgba(0,0,0,0.13);
  }

  .card h2 {
    margin: 0 0 14px 0;
    color: var(--rosso-cri);
    font-size: 1.35rem;
    font-weight: 800;
    display: flex;
    align-items: center;
    gap: 10px;
  }

  .card p {
    line-height: 1.7;
    color: #444;
    margin-bottom: 12px;
  }

  .stat-number {
    font-size: 3rem;
    font-weight: 900;
    background: linear-gradient(45deg, var(--rosso-cri), var(--blu));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    margin: 10px 0 6px;
    line-height: 1;
  }

  .stat-label {
    font-size: 1rem;
    color: #666;
    font-weight: 600;
    margin-bottom: 8px;
  }

  .btn-admin {
    display: inline-flex;
    align-items: center;
    gap: 8px;
    margin-top: 8px;
    padding: 12px 22px;
    background: linear-gradient(45deg, var(--rosso-cri), #d32f2f);
    color: #fff;
    border-radius: 999px;
    text-decoration: none;
    font-weight: 800;
    transition: all 0.25s ease;
    box-shadow: 0 4px 15px rgba(183,28,28,0.25);
    border: 0;
  }
  .btn-admin:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(183,28,28,0.35);
  }

  @media (max-width: 768px) {
    body { flex-direction: column; overflow: auto; } /* su mobile scroll normale */
    .sidebar { position: relative; width: 100%; height: auto; padding: 15px; overflow: visible; }
    .menu { overflow: visible; }
    .main { margin-left: 0; width: 100%; height: auto; padding: 20px; overflow: visible; }
    .cards { grid-template-columns: 1fr; gap: 18px; }
  }

  /* =========================
     POPUP RUOLI (solo Admin)
  ========================= */
  #ruoli-popup{
    position:fixed; inset:0;
    background: rgba(0,0,0,0.55);
    display:none;
    align-items:center;
    justify-content:center;
    z-index: 3000;
  }
  #ruoli-popup.active{ display:flex; }
  #ruoli-box{
    background:#fff;
    width: 980px;
    max-width: 95%;
    border-radius: 12px;
    overflow:hidden;
    box-shadow: 0 20px 50px rgba(0,0,0,0.4);
  }
  #ruoli-header{
    background: var(--rosso-cri);
    color:#fff;
    padding: 16px 20px;
    display:flex;
    align-items:flex-start;
    justify-content: space-between;
    gap: 14px;
  }
  #ruoli-close{
    background: rgba(255,255,255,0.2);
    border:none;
    color:#fff;
    font-size:1.6rem;
    width:40px;
    height:40px;
    border-radius:999px;
    cursor:pointer;
    flex: 0 0 auto;
  }
  #ruoli-close:hover{ background: rgba(255,255,255,0.28); }
  #ruoli-content{
    padding: 18px 20px 20px;
    max-height: 75vh;
    overflow:auto;
  }
  .ruoli-table{
    width:100%;
    border-collapse: collapse;
    min-width: 720px;
  }
  .ruoli-table th, .ruoli-table td{
    border: 1px solid #ddd;
    padding: 10px;
    text-align:left;
    vertical-align: middle;
  }
  .ruoli-table th{ background:#f3f3f3; color:#333; }
  .select-role{
    padding: 8px 10px;
    border: 1px solid #ccc;
    border-radius: 8px;
    font-weight: 700;
  }
  .btn-small{
    padding: 8px 12px;
    border:none;
    border-radius: 8px;
    cursor:pointer;
    font-weight: 800;
    margin-right: 8px;
  }
  .btn-save{ background:#28a745; color:#fff; }
  .btn-reset{ background:#6c757d; color:#fff; }
  @media (max-width: 768px){
    .ruoli-table{ min-width: 0; }
  }
</style>
</head>

<body>
<aside class="sidebar" aria-label="Navigazione principale">
  <img id="logo-cri" src="logo.svg" alt="Logo Croce Rossa Italiana" />
  <ul class="menu" id="menu-sidebar"></ul>
  <button id="logout" type="button">Logout</button>
</aside>

<main class="main" tabindex="-1">
  <h1 id="page-title">‚öôÔ∏è Area Amministratore</h1>

  <div class="cards">
    <div class="card">
      <h2>üìã Iscrizioni in attesa</h2>
      <p>Candidature inserite dal form pubblico, in attesa di approvazione.</p>
      <div class="stat-number" id="num-iscrizioni">0</div>
      <div class="stat-label">candidature da approvare</div>
      <a href="iscrizioni-in-attesa.html" class="btn-admin">üìù Gestisci iscrizioni</a>
    </div>

    <div class="card">
      <h2>üë• Volontari attivi</h2>
      <p>Totale volontari registrati e approvati nel sistema.</p>
      <div class="stat-number" id="num-volontari">0</div>
      <div class="stat-label">volontari gestiti</div>
      <a href="volontari.html" class="btn-admin">üëÄ Vedi volontari</a>
    </div>

    <div class="card">
      <h2>üöó Mezzi disponibili</h2>
      <p>Veicoli e mezzi operativi registrati.</p>
      <div class="stat-number" id="num-mezzi">0</div>
      <div class="stat-label">mezzi in flotta</div>
      <a href="mezzi.html" class="btn-admin">üîß Gestisci mezzi</a>
    </div>

    <div class="card">
      <h2>üì¶ Materiali</h2>
      <p>Inventario materiali e attrezzature disponibili.</p>
      <div class="stat-number" id="num-materiali">0</div>
      <div class="stat-label">materiali registrati</div>
      <a href="materiali.html" class="btn-admin">üìã Gestisci materiali</a>
    </div>

    <div class="card">
      <h2>üö® Emergenze attive</h2>
      <p>Interventi di emergenza attualmente in corso.</p>
      <div class="stat-number" id="num-emergenze">0</div>
      <div class="stat-label">emergenze in corso</div>
      <a href="emergenze.html" class="btn-admin">üö® Vedi emergenze</a>
    </div>

    <div class="card">
      <h2>üìÖ Eventi programmati</h2>
      <p>Eventi e attivit√† in calendario.</p>
      <div class="stat-number" id="num-eventi">0</div>
      <div class="stat-label">eventi pianificati</div>
      <a href="eventi.html" class="btn-admin">üìÖ Vedi eventi</a>
    </div>

    <div class="card">
      <h2>üì° Timbrature TLC</h2>
      <p>Timbrature ore TLC in attesa di approvazione da parte degli operatori.</p>
      <div class="stat-number" id="num-timbrature-tlc">0</div>
      <div class="stat-label">timbrature da confermare</div>
      <a href="tlc.html" class="btn-admin">‚è±Ô∏è Gestisci timbrature TLC</a>
    </div>

    <div class="card">
      <h2>‚è±Ô∏è Ore TLC Totali</h2>
      <p>Totale ore TLC approvate da tutti gli operatori.</p>
      <div class="stat-number" id="totale-ore-tlc">0</div>
      <div class="stat-label">ore totali confermate</div>
      <a href="tlc.html#timbrature-section" class="btn-admin">üìä Vedi dettaglio</a>
    </div>

    <!-- ‚úÖ RUOLI INFONDO (solo Admin) -->
    <div class="card" id="card-ruoli" style="display:none;">
      <h2>üõ°Ô∏è Ruoli</h2>
      <p>Gestisci i ruoli assegnati (SOL / SOP / Admin / TLC Provinciale).</p>
      <div class="stat-number" id="num-ruoli-speciali">0</div>
      <div class="stat-label">utenti con ruolo speciale</div>
      <button type="button" class="btn-admin" id="btn-apri-ruoli" style="border:none;cursor:pointer;">üë• Apri gestione ruoli</button>
    </div>
  </div>
</main>

<!-- POPUP RUOLI (solo Admin) -->
<div id="ruoli-popup" aria-hidden="true">
  <div id="ruoli-box" role="dialog" aria-modal="true" aria-labelledby="ruoli-title">
    <div id="ruoli-header">
      <div>
        <h3 id="ruoli-title" style="margin:0;font-size:1.2rem;">üõ°Ô∏è Gestione Ruoli</h3>
        <div id="ruoli-summary" style="margin-top:6px;font-weight:700;"></div>
      </div>
      <button id="ruoli-close" type="button" aria-label="Chiudi">&times;</button>
    </div>

    <div id="ruoli-content">
      <p style="margin:0 0 12px;color:#666;">
        Qui vedi tutti gli utenti con ruoli speciali e puoi modificarli. (Non mostriamo il CF.)
      </p>

      <div style="overflow:auto;">
        <table class="ruoli-table" aria-label="Ruoli assegnati">
          <thead>
            <tr>
              <th>Nome</th>
              <th>Comitato</th>
              <th>Ruolo</th>
              <th>Azioni</th>
            </tr>
          </thead>
          <tbody id="ruoli-body"></tbody>
        </table>
      </div>

      <div id="ruoli-empty-hint" style="display:none;margin-top:12px;color:#666;">
        Nessun ruolo speciale trovato nei dati attuali. Se i ruoli sono gestiti da un file di login esterno, inviamelo e lo colleghiamo.
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener("DOMContentLoaded", () => {
  const userId = localStorage.getItem("userId");
  const role = (localStorage.getItem("role") || "").toLowerCase().trim();
  const comitato = localStorage.getItem("comitato") || "";

  // ‚úÖ Accesso: SOP, Amministratore e SOL
  if (!userId || (role !== "sop" && role !== "amministratore" && role !== "sol")) {
    alert("Accesso riservato a SOP / SOL / Amministratore");
    window.location.href = "login.html";
    return;
  }

  const normalize = (s) => (s || "").toString().toLowerCase().trim();

  // ‚úÖ LOGO (uguale a index.html)
  const logoImg = document.getElementById("logo-cri");
  let logoSrc = "logo.svg";

  if (role === "sol") {
    const c = normalize(comitato);
    const map = {
      "pesaro": "logo-pesaro.svg",
      "urbino": "logo-urbino.svg",
      "fano": "logo-fano.svg",
      "pergola": "logo-pergola.svg",
      "marotta-mondolfo": "logo-marotta-mondolfo.svg",
      "fossombrone": "logo-fossombrone.svg",
      "cagli": "logo-cagli.svg",
      "montelabbate": "logo-montelabbate.svg",
      "fermignano": "logo-fermignano.svg",
      "sant'angelo in vado": "logo-santangeloinvado.svg",
      "santangelo in vado": "logo-santangeloinvado.svg",
      "sant-angelo-in-vado": "logo-santangeloinvado.svg"
    };
    logoSrc = map[c] || "logo-sop.svg";
  } else if (role === "sop" || role === "amministratore" || role === "tlc_provinciale") {
    logoSrc = "logo-sop.svg";
  }

  logoImg.src = logoSrc;
  logoImg.onerror = () => { logoImg.src = "logo-sop.svg"; };

  // Titolo
  const pageTitle = document.getElementById("page-title");
  if (role === "sop" || role === "amministratore") {
    pageTitle.textContent = "‚öôÔ∏è Area Admin - SOP Provinciale";
  } else if (role === "sol") {
    pageTitle.textContent = `‚öôÔ∏è Area Admin - SOL ${comitato}`;
  }

  // Logout
  document.getElementById("logout").addEventListener("click", () => {
    localStorage.clear();
    window.location.href = "login.html";
  });

  // ‚úÖ MENU IDENTICO A index.html
  const menu = document.getElementById("menu-sidebar");
  menu.innerHTML = "";

  const items = [
    { text: "üè† Home", href: "index.html" },
    { text: "‚úÖ Approvazioni", href: "iscrizioni-in-attesa.html" },
    { text: "üë• Volontari", href: "volontari.html" },
    { text: "üöó Mezzi", href: "mezzi.html" },
    { text: "üì¶ Materiali", href: "materiali.html" },
    { text: "üö® Emergenze", href: "emergenze.html" },
    { text: "üìÖ Eventi", href: "eventi.html" },
    { text: "üìÑ Documenti", href: "documenti.html" }
  ];

  if (["sop", "sol", "amministratore", "tlc_provinciale"].includes(role)) {
    items.push({ text: "üì° TLC", href: "tlc.html" });
  }
  if (["sop", "sol", "amministratore"].includes(role)) {
    items.push({ text: "‚öôÔ∏è Admin", href: "admin.html" });
  }

  items.forEach(({ text, href }) => {
    const li = document.createElement("li");
    const a = document.createElement("a");
    a.href = href;
    a.textContent = text;
    if (href === "admin.html") a.classList.add("active");
    li.appendChild(a);
    menu.appendChild(li);
  });

  /* =========================
     RUOLI (solo Admin)
  ========================= */
  const safeParse = (key, fallback) => {
    try {
      const raw = localStorage.getItem(key);
      if (!raw) return fallback;
      return JSON.parse(raw);
    } catch { return fallback; }
  };
  const escapeHtml = (t) => (t == null ? "" : String(t).replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m])));

  function normalizeRoleValue(r) {
    const x = normalize(r);
    if (!x) return "volontario";
    if (x === "admin") return "amministratore";
    if (x === "tlc provinciale" || x === "tlc-provinciale" || x === "tlcprovinciale") return "tlc_provinciale";
    return x;
  }

  const ruoloMapKey = "cri_ruoli_map";
  function loadRuoliMap() { return safeParse(ruoloMapKey, {}) || {}; }
  function saveRuoliMap(m) { localStorage.setItem(ruoloMapKey, JSON.stringify(m || {})); }

  function pickId(obj) {
    return ((obj?.cf || obj?.userId || obj?.username || obj?.email || obj?.id || "") + "").toUpperCase().trim();
  }
  function pickNome(obj) {
    const n = `${obj?.nome || ""} ${obj?.cognome || ""}`.trim();
    return n || (obj?.nomeCompleto || obj?.name || obj?.displayName || "‚Äî");
  }
  function pickComitato(obj) {
    return obj?.comitato || obj?.comitatoCreatore || obj?.comitatoEvento || obj?.comitato_volontario || obj?.comitatoVolontario || obj?.comitatoOrigine || obj?.comitato_origine || "‚Äî";
  }
  function pickRawRole(obj) {
    return obj?.ruolo || obj?.role || obj?.ruoloSistema || obj?.ruoloUtente || obj?.privilegio || obj?.permessi || "";
  }

  function scanLocalStorageArraysForUsers() {
    const out = [];
    for (let i = 0; i < localStorage.length; i++) {
      const k = localStorage.key(i);
      if (!k) continue;
      if (/^(mezzi|materiali|eventi|emergenze|timbrature|volontari|volontari-pubblici|cri_ruoli_map)/i.test(k)) continue;

      const val = safeParse(k, null);
      if (!Array.isArray(val)) continue;
      const cand = val.filter(x => x && typeof x === "object" && (pickId(x) || pickRawRole(x) || x.nome || x.cognome || x.comitato));
      if (!cand.length) continue;
      if (!cand.some(x => normalizeRoleValue(pickRawRole(x)) !== "volontario")) continue;
      out.push(...cand);
    }
    return out;
  }

  function collectRoleHolders() {
    const volontariAll = safeParse("volontari", []) || [];
    const rolesMap = loadRuoliMap();

    const candidates = [
      ...volontariAll,
      ...scanLocalStorageArraysForUsers(),
      { userId, nomeCompleto: localStorage.getItem("nomeCompleto") || "", comitato, role }
    ];

    const byId = new Map();
    candidates.forEach(obj => {
      const id = pickId(obj);
      if (!id) return;

      const mapEntry = rolesMap[id] || {};
      const raw = normalizeRoleValue(mapEntry.ruolo || pickRawRole(obj) || "");
      const nome = mapEntry.nome || pickNome(obj);
      const com = mapEntry.comitato || pickComitato(obj);

      const prev = byId.get(id);
      if (!prev) byId.set(id, { id, nome, comitato: com, rawRuolo: raw });
      else {
        const prevSpecial = prev.rawRuolo !== "volontario";
        const nowSpecial = raw !== "volontario";
        if (nowSpecial && !prevSpecial) byId.set(id, { id, nome, comitato: com, rawRuolo: raw });
      }
    });

    const allowed = new Set(["sol", "sop", "amministratore", "tlc_provinciale"]);
    return Array.from(byId.values())
      .filter(x => allowed.has(x.rawRuolo))
      .sort((a,b) =>
        a.rawRuolo.localeCompare(b.rawRuolo) ||
        String(a.comitato).localeCompare(String(b.comitato)) ||
        a.nome.localeCompare(b.nome)
      );
  }

  const cardRuoli = document.getElementById("card-ruoli");
  const btnApriRuoli = document.getElementById("btn-apri-ruoli");
  const numRuoliEl = document.getElementById("num-ruoli-speciali");

  const ruoliPopup = document.getElementById("ruoli-popup");
  const ruoliClose = document.getElementById("ruoli-close");
  const ruoliBody = document.getElementById("ruoli-body");
  const ruoliSummary = document.getElementById("ruoli-summary");
  const ruoliEmptyHint = document.getElementById("ruoli-empty-hint");

  function openRuoli() {
    ruoliPopup.classList.add("active");
    ruoliPopup.setAttribute("aria-hidden", "false");
  }
  function closeRuoli() {
    ruoliPopup.classList.remove("active");
    ruoliPopup.setAttribute("aria-hidden", "true");
  }

  function updateRoleForId(id, newRole) {
    const rolesMap = loadRuoliMap();
    const rid = (id || "").toUpperCase().trim();
    const r = normalizeRoleValue(newRole);

    if (r === "volontario") {
      delete rolesMap[rid];
    } else {
      const volontariAll = safeParse("volontari", []) || [];
      const v = volontariAll.find(x => pickId(x) === rid) || null;

      rolesMap[rid] = {
        ruolo: r,
        nome: pickNome(v || { userId: rid }),
        comitato: v ? pickComitato(v) : (rolesMap[rid]?.comitato || comitato || "‚Äî")
      };
    }
    saveRuoliMap(rolesMap);

    // compat: aggiorna anche volontari[] se esiste
    const volontariAll = safeParse("volontari", []) || [];
    const idx = volontariAll.findIndex(x => pickId(x) === rid);
    if (idx !== -1) {
      if (r === "volontario") {
        delete volontariAll[idx].ruolo;
        delete volontariAll[idx].role;
      } else {
        volontariAll[idx].ruolo = r;
        volontariAll[idx].role = r;
      }
      localStorage.setItem("volontari", JSON.stringify(volontariAll));
    }
  }

  function renderRuoliPopup() {
    const list = collectRoleHolders();
    if (numRuoliEl) numRuoliEl.textContent = String(list.length);

    const counts = { amministratore: 0, sop: 0, sol: 0, tlc_provinciale: 0 };
    list.forEach(x => { if (counts[x.rawRuolo] != null) counts[x.rawRuolo]++; });
    if (ruoliSummary) {
      ruoliSummary.textContent = `ADMIN: ${counts.amministratore} ‚Ä¢ SOP: ${counts.sop} ‚Ä¢ SOL: ${counts.sol} ‚Ä¢ TLC PROV: ${counts.tlc_provinciale}`;
    }

    if (!list.length) {
      ruoliBody.innerHTML = `<tr><td colspan="4" style="color:#666;">Nessun ruolo speciale assegnato.</td></tr>`;
      if (ruoliEmptyHint) ruoliEmptyHint.style.display = "block";
      return;
    }
    if (ruoliEmptyHint) ruoliEmptyHint.style.display = "none";

    const roleOptions = [
      { value: "volontario", label: "Volontario (nessun privilegio)" },
      { value: "sol", label: "SOL" },
      { value: "sop", label: "SOP" },
      { value: "amministratore", label: "Amministratore" },
      { value: "tlc_provinciale", label: "TLC Provinciale" }
    ];

    ruoliBody.innerHTML = list.map(u => {
      const current = normalizeRoleValue(u.rawRuolo);
      const opts = roleOptions.map(o => {
        const selected = current === normalizeRoleValue(o.value) ? "selected" : "";
        return `<option value="${o.value}" ${selected}>${o.label}</option>`;
      }).join("");

      return `
        <tr data-id="${escapeHtml(u.id)}" data-original="${escapeHtml(current)}">
          <td>${escapeHtml(u.nome)}</td>
          <td>${escapeHtml(u.comitato)}</td>
          <td><select class="select-role">${opts}</select></td>
          <td>
            <button type="button" class="btn-small btn-save" data-action="save">Salva</button>
            <button type="button" class="btn-small btn-reset" data-action="reset">Reset</button>
          </td>
        </tr>
      `;
    }).join("");

    ruoliBody.querySelectorAll("button[data-action]").forEach(btn => {
      btn.addEventListener("click", () => {
        const tr = btn.closest("tr");
        if (!tr) return;
        const id = tr.getAttribute("data-id");
        const sel = tr.querySelector("select");
        if (!sel) return;

        const action = btn.getAttribute("data-action");
        if (action === "reset") {
          sel.value = tr.getAttribute("data-original") || "volontario";
          return;
        }

        updateRoleForId(id, sel.value);
        renderRuoliPopup();
      });
    });
  }

  // Attiva card + popup solo se amministratore
  if (role === "amministratore") {
    cardRuoli.style.display = "block";
    btnApriRuoli.addEventListener("click", () => { renderRuoliPopup(); openRuoli(); });
    ruoliClose.addEventListener("click", closeRuoli);
    ruoliPopup.addEventListener("click", (e) => { if (e.target === ruoliPopup) closeRuoli(); });
  } else {
    cardRuoli.style.display = "none";
  }

  // ====== STATISTICHE ======
  let iscrizioni = JSON.parse(localStorage.getItem("volontari-pubblici") || "[]");
  if (role === "sol") {
    const c = normalize(comitato);
    iscrizioni = iscrizioni.filter(v => normalize(v.comitato) === c);
  }
  document.getElementById("num-iscrizioni").textContent = iscrizioni.length;

  let volontari = JSON.parse(localStorage.getItem("volontari") || "[]");
  if (role === "sol") {
    const c = normalize(comitato);
    volontari = volontari.filter(v => normalize(v.comitato) === c);
  }
  document.getElementById("num-volontari").textContent = volontari.length;

  let mezzi = JSON.parse(localStorage.getItem("mezzi") || "[]");
  if (role === "sol") {
    const c = normalize(comitato);
    mezzi = mezzi.filter(m => normalize(m.comitato) === c);
  }
  document.getElementById("num-mezzi").textContent = mezzi.length;

  let materiali = JSON.parse(localStorage.getItem("materiali") || "[]");
  if (role === "sol") {
    const c = normalize(comitato);
    materiali = materiali.filter(m => normalize(m.comitato) === c);
  }
  document.getElementById("num-materiali").textContent = materiali.length;

  let emergenze = JSON.parse(localStorage.getItem("emergenze") || "[]");
  if (role === "sol") {
    const c = normalize(comitato);
    emergenze = emergenze.filter(e => normalize(e.comitato) === c);
  }
  document.getElementById("num-emergenze").textContent = emergenze.length;

  let eventi = JSON.parse(localStorage.getItem("eventi") || "[]");
  if (role === "sol") {
    const c = normalize(comitato);
    eventi = eventi.filter(e => normalize(e.comitatoCreatore || e.comitato || "") === c);
  }
  document.getElementById("num-eventi").textContent = eventi.length;

  let timbratureTlc = JSON.parse(localStorage.getItem("timbrature-tlc") || "[]");
  const timbratureInAttesa = timbratureTlc.filter(t => (t.stato || "") === "attesa").length;
  document.getElementById("num-timbrature-tlc").textContent = timbratureInAttesa;

  function calcolaOre(inizio, fine) {
    if (!inizio || !fine) return 0;
    const [h1, m1] = String(inizio).split(':').map(Number);
    const [h2, m2] = String(fine).split(':').map(Number);
    if ([h1,m1,h2,m2].some(x => Number.isNaN(x))) return 0;
    const diffMin = (h2 * 60 + m2) - (h1 * 60 + m1);
    return Math.max(0, Math.floor(diffMin / 60));
  }

  const totaleOreApprovate = timbratureTlc
    .filter(t => (t.stato || "") === "approvato")
    .reduce((sum, t) => sum + calcolaOre(t.inizio, t.fine), 0);

  document.getElementById("totale-ore-tlc").textContent = totaleOreApprovate;
});
</script>
</body>
</html>
