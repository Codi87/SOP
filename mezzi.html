<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Gestione Mezzi - CRI</title>
<style>
  :root {
    --rosso-cri: #b71c1c;
    --bianco: #ffffff;
    --grigio: #f5f5f5;
    --blu-info: #007bff;
  }
  body {
    margin: 0;
    font-family: Arial, sans-serif;
    display: flex;
    min-height: 100vh;
    background: var(--grigio);
  }
  .sidebar {
    width: 260px;
    background: var(--rosso-cri);
    color: var(--bianco);
    display: flex;
    flex-direction: column;
    padding: 20px 0;
    height: 100vh;
    overflow-y: auto;
    align-items: center;
  }
  .sidebar img {
    width: 220px;
    margin-bottom: 20px;
    border-radius: 8px;
  }
  .menu {
    list-style: none;
    padding: 0;
    width: 100%;
    flex-grow: 1;
  }
  .menu li { width: 100%; }
  .menu a {
    display: block;
    padding: 15px 20px;
    color: var(--bianco);
    font-weight: bold;
    text-decoration: none;
  }
  .menu a:hover,
  .menu a.active {
    background: #9f1b1b;
  }
  #logout {
    margin: 20px auto 0 auto;
    padding: 10px 20px;
    width: 80%;
    background: var(--bianco);
    color: var(--rosso-cri);
    border: 2px solid var(--rosso-cri);
    border-radius: 6px;
    font-weight: bold;
    cursor: pointer;
    transition: background 0.3s, color 0.3s;
  }
  #logout:hover {
    background-color: var(--rosso-cri);
    color: var(--bianco);
  }
  .main {
    flex-grow: 1;
    background: var(--bianco);
    padding: 30px;
    overflow-y: auto;
    position: relative;
  }
  .main h1 {
    color: var(--rosso-cri);
    margin-top: 0;
  }
  #search {
    width: 100%;
    padding: 10px;
    margin-bottom: 20px;
    font-size: 1rem;
    border-radius: 5px;
    border: 1px solid #ccc;
  }
  #btn-apri-form {
    background: var(--rosso-cri);
    color: var(--bianco);
    border: none;
    padding: 12px 20px;
    border-radius: 5px;
    font-weight: bold;
    font-size: 1rem;
    cursor: pointer;
    margin-bottom: 20px;
    transition: background 0.3s;
  }
  #btn-apri-form:hover { background: #9f1b1b; }

  /* Modale form */
  #form-container {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    background: rgba(0,0,0,0.5);
    display: none;
    justify-content: center;
    align-items: center;
    z-index: 1000;
  }
  #form-container.active { display: flex; }
  #form-box {
    background: var(--grigio);
    max-width: 720px;
    width: 95%;
    border-radius: 8px;
    padding: 25px 30px;
    box-shadow: 0 0 10px rgba(0,0,0,0.25);
    max-height: 90vh;
    overflow-y: auto;
    position: relative;
  }
  #btn-chiudi-form {
    position: absolute;
    top: 12px;
    right: 15px;
    font-size: 2rem;
    background: none;
    border: none;
    color: var(--rosso-cri);
    cursor: pointer;
  }
  form .row {
    display: flex;
    flex-wrap: wrap;
    gap: 15px;
    margin-bottom: 10px;
  }
  form input,
  form select,
  form textarea {
    flex: 1 1 48%;
    padding: 8px;
    border-radius: 4px;
    border: 1px solid #ccc;
    font-size: 1rem;
  }
  form textarea {
    flex: 1 1 100%;
    min-height: 60px;
  }
  form input[readonly] {
    background-color: #e9ecef;
    color: #6c757d;
    cursor: not-allowed;
  }
  form button[type="submit"] {
    background: var(--rosso-cri);
    color: var(--bianco);
    border: none;
    padding: 12px 20px;
    border-radius: 5px;
    font-weight: bold;
    font-size: 1rem;
    cursor: pointer;
    transition: background 0.3s;
    margin-top: 10px;
  }
  form button[type="submit"]:hover { background: #9f1b1b; }

  table {
    width: 100%;
    border-collapse: collapse;
    max-width: 1200px;
  }
  table th,
  table td {
    border: 1px solid #ccc;
    padding: 10px;
    text-align: left;
    vertical-align: middle;
  }
  table th {
    background: var(--rosso-cri);
    color: var(--bianco);
  }
  .action-btn {
    cursor: pointer;
    padding: 6px 10px;
    margin: 0 2px;
    border: none;
    border-radius: 4px;
    font-weight: bold;
    font-size: 0.9rem;
  }
  .edit-btn {
    background-color: #ffc107;
    color: #000;
  }
  .delete-btn {
    background-color: #dc3545;
    color: #fff;
  }
  .info-btn {
    background-color: var(--blu-info);
    color: #fff;
  }

  /* Popup info mezzo */
  #info-popup {
    position: fixed;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 750px;
    max-width: 95%;
    max-height: 90vh;
    background: white;
    border-radius: 12px;
    box-shadow: 0 10px 50px rgba(0,0,0,0.4);
    display: none;
    z-index: 1100;
    overflow: hidden;
  }
  #info-popup.active { display: block; }
  #info-popup h3 {
    margin: 0;
    padding: 25px 30px;
    background: var(--rosso-cri);
    color: white;
    font-size: 1.4rem;
    border-radius: 12px 12px 0 0;
  }
  #info-content {
    padding: 25px 30px;
    font-size: 1rem;
    line-height: 2;
    color: #333;
    max-height: calc(90vh - 100px);
    overflow-y: auto;
  }
  #info-content > div {
    display: flex;
    padding: 12px 15px;
    border-radius: 6px;
    margin-bottom: 5px;
  }
  #info-content > div:nth-child(even) {
    background: #f8f9fa;
  }
  .info-label {
    color: var(--rosso-cri);
    font-weight: bold;
    min-width: 220px;
    flex-shrink: 0;
  }
  .info-value {
    color: #333;
    flex: 1;
  }
  #info-close {
    position: absolute;
    top: 20px;
    right: 25px;
    background: rgba(255,255,255,0.2);
    border: none;
    font-size: 1.8rem;
    color: white;
    cursor: pointer;
    width: 40px;
    height: 40px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.3s;
  }
  #info-close:hover {
    background: rgba(255,255,255,0.3);
    transform: rotate(90deg);
  }
</style>
</head>
<body>
<aside class="sidebar" aria-label="Navigazione principale">
  <img id="logo-cri" src="logo.svg" alt="Logo Croce Rossa Italiana" />
  <ul class="menu" id="menu-sidebar" role="navigation" aria-label="Menu principale"></ul>
  <button id="logout" type="button">üö™ Logout</button>
</aside>

<main class="main">
  <h1 id="pageTitle">üöó Gestione Mezzi</h1>
  <input
    type="search"
    id="search"
    placeholder="üîç Cerca per targa, tipo mezzo o comitato"
    aria-label="Cerca mezzo"
  />
  <button id="btn-apri-form">‚ûï Aggiungi Mezzo</button>

  <table aria-label="Elenco mezzi">
    <thead>
      <tr>
        <th scope="col">Targa</th>
        <th scope="col">Tipo Mezzo</th>
        <th scope="col">Comitato</th>
        <th scope="col">Posti</th>
        <th scope="col">Azioni</th>
      </tr>
    </thead>
    <tbody id="mezzi-list"></tbody>
  </table>
</main>

<!-- Form modale Mezzi -->
<div id="form-container" aria-hidden="true">
  <div id="form-box" role="dialog" aria-modal="true" aria-labelledby="form-title">
    <button id="btn-chiudi-form" aria-label="Chiudi Modulo">&times;</button>
    <h2 id="form-title" style="color: var(--rosso-cri); margin-top:0;">Aggiungi Mezzo</h2>
    <form id="mezzi-form" autocomplete="off" novalidate>
      <div class="row">
        <input type="text" id="targa" name="targa" placeholder="Targa *" required />
        <input type="text" id="tipoMezzo" name="tipoMezzo" placeholder="Tipo mezzo (es. Ambulanza A1, Autovettura, Furgone) *" required />
      </div>

      <div class="row">
        <input type="text" id="selettivaRadio" name="selettivaRadio" placeholder="Selettiva radio / nominativo (es. PS01) *" required />
        <input type="number" id="posti" name="posti" placeholder="Numero posti a bordo *" min="1" required />
      </div>

      <div class="row">
        <input type="text" id="comitato" name="comitato" placeholder="Comitato assegnatario *" required />
        <input type="text" id="sede" name="sede" placeholder="Sede / Distaccamento" />
      </div>

      <div class="row">
        <input type="date" id="dataImmatricolazione" name="dataImmatricolazione" placeholder="Data immatricolazione" />
        <input type="date" id="dataAssegnazione" name="dataAssegnazione" placeholder="Data assegnazione al comitato" />
      </div>

      <div class="row">
        <input type="text" id="categoriaCRI" name="categoriaCRI" placeholder="Categoria CRI (es. Ambulanza soccorso, Autovettura servizio)" />
        <input type="text" id="classeVeicolo" name="classeVeicolo" placeholder="Classe veicolo / omologazione" />
      </div>

      <div class="row">
        <input type="text" id="alimentazione" name="alimentazione" placeholder="Alimentazione (Diesel, Benzina, Ibrido, Elettrico)" />
        <input type="number" id="anno" name="anno" placeholder="Anno di costruzione" min="1950" max="2100" />
      </div>

      <div class="row">
        <input type="text" id="statoMezzo" name="statoMezzo" placeholder="Stato mezzo (In servizio, Fuori servizio, Manutenzione) *" required />
        <input type="text" id="telaio" name="telaio" placeholder="Numero di telaio" />
      </div>

      <div class="row">
        <textarea id="dotazioni" name="dotazioni" placeholder="Dotazioni principali (es. DAE, aspiratore, monitor, barella autocaricante)"></textarea>
      </div>

      <div class="row">
        <textarea id="note" name="note" placeholder="Note / annotazioni (es. limitazioni, turni dedicati, uso specifico)"></textarea>
      </div>

      <button type="submit" id="submit-btn">Aggiungi Mezzo</button>
    </form>
  </div>
</div>

<!-- Popup info mezzo -->
<div
  id="info-popup"
  role="dialog"
  aria-modal="true"
  aria-labelledby="info-title"
  aria-describedby="info-desc"
  tabindex="-1"
>
  <button id="info-close" aria-label="Chiudi dettagli mezzo">&times;</button>
  <h3 id="info-title">üöó Dettagli Mezzo</h3>
  <div id="info-content"></div>
</div>

<script>
const userId = localStorage.getItem("userId");
const role = localStorage.getItem("role");
const comitato = localStorage.getItem("comitato");

if (!userId) {
  alert("Devi effettuare il login");
  window.location.href = "login.html";
}

// LOGOUT
function logout() {
  localStorage.clear();
  window.location.href = "login.html";
}
document.getElementById("logout").onclick = logout;

// LOGO dinamico (stessa logica di volontari)
const logoImg = document.getElementById("logo-cri");
let logoSrc = "logo.svg";

if (role === "sop" || role === "amministratore") {
  logoSrc = "logo-sop.svg";
} else if (role === "sol") {
  const c = (comitato || "").toLowerCase();
  if (c === "pesaro") logoSrc = "logo-pesaro.svg";
  else if (c === "urbino") logoSrc = "logo-urbino.svg";
  else if (c === "fano") logoSrc = "logo-fano.svg";
  else if (c === "pergola") logoSrc = "logo-pergola.svg";
  else if (c === "marotta-mondolfo") logoSrc = "logo-marotta-mondolfo.svg";
  else if (c === "fossombrone") logoSrc = "logo-fossombrone.svg";
  else if (c === "cagli") logoSrc = "logo-cagli.svg";
  else if (c === "montelabbate") logoSrc = "logo-montelabbate.svg";
  else if (c === "fermignano") logoSrc = "logo-fermignano.svg";
  else if (c === "sant'angelo in vado" || c === "santangelo in vado" || c === "sant-angelo-in-vado") {
    logoSrc = "logo-santangeloinvado.svg";
  } else {
    logoSrc = "logo-sop.svg";
  }
}
logoImg.src = logoSrc;

// MENU laterale
const menu = document.getElementById("menu-sidebar");
const menuItems = [
  { text: "üè† Home", href: "index.html" },
  { text: "‚úÖ Approvazioni", href: "iscrizioni-in-attesa.html" },
  { text: "üë• Volontari", href: "volontari.html" },
  { text: "üöó Mezzi", href: "mezzi.html" },
  { text: "üì¶ Materiali", href: "materiali.html" },
  { text: "üö® Emergenze", href: "emergenze.html" },
  { text: "üìÖ Eventi", href: "eventi.html" },
  { text: "üìÑ Documenti", href: "documenti.html" }
];

if (role === "sop" || role === "amministratore" || role === "sol") {
  menuItems.push({ text: "‚öôÔ∏è Admin", href: "admin.html" });
}

menuItems.forEach(({ text, href }) => {
  const li = document.createElement("li");
  const a = document.createElement("a");
  a.href = href;
  a.textContent = text;
  if (text.includes("Mezzi")) a.classList.add("active");
  li.appendChild(a);
  menu.appendChild(li);
});

// Riferimenti DOM
const formContainer = document.getElementById("form-container");
const form = document.getElementById("mezzi-form");
const list = document.getElementById("mezzi-list");
const searchInput = document.getElementById("search");
const btnApriForm = document.getElementById("btn-apri-form");
const btnChiudiForm = document.getElementById("btn-chiudi-form");
const submitBtn = document.getElementById("submit-btn");
const infoPopup = document.getElementById("info-popup");
const infoContent = document.getElementById("info-content");
const infoClose = document.getElementById("info-close");

let editIndex = null;
let lastFocusedElement = null;

function getFocusableElements(container) {
  return container.querySelectorAll(
    'a[href], button:not([disabled]), textarea, input:not([disabled]), select, [tabindex]:not([tabindex="-1"])'
  );
}

function trapFocus(container, event) {
  const focusable = getFocusableElements(container);
  if (!focusable.length) return;
  const first = focusable[0];
  const last = focusable[focusable.length - 1];

  if (event.key === "Tab") {
    if (event.shiftKey) {
      if (document.activeElement === first) {
        last.focus();
        event.preventDefault();
      }
    } else {
      if (document.activeElement === last) {
        first.focus();
        event.preventDefault();
      }
    }
  }
}

function openDialog(container, firstFocusElement) {
  lastFocusedElement = document.activeElement;
  container.classList.add("active");
  container.setAttribute("aria-hidden", "false");

  if (firstFocusElement) {
    firstFocusElement.focus();
  } else {
    const focusable = getFocusableElements(container);
    if (focusable.length) focusable[0].focus();
  }

  document.addEventListener("keydown", dialogKeydownHandler);
}

function closeDialog(container) {
  container.classList.remove("active");
  container.setAttribute("aria-hidden", "true");
  document.removeEventListener("keydown", dialogKeydownHandler);

  if (lastFocusedElement && typeof lastFocusedElement.focus === "function") {
    lastFocusedElement.focus();
  }
}

function dialogKeydownHandler(e) {
  if (formContainer.classList.contains("active")) {
    trapFocus(formContainer, e);
    if (e.key === "Escape") {
      toggleForm(false);
    }
  }
  if (infoPopup.classList.contains("active")) {
    trapFocus(infoPopup, e);
    if (e.key === "Escape") {
      hideInfoPopup();
    }
  }
}

function toggleForm(show) {
  if (show) {
    hideInfoPopup();
    openDialog(formContainer, form.targa);
    submitBtn.textContent = editIndex === null ? "Aggiungi Mezzo" : "Salva Modifiche";
  } else {
    closeDialog(formContainer);
    form.reset();
    form.comitato.removeAttribute('readonly');
    editIndex = null;
    submitBtn.textContent = "Aggiungi Mezzo";
  }
}

btnApriForm.addEventListener("click", () => {
  if (role === "sol") {
    form.comitato.value = comitato || "";
    form.comitato.setAttribute('readonly', true);
  }
  toggleForm(true);
});

btnChiudiForm.addEventListener("click", () => toggleForm(false));

// mezzi visibili: SOP/amministratore tutti, SOL solo proprio comitato
function getVisibleMezzi() {
  const locali = JSON.parse(localStorage.getItem("mezzi") || "[]");
  if (role === "sop" || role === "amministratore") return locali;

  if (role === "sol") {
    const c = (comitato || "").toLowerCase();
    if (!c) return locali;
    return locali.filter(m => (m.comitato || "").toLowerCase() === c);
  }
  return locali;
}

function formatDate(itDate) {
  if (!itDate) return "";
  const parts = itDate.split("-");
  if (parts.length === 3) {
    return parts[2] + "/" + parts[1] + "/" + parts[0];
  }
  return itDate;
}

function showInfoPopup(mezzo) {
  const dettagli = `
<div><span class="info-label">Targa:</span><span class="info-value">${mezzo.targa || ""}</span></div>
<div><span class="info-label">Tipo mezzo:</span><span class="info-value">${mezzo.tipoMezzo || ""}</span></div>
<div><span class="info-label">Selettiva radio / nominativo:</span><span class="info-value">${mezzo.selettivaRadio || ""}</span></div>
<div><span class="info-label">Numero posti a bordo:</span><span class="info-value">${mezzo.posti || ""}</span></div>
<div><span class="info-label">Comitato assegnatario:</span><span class="info-value">${mezzo.comitato || ""}</span></div>
<div><span class="info-label">Sede / Distaccamento:</span><span class="info-value">${mezzo.sede || ""}</span></div>
<div><span class="info-label">Data immatricolazione:</span><span class="info-value">${formatDate(mezzo.dataImmatricolazione) || ""}</span></div>
<div><span class="info-label">Data assegnazione al comitato:</span><span class="info-value">${formatDate(mezzo.dataAssegnazione) || ""}</span></div>
<div><span class="info-label">Categoria CRI:</span><span class="info-value">${mezzo.categoriaCRI || ""}</span></div>
<div><span class="info-label">Classe veicolo / omologazione:</span><span class="info-value">${mezzo.classeVeicolo || ""}</span></div>
<div><span class="info-label">Alimentazione:</span><span class="info-value">${mezzo.alimentazione || ""}</span></div>
<div><span class="info-label">Anno di costruzione:</span><span class="info-value">${mezzo.anno || ""}</span></div>
<div><span class="info-label">Stato mezzo:</span><span class="info-value">${mezzo.statoMezzo || ""}</span></div>
<div><span class="info-label">Numero di telaio:</span><span class="info-value">${mezzo.telaio || ""}</span></div>
<div><span class="info-label">Dotazioni principali:</span><span class="info-value">${mezzo.dotazioni || "Non specificate"}</span></div>
<div><span class="info-label">Note / annotazioni:</span><span class="info-value">${mezzo.note || "Nessuna"}</span></div>
  `;
  infoContent.innerHTML = dettagli;
  openDialog(infoPopup);
}

function hideInfoPopup() {
  closeDialog(infoPopup);
}
infoClose.addEventListener("click", hideInfoPopup);

function escapeHtml(text) {
  if (!text) return "";
  return text.replace(/[&<>"']/g, match => {
    const escapeMap = {
      "&": "&amp;",
      "<": "&lt;",
      ">": "&gt;",
      '"': "&quot;",
      "'": "&#39;"
    };
    return escapeMap[match];
  });
}

function renderMezzi() {
  const filter = searchInput.value.trim().toLowerCase();
  list.innerHTML = "";

  const visibili = getVisibleMezzi();
  const tutti = JSON.parse(localStorage.getItem("mezzi") || "[]");

  visibili
    .filter(m =>
      (m.targa || "").toLowerCase().includes(filter) ||
      (m.tipoMezzo || "").toLowerCase().includes(filter) ||
      (m.comitato || "").toLowerCase().includes(filter) ||
      (m.selettivaRadio || "").toLowerCase().includes(filter)
    )
    .forEach(m => {
      const globalIndex = tutti.findIndex(me => me.targa === m.targa && me.selettivaRadio === m.selettivaRadio);

      const row = document.createElement("tr");
      row.innerHTML = `
        <td>${escapeHtml(m.targa)}</td>
        <td>${escapeHtml(m.tipoMezzo)}</td>
        <td>${escapeHtml(m.comitato)}</td>
        <td>${escapeHtml(String(m.posti || ""))}</td>
        <td>
          <button type="button" class="action-btn edit-btn" aria-label="Modifica mezzo ${escapeHtml(m.targa)}" onclick="editMezzo(${globalIndex})">‚úèÔ∏è Modifica</button>
          <button type="button" class="action-btn delete-btn" aria-label="Elimina mezzo ${escapeHtml(m.targa)}" onclick="deleteMezzo(${globalIndex})">üóëÔ∏è Elimina</button>
          <button type="button" class="action-btn info-btn" aria-label="Info mezzo ${escapeHtml(m.targa)}" onclick="showInfoPopupByIndex(${globalIndex})">‚ÑπÔ∏è Info</button>
        </td>
      `;
      list.appendChild(row);
    });
}

form.addEventListener("submit", e => {
  e.preventDefault();

  if (!form.checkValidity()) {
    form.reportValidity();
    return;
  }

  const nuovoMezzo = {
    targa: form.targa.value.trim().toUpperCase(),
    tipoMezzo: form.tipoMezzo.value.trim(),
    selettivaRadio: form.selettivaRadio.value.trim().toUpperCase(),
    posti: form.posti.value ? parseInt(form.posti.value, 10) : "",
    comitato: form.comitato.value.trim(),
    sede: form.sede.value.trim(),
    dataImmatricolazione: form.dataImmatricolazione.value,
    dataAssegnazione: form.dataAssegnazione.value,
    categoriaCRI: form.categoriaCRI.value.trim(),
    classeVeicolo: form.classeVeicolo.value.trim(),
    alimentazione: form.alimentazione.value.trim(),
    anno: form.anno.value ? parseInt(form.anno.value, 10) : "",
    statoMezzo: form.statoMezzo.value.trim(),
    telaio: form.telaio.value.trim(),
    dotazioni: form.dotazioni.value.trim(),
    note: form.note.value.trim()
  };

  const locali = JSON.parse(localStorage.getItem("mezzi") || "[]");

  // Evito doppioni targa + selettiva
  const duplicateIndex = locali.findIndex((m, idx) =>
    m.targa === nuovoMezzo.targa &&
    m.selettivaRadio === nuovoMezzo.selettivaRadio &&
    idx !== editIndex
  );

  if (duplicateIndex !== -1) {
    alert("‚ùå Errore: questo mezzo (targa + selettiva) √® gi√† presente!");
    return;
  }

  if (editIndex === null) {
    locali.push(nuovoMezzo);
  } else {
    locali[editIndex] = nuovoMezzo;
    editIndex = null;
    submitBtn.textContent = "Aggiungi Mezzo";
  }

  localStorage.setItem("mezzi", JSON.stringify(locali));
  toggleForm(false);
  renderMezzi();
});

window.editMezzo = function(index) {
  const locali = JSON.parse(localStorage.getItem("mezzi") || "[]");
  const m = locali[index];
  if (!m) return;
  editIndex = index;
  submitBtn.textContent = "Salva Modifiche";

  form.targa.value = m.targa || "";
  form.tipoMezzo.value = m.tipoMezzo || "";
  form.selettivaRadio.value = m.selettivaRadio || "";
  form.posti.value = m.posti || "";
  form.comitato.value = m.comitato || "";
  form.sede.value = m.sede || "";
  form.dataImmatricolazione.value = m.dataImmatricolazione || "";
  form.dataAssegnazione.value = m.dataAssegnazione || "";
  form.categoriaCRI.value = m.categoriaCRI || "";
  form.classeVeicolo.value = m.classeVeicolo || "";
  form.alimentazione.value = m.alimentazione || "";
  form.anno.value = m.anno || "";
  form.statoMezzo.value = m.statoMezzo || "";
  form.telaio.value = m.telaio || "";
  form.dotazioni.value = m.dotazioni || "";
  form.note.value = m.note || "";

  if (role === "sol") {
    form.comitato.setAttribute('readonly', true);
  } else {
    form.comitato.removeAttribute('readonly');
  }

  toggleForm(true);
};

window.deleteMezzo = function(index) {
  const locali = JSON.parse(localStorage.getItem("mezzi") || "[]");
  const m = locali[index];
  if (!m) return;

  if (confirm(`üóëÔ∏è Sei sicuro di voler eliminare il mezzo:\n\nTarga: ${m.targa}\nTipo: ${m.tipoMezzo}\nSelettiva: ${m.selettivaRadio}\n\n‚ö†Ô∏è Questa azione √® irreversibile!`)) {
    locali.splice(index, 1);
    localStorage.setItem("mezzi", JSON.stringify(locali));
    renderMezzi();
    if (editIndex === index) {
      toggleForm(false);
      editIndex = null;
      submitBtn.textContent = "Aggiungi Mezzo";
    }
  }
};

window.showInfoPopupByIndex = function(index) {
  const locali = JSON.parse(localStorage.getItem("mezzi") || "[]");
  const m = locali[index];
  if (!m) return;
  showInfoPopup(m);
};

searchInput.addEventListener("input", renderMezzi);
renderMezzi();
</script>
</body>
</html>
